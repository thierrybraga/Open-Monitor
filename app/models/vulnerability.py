# models/vulnerability.py

import re
import logging
from datetime import datetime
from typing import Optional, Dict, Any

from sqlalchemy import Column, Integer, String, Text, DateTime, Float, Boolean, JSON
from sqlalchemy.orm import relationship, validates
from app.extensions import db
from app.models.base_model import BaseModel
from app.models.enums import severity_levels

logger = logging.getLogger(__name__)

class Vulnerability(db.Model):
    __tablename__ = 'vulnerabilities'
    __table_args__ = (
        # Índice composto útil para ordenação/filtragem por data e severidade
        db.Index('ix_vulnerabilities_published_base', 'published_date', 'base_severity'),
    )

    cve_id          = Column(String(50), primary_key=True, nullable=False, index=True)
    description     = Column(Text, nullable=False)
    published_date  = Column(DateTime, nullable=False, index=True)
    last_update     = Column(DateTime, nullable=False)
    base_severity   = Column(severity_levels, nullable=False, index=True)
    cvss_score      = Column(Float, nullable=False)
    patch_available = Column(Boolean, default=False, nullable=False)
    assigner        = Column(String(255), nullable=True)
    
    # Campos adicionais da API NVD 2.0
    source_identifier    = Column(String(255), nullable=True, index=True)  # Identificador da fonte do CVE
    vuln_status         = Column(String(50), nullable=True, index=True)    # Status da vulnerabilidade no NVD
    evaluator_comment   = Column(Text, nullable=True)                      # Comentário do avaliador
    evaluator_solution  = Column(Text, nullable=True)                      # Solução do avaliador
    evaluator_impact    = Column(Text, nullable=True)                      # Impacto avaliado
    
    # Campos CISA KEV (Known Exploited Vulnerabilities)
    cisa_exploit_add       = Column(DateTime, nullable=True, index=True)   # Data de adição ao catálogo CISA KEV
    cisa_action_due        = Column(DateTime, nullable=True, index=True)   # Data limite para ação CISA
    cisa_required_action   = Column(Text, nullable=True)                   # Ação requerida pelo CISA
    cisa_vulnerability_name = Column(String(500), nullable=True)           # Nome da vulnerabilidade no CISA
    
    # Dados diretos da API NVD (sem normalização)
    nvd_vendors_data       = Column(JSON, nullable=True)                   # Lista de vendors extraídos diretamente da API NVD
    nvd_products_data      = Column(JSON, nullable=True)                   # Lista de produtos extraídos diretamente da API NVD
    nvd_cpe_configurations = Column(JSON, nullable=True)                   # Configurações CPE completas da API NVD
    nvd_version_ranges     = Column(JSON, nullable=True)                   # Informações de versão extraídas das configurações CPE

    # Relacionamentos
    metrics            = relationship('CVSSMetric', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    severity_metrics   = relationship('SeverityMetric', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload', uselist=False)
    # vendors            = relationship('CVEVendor', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload') # REMOVIDO TEMPORARIAMENTE
    products           = relationship('CVEProduct', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    version_references = relationship('VersionReference', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    weaknesses         = relationship('Weakness', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    references         = relationship('Reference', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    affected_products  = relationship('AffectedProduct', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    assets             = relationship('AssetVulnerability', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    risk_assessments   = relationship('RiskAssessment', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')

    @validates('cve_id')
    def validate_cve_id(self, key: str, value: str) -> str:
        if not re.match(r'^CVE-\d{4}-\d{4,7}$', value):
            raise ValueError("Formato inválido: CVE-YYYY-NNNN")
        return value

    @validates('cvss_score')
    def validate_cvss_score(self, key: str, value: float) -> float:
        if value is not None and not 0.0 <= value <= 10.0:
            raise ValueError("CVSS score deve estar entre 0.0 e 10.0")
        return value

    @validates('last_update')
    def validate_dates(self, key: str, value: datetime) -> datetime:
        if self.published_date and value < self.published_date:
            raise ValueError("last_update deve ser >= published_date")
        return value

    def to_dict(self) -> Dict[str, Any]:
        """Serialização básica para JSON."""
        return {
            'cve_id'         : self.cve_id,
            'description'    : self.description,
            'published_date' : self.published_date.isoformat(),
            'last_update'    : self.last_update.isoformat(),
            'base_severity'  : self.base_severity,
            'cvss_score'     : self.cvss_score,
            'patch_available': self.patch_available,
            'assigner'       : self.assigner,
        }

    def __repr__(self) -> str:
        return f"<Vulnerability {self.cve_id}>"
