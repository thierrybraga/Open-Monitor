{% extends 'core/base.html' %}

{# Page Title - Uses context from the context processor if defined #}
{% block title %}{{ page_title if page_title else 'Cybersecurity News Feed' }} - {{ app_name }}{% endblock %}

{# Header Brand - Can be defined in the backend or template #}
{% block header_brand %}
  <span class="navbar-brand-text">{{ app_name }} - Cybersecurity News</span>
{% endblock %}

{# Additional CSS Links - main.css is already imported in base.html #}
{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/newsletter.css') }}">
{% endblock %}

{% block content %}
<main class="newsletter-page container-fluid">
  <header class="page-header mb-5">
    <div class="page-header-content text-center">
      <div class="page-title-section">
        <h1 class="page-title">
          <i class="bi bi-newspaper me-3"></i>
          {{ page_title if page_title else 'Cybersecurity News Feed' }}
        </h1>
        <p class="page-subtitle mx-auto">Acompanhe as principais notícias de cibersegurança em um feed unificado.</p>
        <div class="filters-summary mt-2">
          {% if q or tag or source %}
            {% if q %}
              <span class="badge bg-primary"><i class="bi bi-search me-1"></i> {{ q }}</span>
            {% endif %}
            {% if source %}
              <span class="badge bg-info text-dark"><i class="bi bi-bookmark me-1"></i> {{ source }}</span>
            {% endif %}
            {% if tag %}
              <span class="badge bg-secondary">#{{ tag }}</span>
            {% endif %}
          {% else %}
            <span class="badge bg-light text-dark border">Sem filtros ativos</span>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

  <div class="row g-4">
    <div class="col-lg-9">
      <form class="newsletter-filters mb-3" method="get" action="{{ url_for('main.newsletter') }}" role="search" aria-label="Filtrar notícias">
        <div class="row g-2 align-items-end">
          <div class="col-md-4">
            <label for="q" class="form-label small text-muted">Pesquisar</label>
            <input type="text" class="form-control" id="q" name="q" value="{{ q }}" placeholder="Buscar por título, resumo ou fonte">
          </div>
          <div class="col-md-3">
            <label for="source" class="form-label small text-muted">Fonte</label>
            <select id="source" name="source" class="form-select">
              <option value="">Todas</option>
              {% for s in all_sources %}
                <option value="{{ s }}" {% if s == source %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label for="sort" class="form-label small text-muted">Ordenar</label>
            <select id="sort" name="sort" class="form-select">
              <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Mais recentes</option>
              <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Mais antigas</option>
              <option value="relevance" {% if sort == 'relevance' %}selected{% endif %}>Mais relevantes</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="start" class="form-label small text-muted">Data inicial</label>
            <input type="datetime-local" class="form-control" id="start" name="start" value="{{ request.args.get('start','') }}">
          </div>
          <div class="col-md-3">
            <label for="end" class="form-label small text-muted">Data final</label>
            <input type="datetime-local" class="form-control" id="end" name="end" value="{{ request.args.get('end','') }}">
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-funnel me-1"></i> Aplicar
            </button>
          </div>
        </div>

        {% if all_tags %}
          <div class="mt-2 d-flex flex-wrap gap-2" aria-label="Filtrar por tags">
            {% for t in all_tags %}
              <a href="{{ url_for('main.newsletter', q=q, source=source, sort=sort, tag=t) }}" class="badge rounded-pill {% if t == tag %}bg-primary{% else %}bg-light text-dark border{% endif %}">
                #{{ t }}
              </a>
            {% endfor %}
          </div>
        {% endif %}

        {% if q or tag or source %}
          <div class="mt-2">
            <a href="{{ url_for('main.newsletter') }}" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-x-circle me-1"></i> Limpar filtros
            </a>
          </div>
        {% endif %}
      </form>
      <section class="newsletter-card" aria-labelledby="news-feed-heading">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="card-title mb-0" id="news-feed-heading">
            <i class="bi bi-lightning-charge me-2"></i> Últimas notícias
          </h2>
          <span class="text-muted small">{{ total_items }} itens no total{% if page and per_page %} • Página {{ page }} de {{ (total_items // per_page) + (1 if total_items % per_page else 0) }}{% endif %}</span>
        </div>
        <div class="card-body">
          {% if news_items %}
            <div class="list-group list-group-flush">
              {% for item in news_items %}
                <article class="list-group-item py-3">
                  <div class="d-flex align-items-start gap-3">
                    <div class="flex-grow-1">
                      <h3 class="h5 mb-1">
                        <a href="{{ item.link }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                          {{ item.title }}
                        </a>
                      </h3>
                      <p class="text-muted mb-2">{{ item.summary }}</p>

                      <div class="d-flex flex-wrap align-items-center gap-2">
                        <span class="badge bg-secondary">{{ item.source }}</span>
                        <span class="text-muted small">
                          <i class="bi bi-clock me-1"></i>
                          {{ item.published_at | datetimeformat('%d/%m/%Y %H:%M UTC') }}
                        </span>
                        {% for tag in item.tags %}
                          <span class="badge bg-light text-dark border">#{{ tag }}</span>
                        {% endfor %}
                      </div>
                    </div>
                    <div class="text-nowrap">
                      <a href="{{ item.link }}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-box-arrow-up-right me-1"></i> Ler mais
                      </a>
                    </div>
                  </div>
                </article>
              {% endfor %}
            </div>
            <nav class="mt-3" aria-label="Paginação">
              {% set total_pages = (total_items // per_page) + (1 if total_items % per_page else 0) %}
              {% if total_pages > 1 %}
                <ul class="pagination mb-0">
                  <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.newsletter', q=q, tag=tag, source=source, sort=sort, page=page-1, per_page=per_page) }}" aria-label="Anterior">&laquo;</a>
                  </li>
                  {% for p in range(1, total_pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                      <a class="page-link" href="{{ url_for('main.newsletter', q=q, tag=tag, source=source, sort=sort, page=p, per_page=per_page) }}">{{ p }}</a>
                    </li>
                  {% endfor %}
                  <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.newsletter', q=q, tag=tag, source=source, sort=sort, page=page+1, per_page=per_page) }}" aria-label="Próximo">&raquo;</a>
                  </li>
                </ul>
              {% endif %}
            </nav>
          {% else %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-inbox fs-2 d-block mb-2"></i>
              Nenhuma notícia disponível no momento.
              <div class="small mt-2">
                <span class="d-block">Dicas: verifique sua conexão com a Internet.</span>
                <span class="d-block">Confirme a dependência <code>cybernews</code> instalada e atualizada.</span>
                <span class="d-block">Você também pode verificar o JSON em <a href="{{ url_for('main.newsletter') }}?format=json" class="text-decoration-underline">/newsletter?format=json</a>.</span>
              </div>
              <div class="mt-3">
                <button type="button" class="btn btn-outline-primary" onclick="window.location.reload()">
                  Recarregar página
                </button>
                <a class="btn btn-outline-secondary ms-2" href="/health" target="_blank">Ver status do servidor</a>
              </div>
            </div>
          {% endif %}
        </div>
      </section>
    </div>

    <aside class="col-lg-3">
      <section class="newsletter-card" aria-labelledby="sources-heading">
        <div class="card-header">
          <h2 class="card-title mb-0" id="sources-heading">
            <i class="bi bi-bookmark-check me-2"></i> Fontes populares
          </h2>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            {% if all_sources %}
              {% for s in all_sources %}
                <li class="mb-2">
                  <a class="text-decoration-none" href="{{ url_for('main.newsletter', q=q, tag=tag, sort=sort, source=s) }}">
                    <i class="bi bi-link-45deg me-2"></i> {{ s }}
                  </a>
                </li>
              {% endfor %}
            {% else %}
              <li class="text-muted small">Sem fontes disponíveis.</li>
            {% endif %}
          </ul>
        </div>
      </section>
    </aside>
  </div>
</main>
{% endblock %}

{# Additional JavaScript scripts #}
{% block extra_js %}
  {# Third-party scripts (IMask, SweetAlert2) #}
  <script src="https://cdn.jsdelivr.net/npm/imask@7.6.1/dist/imask.min.js" defer nonce="{{ nonce }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js" defer nonce="{{ nonce }}"></script>

  {# Inline scripts (copyToClipboard, tooltips) - Can be moved to a utility JS file #}
  <script nonce="{{ nonce }}">
    // Simple copy to clipboard function
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        navigator.clipboard.writeText(element.innerText || element.textContent)
          .then(() => {
            const btn = element.nextElementSibling;
            const originalTitle = btn.getAttribute('data-bs-title') || 'Copy Email';
            // Check if the tooltip has already been initialized
            let tooltip = bootstrap.Tooltip.getInstance(btn);
            if (!tooltip) { // Initialize if it doesn't exist
                 tooltip = new bootstrap.Tooltip(btn);
            }
            btn.setAttribute('data-bs-title', 'Copied!');
            tooltip.show();
            setTimeout(() => {
              tooltip.hide();
              btn.setAttribute('data-bs-title', originalTitle);
            }, 1500);
          })
          .catch(err => {
            console.error('Failed to copy text: ', err);
            // Optionally show an error message
          });
      }
    }
  </script>

  {# Page-specific newsletter script - SHOULD CONTAIN FORM VALIDATION AND SUBMISSION LOGIC #}
  {# This file will need to be created or updated #}
  <script src="{{ url_for('static', filename='js/features/newsletter.js') }}" defer nonce="{{ nonce }}"></script>
{% endblock %}