{% extends 'core/base.html' %}

{# Page Title - Uses context from the context processor if defined #}
{% block title %}{{ page_title if page_title else 'Contact & Notifications' }} - {{ app_name }}{% endblock %}

{# Header Brand - Can be defined in the backend or template #}
{% block header_brand %}
  <span class="navbar-brand-text">{{ app_name }} - Contact & Notifications</span>
{% endblock %}

{# Additional CSS Links - main.css is already imported in base.html #}
{% block extra_css %}
  {# Removido: CSS de página já importado via main.css #}
{% endblock %}

{% block content %}
<main class="newsletter-page container-fluid">
  {# Page Header #}
  <header class="page-header mb-5">
    <div class="page-header-content text-center">
      <div class="page-title-section">
        <h1 class="page-title">
          <i class="bi bi-bell me-3"></i>
          {{ page_title if page_title else 'Contact & Notifications' }}
        </h1>
        <p class="page-subtitle mx-auto">Reach out to us and configure your notification preferences for cybersecurity updates.</p>
      </div>
    </div>
  </header>

  <div class="row g-4">
    {# Main Content Area #}
    <div class="col-lg-9">
      {# "About Open CVE Report" Section #}
      <section class="newsletter-card fade-in" aria-labelledby="about-cve-report-heading">
        <div class="card-header">
          <h2 class="card-title" id="about-cve-report-heading">
            <i class="bi bi-shield-check me-3"></i>
            About Open CVE Report
          </h2>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-lg-4">
              <div class="feature-item text-center p-3">
                <div class="feature-icon mb-3">
                  <i class="bi bi-database fs-1 text-primary" aria-hidden="true"></i>
                </div>
                <h3 class="h5 fw-semibold mb-3">Data Source</h3>
                <p class="text-muted">Leverages public CVE data (e.g., NVD) via API, stored locally for reports and insights.</p>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="feature-item text-center p-3">
                <div class="feature-icon mb-3">
                  <i class="bi bi-arrow-repeat fs-1 text-primary" aria-hidden="true"></i>
                </div>
                <h3 class="h5 fw-semibold mb-3">Auto Updates</h3>
                <p class="text-muted">Stays current with the latest CVEs for reliable and accurate data (update frequency configurable).</p>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="feature-item text-center p-3">
                <div class="feature-icon mb-3">
                  <i class="bi bi-file-earmark-text fs-1 text-primary" aria-hidden="true"></i>
                </div>
                <h3 class="h5 fw-semibold mb-3">AI Reports</h3>
                <p class="text-muted">Generates technical reports using AI (e.g., OpenAI) in Markdown, converted to professional PDFs.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      {# Contact Information Section #}
      <section class="newsletter-card contact-section" aria-labelledby="get-in-touch-heading">
        <div class="card-header">
          <h2 class="card-title" id="get-in-touch-heading">
            <i class="bi bi-person-lines-fill me-3"></i>
            Get in Touch
          </h2>
        </div>
        <div class="card-body">
          <div class="row g-4">
            {# Email Item #}
            <div class="col-lg-4">
              <div class="contact-item h-100">
                <div class="text-center mb-3">
                  <i class="bi bi-envelope fs-2 text-primary mb-2" aria-hidden="true"></i>
                  <h6 class="fw-semibold mb-1">Contact Us</h6>
                  <p class="text-muted small mb-0">Email</p>
                </div>
                <div class="text-center">
                  <a href="mailto:contact@opencvereport.com" id="contact-email" class="contact-link fw-medium d-block mb-3">contact@opencvereport.com</a>
                  <button class="btn btn-sm btn-outline-primary" type="button" onclick="copyToClipboard('contact-email')" aria-label="Copy email" data-bs-toggle="tooltip" data-bs-title="Copy Email">
                    <i class="bi bi-copy me-1" aria-hidden="true"></i>
                    Copy Email
                  </button>
                </div>
              </div>
            </div>
            {# GitHub Item #}
            <div class="col-lg-4">
              <div class="contact-item h-100">
                <div class="text-center mb-3">
                  <i class="bi bi-github fs-2 text-primary mb-2" aria-hidden="true"></i>
                  <h6 class="fw-semibold mb-1">Source Code</h6>
                  <p class="text-muted small mb-0">GitHub</p>
                </div>
                <div class="text-center">
                  <a href="https://github.com/opencvereport" target="_blank" rel="noopener noreferrer" class="contact-link fw-medium d-block mb-3">github.com/opencvereport</a>
                  <a href="https://github.com/opencvereport" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right me-1" aria-hidden="true"></i>
                    Visit Repository
                  </a>
                </div>
              </div>
            </div>
            {# LinkedIn Item #}
            <div class="col-lg-4">
              <div class="contact-item h-100">
                <div class="text-center mb-3">
                  <i class="bi bi-linkedin fs-2 text-primary mb-2" aria-hidden="true"></i>
                  <h6 class="fw-semibold mb-1">Professional</h6>
                  <p class="text-muted small mb-0">LinkedIn</p>
                </div>
                <div class="text-center">
                  <a href="https://linkedin.com/company/opencvereport" target="_blank" rel="noopener noreferrer" class="contact-link fw-medium d-block mb-3">linkedin.com/company/opencvereport</a>
                  <a href="https://linkedin.com/company/opencvereport" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right me-1" aria-hidden="true"></i>
                    Follow Us
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {# Notification Settings Section #}
      <section class="newsletter-card" aria-labelledby="notification-settings-heading">
        <div class="card-header text-center">
          <h2 class="card-title mb-0" id="notification-settings-heading">
            <i class="bi bi-gear me-2 fs-4"></i>
            Notification Settings
          </h2>
        </div>
        <div class="card-body p-4">
          <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
            <i class="bi bi-info-circle me-3 fs-5"></i>
            <div>
              <strong>Configure your preferences:</strong> Choose how you want to receive cybersecurity updates. Some methods require additional setup.
            </div>
          </div>

          <form id="notification-form" method="POST" action="{{ url_for('main.newsletter') }}" novalidate>
            {{ form.hidden_tag() }}

            <div class="row g-4">
              {# Email Method #}
              <div class="col-md-6">
                <div class="notification-method mb-4 {% if user_preferences and user_preferences.email_enabled %}enabled{% endif %}" data-method="email">
                  <div class="row align-items-center mb-3">
                    <div class="col-lg-8">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-envelope-fill fs-3 text-primary me-3" aria-hidden="true"></i>
                        <div>
                          <h6 class="mb-1 fw-semibold">Email Notifications</h6>
                          <small class="text-muted">Receive reports directly in your inbox</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4 text-end">
                      <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input" type="checkbox" role="switch" id="emailToggle" name="email_enabled" {% if user_preferences and user_preferences.email_enabled %}checked{% endif %} aria-describedby="emailToggleHelp">
                        <label class="form-check-label visually-hidden" for="emailToggle">Enable email notifications</label>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="row">
                      <div class="col-lg-8">
                        <label for="email" class="form-label required mb-2">
                          <i class="bi bi-at me-1"></i>
                          Email Address
                        </label>
                        {{ form.email(class="form-control form-control-lg", placeholder="your.email@example.com", id="email") }}
                        <div class="form-text mt-2">We'll never share your email with anyone else.</div>
                        <div class="invalid-feedback" id="email-feedback">Please provide a valid email address.</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {# Telegram Method #}
              <div class="col-md-6">
                <div class="notification-method disabled mb-4 {% if user_preferences and user_preferences.telegram_enabled %}enabled{% endif %}" data-method="telegram">
                  <div class="row align-items-center mb-3">
                    <div class="col-lg-6">
                      <div class="d-flex align-items-center">
                        <i class="bi bi-telegram fs-3 text-info me-3" aria-hidden="true"></i>
                        <div>
                          <h6 class="mb-1 fw-semibold">Telegram Notifications</h6>
                          <small class="text-muted">Instant messaging alerts</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-6 text-end">
                      <div class="d-flex align-items-center justify-content-end">
                        <span class="badge bg-warning text-dark me-3">Coming Soon</span>
                        <div class="form-check form-switch d-inline-block">
                          <input class="form-check-input" type="checkbox" role="switch" id="telegramToggle" name="telegram_enabled" disabled aria-describedby="telegramToggleHelp">
                          <label class="form-check-label visually-hidden" for="telegramToggle">Enable Telegram notifications (coming soon)</label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="telegram" class="form-label">
                      <i class="bi bi-person-badge me-1"></i>
                      Telegram Handle
                    </label>
                    <input type="text" id="telegram" name="telegram" class="form-control" placeholder="@YourTelegram" disabled value="{{ user_preferences.telegram_handle if user_preferences else '' }}">
                    <div class="invalid-feedback" id="telegram-feedback"></div>
                  </div>
                </div>
              </div>

              {# WhatsApp Method #}
              <div class="col-md-6">
                <div class="notification-method disabled">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-whatsapp fs-4 text-success me-3"></i>
                      <div>
                        <h6 class="mb-0">WhatsApp</h6>
                        <small class="text-muted">Mobile messaging</small>
                      </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="badge coming-soon">Coming Soon</span>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="whatsappToggle" name="whatsappToggle" disabled>
                        <label class="form-check-label" for="whatsappToggle"></label>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="whatsapp" class="form-label">
                      <i class="bi bi-phone me-1"></i>
                      WhatsApp Number
                    </label>
                    <input type="tel" id="whatsapp" name="whatsapp" class="form-control" placeholder="+1 (555) 123-4567" disabled value="{{ user_preferences.whatsapp_number if user_preferences else '' }}">
                    <div class="invalid-feedback" id="whatsapp-feedback"></div>
                  </div>
                </div>
              </div>

              {# Phone Method #}
              <div class="col-md-6">
                <div class="notification-method disabled">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-telephone-fill fs-4 text-warning me-3"></i>
                      <div>
                        <h6 class="mb-0">Voice Call</h6>
                        <small class="text-muted">Emergency alerts</small>
                      </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="badge coming-soon">Coming Soon</span>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="phoneToggle" name="phoneToggle" disabled>
                        <label class="form-check-label" for="phoneToggle"></label>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="phone" class="form-label">
                      <i class="bi bi-telephone me-1"></i>
                      Phone Number
                    </label>
                    <input type="tel" id="phone" name="phone" class="form-control" placeholder="+1 (555) 123-4567" disabled value="{{ user_preferences.phone_number if user_preferences else '' }}">
                    <div class="invalid-feedback" id="phone-feedback"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-actions mt-5">
              <div class="row">
                <div class="col-12">
                  <div class="d-flex flex-column flex-md-row gap-3 justify-content-center align-items-center">
                    <button type="submit" class="btn btn-primary btn-lg px-4" id="submit-btn">
                      <i class="bi bi-envelope-plus me-2"></i>
                      <span class="btn-text">Subscribe to Newsletter</span>
                      <span class="btn-loading d-none">
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Saving...
                      </span>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg px-4" id="reset-btn">
                      <i class="bi bi-arrow-clockwise me-2"></i>
                      Reset
                    </button>
                    <a href="{{ url_for('main.newsletter_unsubscribe') }}" class="btn btn-outline-warning btn-lg px-4">
                      <i class="bi bi-envelope-x me-2"></i>
                      Unsubscribe
                    </a>
                  </div>
                  <div class="text-center mt-3">
                    <span id="success-message" class="text-success fw-medium d-none" aria-live="polite">
                      <i class="bi bi-check-circle-fill me-1"></i>
                      Newsletter subscription successful!
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </form>

          {# Saved Preferences Display Section - Visibility controlled by JS based on backend data #}
          {# Current Settings Summary #}
          {% if user_preferences %}
          <div id="saved-preferences" class="notification-card mt-4" aria-labelledby="current-settings-heading">
            <div class="card-header">
              <h3 class="card-title" id="current-settings-heading">
                <i class="bi bi-check-circle me-2"></i>
                Current Settings
              </h3>
            </div>
            <div class="card-body">
              <div class="preferences-summary">
                {% if user_preferences.email %}
                <div class="preference-item">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-envelope-fill text-primary me-3"></i>
                      <div>
                        <h6 class="mb-0">Email</h6>
                        <small class="text-muted">{{ user_preferences.email }}</small>
                      </div>
                    </div>
                    <div class="status-badge">
                      {% if user_preferences.email_enabled %}
                      <span class="badge status-enabled">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Active
                      </span>
                      {% else %}
                      <span class="badge status-disabled">
                        <i class="bi bi-x-circle-fill me-1"></i>
                        Inactive
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}

                {% if user_preferences.telegram_handle %}
                <div class="preference-item">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-telegram text-info me-3"></i>
                      <div>
                        <h6 class="mb-0">Telegram</h6>
                        <small class="text-muted">{{ user_preferences.telegram_handle }}</small>
                      </div>
                    </div>
                    <div class="status-badge">
                      {% if user_preferences.telegram_enabled %}
                      <span class="badge status-enabled">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Active
                      </span>
                      {% else %}
                      <span class="badge status-disabled">
                        <i class="bi bi-x-circle-fill me-1"></i>
                        Inactive
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}

                {% if user_preferences.whatsapp_number %}
                <div class="preference-item">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-whatsapp text-success me-3"></i>
                      <div>
                        <h6 class="mb-0">WhatsApp</h6>
                        <small class="text-muted">{{ user_preferences.whatsapp_number }}</small>
                      </div>
                    </div>
                    <div class="status-badge">
                      {% if user_preferences.whatsapp_enabled %}
                      <span class="badge status-enabled">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Active
                      </span>
                      {% else %}
                      <span class="badge status-disabled">
                        <i class="bi bi-x-circle-fill me-1"></i>
                        Inactive
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}

                {% if user_preferences.phone_number %}
                <div class="preference-item">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-telephone-fill text-warning me-3"></i>
                      <div>
                        <h6 class="mb-0">Phone</h6>
                        <small class="text-muted">{{ user_preferences.phone_number }}</small>
                      </div>
                    </div>
                    <div class="status-badge">
                      {% if user_preferences.phone_enabled %}
                      <span class="badge status-enabled">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Active
                      </span>
                      {% else %}
                      <span class="badge status-disabled">
                        <i class="bi bi-x-circle-fill me-1"></i>
                        Inactive
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </section>
    </div>

    {# Sidebar Actions #}
    <aside class="col-lg-3">
      <section class="newsletter-card quick-actions-card" aria-labelledby="quick-actions-heading">
        <div class="card-header text-center">
          <h2 class="card-title mb-0" id="quick-actions-heading">
            <i class="bi bi-lightning-fill me-2 fs-4"></i>
            Quick Actions
          </h2>
        </div>
        <div class="card-body p-4">
          <div class="d-flex flex-column gap-3">
            <a href="{{ url_for('main.support') if 'support' in request.endpoints else '/support' }}" class="btn btn-primary btn-lg w-100" aria-label="Contact support">
              <i class="bi bi-headset me-2"></i>
              Contact Support
            </a>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-lg w-100" aria-label="Go to dashboard">
              <i class="bi bi-speedometer2 me-2"></i>
              Back to Dashboard
            </a>
            <hr class="my-3">
            <div class="help-section">
              <h6 class="text-muted mb-2">
                <i class="bi bi-question-circle-fill me-1 fs-5"></i>
                Need Help?
              </h6>
              <p class="small text-muted mb-4">Configure your notification preferences to stay updated on security threats and system alerts.</p>
              <div class="d-grid gap-2">
                <a href="#" class="btn btn-outline-info btn-sm w-100">
                  <i class="bi bi-book me-1"></i>
                  View Documentation
                </a>
                <a href="#" class="btn btn-outline-info btn-sm w-100">
                  <i class="bi bi-chat-dots me-1"></i>
                  FAQ
                </a>
              </div>
            </div>
          </div>
        </div>
      </section>
    </aside>
  </div>
</main>
{% endblock %}

{# Additional JavaScript scripts #}
{% block extra_js %}
  {# Third-party scripts (IMask, SweetAlert2) #}
  <script src="https://cdn.jsdelivr.net/npm/imask@7.6.1/dist/imask.min.js" defer nonce="{{ nonce }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js" defer nonce="{{ nonce }}"></script>

  {# Inline scripts (copyToClipboard, tooltips) - Can be moved to a utility JS file #}
  <script nonce="{{ nonce }}">
    // Simple copy to clipboard function
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        navigator.clipboard.writeText(element.innerText || element.textContent)
          .then(() => {
            const btn = element.nextElementSibling;
            const originalTitle = btn.getAttribute('data-bs-title') || 'Copy Email';
            // Check if the tooltip has already been initialized
            let tooltip = bootstrap.Tooltip.getInstance(btn);
            if (!tooltip) { // Initialize if it doesn't exist
                 tooltip = new bootstrap.Tooltip(btn);
            }
            btn.setAttribute('data-bs-title', 'Copied!');
            tooltip.show();
            setTimeout(() => {
              tooltip.hide();
              btn.setAttribute('data-bs-title', originalTitle);
            }, 1500);
          })
          .catch(err => {
            console.error('Failed to copy text: ', err);
            // Optionally show an error message
          });
      }
    }
  </script>

  {# Page-specific newsletter script - SHOULD CONTAIN FORM VALIDATION AND SUBMISSION LOGIC #}
  {# This file will need to be created or updated #}
  <script src="{{ url_for('static', filename='js/features/newsletter.js') }}" defer nonce="{{ nonce }}"></script>
{% endblock %}