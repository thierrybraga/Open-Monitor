{% extends "core/base.html" %}

{% block title %}Newsletter Admin - Enviar Newsletter{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-paper-plane me-2"></i>
                Enviar Newsletter
            </h1>
            <p class="text-muted mb-0">Crie e envie uma newsletter para seus assinantes</p>
        </div>
        <div class="btn-group" role="group">
            <a href="{{ url_for('newsletter_admin.admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar ao Dashboard
            </a>
        </div>
    </div>

    <!-- Newsletter Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Compor Newsletter
                    </h5>
                </div>
                
                <div class="card-body">
                    <form method="POST" id="newsletterForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Subject -->
                        <div class="mb-4">
                            <label for="subject" class="form-label fw-semibold">
                                <i class="fas fa-heading me-2"></i>
                                Assunto *
                            </label>
                            {{ form.subject(class="form-control form-control-lg", placeholder="Digite o assunto da newsletter...") }}
                            {% if form.subject.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.subject.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Content -->
                        <div class="mb-4">
                            <label for="content" class="form-label fw-semibold">
                                <i class="fas fa-align-left me-2"></i>
                                Conteúdo *
                            </label>
                            {{ form.content(class="form-control", rows="12", placeholder="Digite o conteúdo da newsletter...\n\nVocê pode usar HTML básico para formatação:
- <strong>texto em negrito</strong>
- <em>texto em itálico</em>
- <a href='#'>links</a>
- <br> para quebras de linha") }}
                            {% if form.content.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.content.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Você pode usar HTML básico para formatação. O conteúdo será automaticamente estilizado.
                            </div>
                        </div>
                        
                        <!-- Send Options -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-cog me-2"></i>
                                Opções de Envio
                            </label>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.send_test(class="form-check-input") }}
                                        <label class="form-check-label" for="send_test">
                                            <i class="fas fa-flask me-1"></i>
                                            Enviar apenas teste
                                        </label>
                                        <div class="form-text small">
                                            Envia apenas para o email do administrador
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-check">
                                        {{ form.include_unsubscribe(class="form-check-input", checked=True) }}
                                        <label class="form-check-label" for="include_unsubscribe">
                                            <i class="fas fa-link me-1"></i>
                                            Incluir link de descadastro
                                        </label>
                                        <div class="form-text small">
                                            Recomendado para conformidade
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Test Email (shown when send_test is checked) -->
                        <div class="mb-4" id="testEmailDiv" style="display: none;">
                            <label for="test_email" class="form-label fw-semibold">
                                <i class="fas fa-envelope me-2"></i>
                                Email para Teste
                            </label>
                            {{ form.test_email(class="form-control", placeholder="admin@exemplo.com") }}
                            {% if form.test_email.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.test_email.errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="sendBtn">
                                <i class="fas fa-paper-plane me-2"></i>
                                <span id="sendBtnText">Enviar Newsletter</span>
                            </button>
                            
                            <button type="button" class="btn btn-outline-secondary" onclick="previewNewsletter()">
                                <i class="fas fa-eye me-2"></i>
                                Visualizar
                            </button>
                            
                            <button type="button" class="btn btn-outline-danger" onclick="clearForm()">
                                <i class="fas fa-trash me-2"></i>
                                Limpar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Statistics -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Estatísticas de Envio
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="h4 text-success mb-1">{{ active_subscribers }}</div>
                                <div class="small text-muted">Assinantes Ativos</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="h4 text-primary mb-1">{{ total_subscribers }}</div>
                            <div class="small text-muted">Total de Assinantes</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tips -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Dicas para Newsletter
                    </h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        <div class="mb-3">
                            <strong><i class="fas fa-check text-success me-1"></i> Assunto Atrativo:</strong>
                            <div class="text-muted">Use assuntos claros e chamativos (máx. 50 caracteres)</div>
                        </div>
                        
                        <div class="mb-3">
                            <strong><i class="fas fa-check text-success me-1"></i> Conteúdo Relevante:</strong>
                            <div class="text-muted">Foque em informações úteis e atualizadas</div>
                        </div>
                        
                        <div class="mb-3">
                            <strong><i class="fas fa-check text-success me-1"></i> Call-to-Action:</strong>
                            <div class="text-muted">Inclua links e ações claras para o leitor</div>
                        </div>
                        
                        <div class="mb-0">
                            <strong><i class="fas fa-check text-success me-1"></i> Teste Primeiro:</strong>
                            <div class="text-muted">Sempre envie um teste antes do envio final</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Newsletters -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>
                        Últimas Newsletters
                    </h6>
                </div>
                <div class="card-body">
                    <div class="small text-muted text-center py-3">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        Histórico de newsletters aparecerá aqui
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye me-2"></i>
                    Visualização da Newsletter
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="border rounded p-3" style="background-color: #f8f9fa;">
                    <div class="mb-3">
                        <strong>Assunto:</strong> <span id="previewSubject"></span>
                    </div>
                    <hr>
                    <div id="previewContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="sendNewsletterFromPreview()">
                    <i class="fas fa-paper-plane me-2"></i>
                    Enviar Newsletter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    {% for category, message in messages %}
    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            {% if category == 'success' %}
            <i class="fas fa-check-circle text-success me-2"></i>
            <strong class="me-auto">Sucesso</strong>
            {% elif category == 'error' %}
            <i class="fas fa-exclamation-circle text-danger me-2"></i>
            <strong class="me-auto">Erro</strong>
            {% else %}
            <i class="fas fa-info-circle text-info me-2"></i>
            <strong class="me-auto">Informação</strong>
            {% endif %}
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            {{ message }}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<style>
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.card {
    transition: all 0.3s ease;
}

.btn {
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

#previewContent {
    min-height: 200px;
    line-height: 1.6;
}

.toast {
    min-width: 300px;
}
</style>

<script nonce="{{ nonce }}">
// Hide preview modal and trigger form submission without jQuery
function sendNewsletterFromPreview() {
    const modalEl = document.getElementById('previewModal');
    try {
        if (window.bootstrap && typeof bootstrap.Modal !== 'undefined') {
    const instance = window.getModalInstance(modalEl);
            instance.hide();
        } else {
            // Fallback: toggle classes if Bootstrap is not available
            modalEl.classList.remove('show');
            modalEl.style.display = 'none';
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
        }
    } catch (e) {
        console.warn('Falha ao fechar o modal de preview:', e);
    }

    // Trigger submit button click
    const sendBtn = document.getElementById('sendBtn');
    if (sendBtn) {
        sendBtn.click();
    }
}

// Toggle test email field
document.getElementById('send_test').addEventListener('change', function() {
    const testEmailDiv = document.getElementById('testEmailDiv');
    const sendBtnText = document.getElementById('sendBtnText');
    
    if (this.checked) {
        testEmailDiv.style.display = 'block';
        sendBtnText.textContent = 'Enviar Teste';
    } else {
        testEmailDiv.style.display = 'none';
        sendBtnText.textContent = 'Enviar Newsletter';
    }
});

// Preview newsletter
function previewNewsletter() {
    const subject = document.getElementById('subject').value;
    const content = document.getElementById('content').value;
    
    if (!subject || !content) {
        alert('Por favor, preencha o assunto e o conteúdo antes de visualizar.');
        return;
    }
    
    document.getElementById('previewSubject').textContent = subject;
    document.getElementById('previewContent').innerHTML = content;
    
    const modal = window.getModalInstance(document.getElementById('previewModal'));
    modal.show();
}

// Clear form
function clearForm() {
    if (confirm('Tem certeza que deseja limpar todos os campos?')) {
        document.getElementById('newsletterForm').reset();
        document.getElementById('testEmailDiv').style.display = 'none';
        document.getElementById('sendBtnText').textContent = 'Enviar Newsletter';
    }
}

// Form submission with loading state
document.getElementById('newsletterForm').addEventListener('submit', function() {
    const sendBtn = document.getElementById('sendBtn');
    const originalText = sendBtn.innerHTML;
    
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
    
    // Re-enable button after 10 seconds (in case of error)
    setTimeout(function() {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
    }, 10000);
});

// Auto-hide toasts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const toasts = document.querySelectorAll('.toast');
    toasts.forEach(function(toast) {
        setTimeout(function() {
  const bsToast = window.getToastInstance(toast);
            bsToast.hide();
        }, 5000);
    });
});
</script>
{% endblock %}
