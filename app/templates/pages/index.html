{% extends 'core/base.html' %}
{% block title %}Início{% endblock %}
{% block meta_description %}Painel inicial com resumo e vulnerabilidades recentes.{% endblock %}

{% block content %}
<section class="container py-4">
  <header class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
    <div>
      <h1 class="h3 mb-1"><i class="bi bi-house me-2"></i>Início</h1>
      <p class="text-muted small">Resumo do ambiente e últimas vulnerabilidades</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.analytics') }}">
        <i class="bi bi-bar-chart me-1"></i>Analytics
      </a>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}">
        <i class="bi bi-shield"></i>Vulnerabilidades
      </a>
    </div>
  </header>

  {% if sync_in_progress %}
  <div class="alert alert-warning d-flex align-items-center" role="alert">
    <i class="bi bi-arrow-repeat me-2"></i>
    <div>
      Base da NVD sincronizando. Os valores serão exibidos após a conclusão.
      {% if current_user.is_authenticated and current_user.is_admin %}
      <div class="mt-2">
        <div class="progress" style="height: 8px;">
          <div id="sync-progress-bar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="small text-muted mt-1" id="sync-progress-text">CVE 0/0</div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
      <h2 class="h6 mb-0">Ações Rápidas</h2>
    </div>
    <div class="card-body p-3">
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-sm btn-primary" href="{{ url_for('report.quick_create_report') }}">
          <i class="bi bi-flash me-1"></i>Gerar Relatório Rápido
        </a>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('report.create_report') }}">
          <i class="bi bi-file-earmark-plus me-1"></i>Relatório Técnico
        </a>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('vulnerability_ui.vendor_selection_ui') }}">
          <i class="bi bi-filter me-1"></i>Selecionar Vendors
        </a>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}">
          <i class="bi bi-shield me-1"></i>Abrir Vulnerabilidades
        </a>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.analytics') }}">
          <i class="bi bi-bar-chart me-1"></i>Analytics
        </a>
      </div>
    </div>
  </div>

  {% if selected_vendor_map and selected_vendor_map|length > 0 %}
  <div class="mb-3">
    <span class="text-muted small me-2">Escopo de vendors selecionado:</span>
    {% for v in selected_vendor_map %}
      <span class="badge bg-primary me-1"><i class="bi bi-building me-1"></i>{{ v.name }}</span>
    {% endfor %}
  </div>
  {% endif %}

  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <a class="card h-100 text-decoration-none" href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}{% if selected_vendor_ids %}?vendor_ids={{ selected_vendor_ids | join(',') }}{% endif %}">
        <div class="card-body">
          <div class="small text-muted">Total</div>
          <div id="count-total" class="fs-4 fw-semibold text-primary">{{ total_count }}</div>
        </div>
      </a>
    </div>
    <div class="col-6 col-md-3">
      <a class="card h-100 text-decoration-none" href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}?severity=CRITICAL{% if selected_vendor_ids %}&vendor_ids={{ selected_vendor_ids | join(',') }}{% endif %}">
        <div class="card-body">
          <div class="small text-muted">Crítico</div>
          <div id="count-critical" class="fs-4 fw-semibold text-danger">{{ critical_count }}</div>
        </div>
      </a>
    </div>
    <div class="col-6 col-md-3">
      <a class="card h-100 text-decoration-none" href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}?severity=HIGH{% if selected_vendor_ids %}&vendor_ids={{ selected_vendor_ids | join(',') }}{% endif %}">
        <div class="card-body">
          <div class="small text-muted">Alto</div>
          <div id="count-high" class="fs-4 fw-semibold text-warning">{{ high_count }}</div>
        </div>
      </a>
    </div>
    <div class="col-6 col-md-3">
      <a class="card h-100 text-decoration-none" href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}?severity=MEDIUM{% if selected_vendor_ids %}&vendor_ids={{ selected_vendor_ids | join(',') }}{% endif %}">
        <div class="card-body">
          <div class="small text-muted">Médio</div>
          <div id="count-medium" class="fs-4 fw-semibold text-success">{{ medium_count }}</div>
        </div>
      </a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
      <h2 class="h6 mb-0">Atividade semanal</h2>
      <small class="text-muted">Últimos 7 dias</small>
    </div>
    <div class="card-body p-3">
      <div class="row g-3">
        <div class="col-6 col-md-3">
          <div class="small text-muted">Total</div>
          <div id="weekly-total" class="fw-semibold">{{ weekly_total }}</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="small text-muted">Crítico</div>
          <div id="weekly-critical" class="fw-semibold text-danger">{{ weekly_critical }}</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="small text-muted">Alto</div>
          <div id="weekly-high" class="fw-semibold text-warning">{{ weekly_high }}</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="small text-muted">Médio</div>
          <div id="weekly-medium" class="fw-semibold text-success">{{ weekly_medium }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
      <h2 class="h6 mb-0">Vulnerabilidades recentes</h2>
      <div class="text-muted small">Página {{ page }} de {{ total_pages }}</div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>CVE/Título</th>
              <th>Severidade</th>
              <th>CVSS</th>
              <th>Publicado</th>
              <th>Detalhes</th>
            </tr>
          </thead>
          <tbody id="recent-vulns-body">
            {% for v in vulnerabilities %}
            <tr>
              <td>
                <a href="{{ url_for('vulnerability_ui.vulnerability_details', cve_id=v.cve_id) }}">{{ v.cve_id }}</a>
                <div class="text-muted small">{{ (v.summary or v.description or '')[:90] }}{% if (v.summary or v.description or '')|length > 90 %}...{% endif %}</div>
              </td>
              <td>
                {% set sev = (v.base_severity or 'LOW')|lower %}
                <span class="badge bg-{{ 'danger' if sev=='critical' else 'warning' if sev=='high' else 'info' if sev=='medium' else 'success' }}">{{ (v.base_severity or 'LOW') }}</span>
              </td>
              <td>{{ v.cvss_score or '-' }}</td>
              <td>{{ v.published_date.strftime('%d/%m/%Y') if v.published_date else '-' }}</td>
              <td>
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('vulnerability_ui.vulnerability_details', cve_id=v.cve_id) }}">
                  <i class="bi bi-box-arrow-up-right"></i> Ver detalhes
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center">
      <div>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.index', page=page-1, per_page=per_page) }}" {% if page <= 1 %}aria-disabled="true" class="disabled"{% endif %}>
          <i class="bi bi-chevron-left"></i> Anterior
        </a>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.index', page=page+1, per_page=per_page) }}" {% if page >= total_pages %}aria-disabled="true" class="disabled"{% endif %}>
          Próxima <i class="bi bi-chevron-right"></i>
        </a>
      </div>
      <div class="d-flex align-items-center gap-2">
        <label for="per-page" class="form-label small mb-0">Itens por página</label>
        <select id="per-page" class="form-select form-select-sm" onchange="location.href='{{ url_for('main.index') }}?page=1&per_page='+this.value">
          <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
          <option value="20" {% if per_page==20 %}selected{% endif %}>20</option>
          <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
        </select>
      </div>
    </div>
  </div>
  
</section>
{% if sync_in_progress %}
<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', function(){
  var isAdmin = {{ 'true' if current_user.is_authenticated and current_user.is_admin else 'false' }};
  if(!isAdmin){
    try { setTimeout(function(){ window.location.href='/loading'; }, 500); } catch(_) {}
  }
  var __syncMaxPct = 0, __syncMaxCur = 0, __syncMaxTot = 0, __syncMaxSaved = 0;
  function updateAdminProgress(){
    try {
      var getProg = (typeof window.getSyncProgress==='function') ? window.getSyncProgress() : (fetch('/api/v1/sync/progress').then(function(r){return r.json()}).then(function(j){ return (typeof window.normalizeSyncProgressPayload==='function'? window.normalizeSyncProgressPayload(j) : j); }));
      getProg.then(function(prog){
        var bar=document.getElementById('sync-progress-bar');
        var txt=document.getElementById('sync-progress-text');
        var cur=(typeof prog.current==='number')? prog.current : null;
        var tot=(typeof prog.total==='number')? prog.total : null;
        var pct=(typeof prog.percentage==='number')? prog.percentage : null;
        var status = prog && prog.status ? String(prog.status).toLowerCase() : null;
        var savingCount = (typeof prog.saving_count==='number') ? prog.saving_count : null;
        var savedCount = (savingCount && savingCount>0) ? savingCount : (typeof cur==='number' ? cur : null);
        if (typeof pct==='number') { if (pct < __syncMaxPct) { pct = __syncMaxPct; } else { __syncMaxPct = pct; } } else { pct = __syncMaxPct; }
        if (typeof cur==='number') { if (cur < __syncMaxCur) { cur = __syncMaxCur; } else { __syncMaxCur = cur; } } else { cur = __syncMaxCur; }
        if (typeof tot==='number') { if (tot < __syncMaxTot) { tot = __syncMaxTot; } else { __syncMaxTot = tot; } } else { tot = __syncMaxTot; }
        if (savedCount !== null) { if (savedCount < __syncMaxSaved) { savedCount = __syncMaxSaved; } else { __syncMaxSaved = savedCount; } } else { savedCount = __syncMaxSaved || null; }
        var label = (status==='saving')? 'Gravando' : ((status==='processing')? 'Processando' : 'Sincronização');
        var pctText = (typeof pct==='number' ? Number(pct).toFixed(2) : '0');
        if(bar){
          var p=(pct||0);
          bar.style.width=p+'%';
          bar.setAttribute('aria-valuenow', p);
          try { bar.classList.remove('bg-primary','bg-info','bg-warning','bg-danger','bg-success'); bar.classList.add(status==='saving'?'bg-warning':'bg-success'); } catch(_){}
        }
        if(txt){ txt.textContent=label+': '+pctText+'% · CVE '+cur+'/'+(tot||0)+(prog && prog.last_cve_id ? ' ('+prog.last_cve_id+')' : '') + (savedCount!==null ? ' · Gravados: '+savedCount : ''); }
      }).catch(function(){});
    } catch(_) {}
  }
  function renderOverview(data){
    try {
      var counts=data.counts||{};
      var weekly=data.weekly||{};
      var vulns=data.vulnerabilities||[];
      var setText=function(id,val){var el=document.getElementById(id); if(el){el.textContent=(val||0);} };
      setText('count-total', counts.total);
      setText('count-critical', counts.critical);
      setText('count-high', counts.high);
      setText('count-medium', counts.medium);
      setText('weekly-total', weekly.total);
      setText('weekly-critical', weekly.critical);
      setText('weekly-high', weekly.high);
      setText('weekly-medium', weekly.medium);
      var tbody=document.getElementById('recent-vulns-body');
      if(tbody){
        var html='';
        for(var i=0;i<vulns.length;i++){
          var v=vulns[i];
          var sev=(v.base_severity||'LOW').toLowerCase();
          var sevClass=(sev==='critical'?'danger':(sev==='high'?'warning':(sev==='medium'?'info':'success')));
          var summary=((v.summary||v.description||'')||'');
          var short=summary.substring(0,90)+(summary.length>90?'...':'');
          html+=
            '<tr>'+
            '<td><a href="'+(v.details_url||('#'))+'">'+(v.cve_id||'-')+'</a>'+
            '<div class="text-muted small">'+short+'</div></td>'+
            '<td><span class="badge bg-'+sevClass+'">'+(v.base_severity||'LOW')+'</span></td>'+
            '<td>'+(v.cvss_score!=null?v.cvss_score:'-')+'</td>'+
            '<td>'+(v.published_date?new Date(v.published_date).toLocaleDateString(): '-')+'</td>'+
            '<td><a class="btn btn-sm btn-outline-primary" href="'+(v.details_url||('#'))+'"><i class="bi bi-box-arrow-up-right"></i> Ver detalhes</a></td>'+
            '</tr>';
        }
        tbody.innerHTML=html;
      }
    } catch(_) {}
  }
  function pollOverview(){
    var params=new URLSearchParams(window.location.search);
    var page=params.get('page')||'1';
    var per_page=params.get('per_page')||'10';
    var vendor_ids=params.get('vendor_ids')||'';
    var url='/api/v1/home/overview?page='+encodeURIComponent(page)+'&per_page='+encodeURIComponent(per_page);
    if(vendor_ids){ url+='&vendor_ids='+encodeURIComponent(vendor_ids); }
    fetch(url).then(function(r){return r.json()}).then(function(data){
      if(data && data.sync_in_progress===false){
        renderOverview(data);
        clearInterval(timer);
      }
    }).catch(function(){});
  }
  var timer=setInterval(function(){
    pollOverview();
    updateAdminProgress();
  }, 10000);
  pollOverview();
  updateAdminProgress();
});
</script>
{% endif %}
{% endblock %}
