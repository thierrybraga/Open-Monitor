{% extends 'core/base.html' %}
{% block title %}Sincronizando{% endblock %}
{% block meta_description %}Carregando dados iniciais da NVD.{% endblock %}
{% block content %}
<section class="container min-vh-100 d-flex align-items-center justify-content-center text-center">
  <div class="w-100" style="max-width: 760px;">
  <div class="mb-4">
    <h1 class="h4">Sincronizando NVD</h1>
    <p class="text-muted">Aguarde enquanto concluímos a preparação inicial.</p>
  </div>

  <div class="mx-auto" style="max-width: 640px;">
    <div class="progress" style="height: 20px; background-color:#e9ecef;">
      <div id="sync-progress-bar" class="progress-bar bg-success" role="progressbar" aria-label="Progresso de sincronização da NVD" aria-describedby="sync-progress-text" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div id="sync-progress-text" class="small text-muted mt-2" role="status" aria-live="polite">Sincronizando...</div>
  </div>


  

  <div class="mt-4">
    <button id="retry-sync" class="btn btn-outline-primary btn-sm" type="button">
      <i class="bi bi-arrow-repeat me-1"></i>Forçar sincronização
    </button>
  </div>

  <div id="sync-error" class="alert alert-warning mt-4 d-none" role="alert">
    Não foi possível obter o status de sincronização. Tentando novamente automaticamente.
  </div>
</section>
  </div>

<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', function(){
  var bar=document.getElementById('sync-progress-bar');
  var txt=document.getElementById('sync-progress-text');
  var err=document.getElementById('sync-error');
  var totalEl=null;
  var nextEl=null;
  var processedEl=null;
  var savedEl=null;
  var pollMs=10000;
  var maxPct=0, maxCur=0, maxTot=0, maxSaved=0;
  var nextCountdownHandle=null;
  var knownTotal=null;
  
  function setNextRefresh(seconds){ pollMs = (seconds && seconds>0) ? (seconds*1000) : 30000; }
  function updateBootstrap(){
    (typeof window.fetchWithRetry==='function'? window.fetchWithRetry('/api/v1/system/bootstrap', {}, 2, 300) : fetch('/api/v1/system/bootstrap'))
      .then(function(r){return r.json()})
      .then(function(b){
        if(totalEl && b && typeof b.total_cves==='number'){ totalEl.textContent='Total de CVEs conhecidos: '+b.total_cves; }
        try{
          var est = (typeof b.nvd_total_estimate==='number') ? b.nvd_total_estimate : null;
          var fallback = (typeof b.total_cves==='number') ? b.total_cves : null;
          knownTotal = (est && est>0) ? est : (fallback && fallback>0 ? fallback : knownTotal);
        }catch(_){}
        if(typeof b.next_refresh_seconds==='number'){ setNextRefresh(b.next_refresh_seconds); }
        if(b && b.sync_in_progress===false && b.first_sync_completed===true){ window.location.href='/'; }
      })
      .catch(function(){});
  }
  function updateProgress(){
    (typeof window.getSyncProgress==='function' ? window.getSyncProgress() : (fetch('/api/v1/sync/progress').then(function(r){return r.json()}).then(function(j){ return (typeof window.normalizeSyncProgressPayload==='function'? window.normalizeSyncProgressPayload(j) : j); })))
      .then(function(prog){
        var cur = (typeof prog.current==='number') ? prog.current : 0;
        var tot = (typeof prog.total==='number') ? prog.total : 0;
        var pct = (typeof prog.percentage==='number') ? prog.percentage : null;
        var status = prog && prog.status ? String(prog.status).toLowerCase() : null;
        var savingCount = (typeof prog.saving_count==='number') ? prog.saving_count : null;
        var savingPct = (typeof prog.saving_percentage==='number') ? prog.saving_percentage : null;
        var savedCurrent = (typeof prog.current==='number') ? prog.current : null;
        var savedDbTotal = (typeof prog.synced_count==='number') ? prog.synced_count : null;
        var displayedPct = null;
        if(status==='saving'){
          // Durante gravação, exibir exatamente a taxa de gravação atual
          displayedPct = (typeof savingPct==='number') ? savingPct : (typeof pct==='number' ? pct : 0);
          // Não aplicar clamp de maxPct em modo saving
        } else {
          // Em processamento, manter progresso monotônico
          if(typeof pct==='number'){ if(pct<maxPct){ displayedPct=maxPct; } else { maxPct=pct; displayedPct=pct; } }
          else { displayedPct = maxPct; }
        }
        if(typeof cur==='number'){ if(cur<maxCur){ cur=maxCur; } else { maxCur=cur; } }
        if(typeof tot==='number'){ if(tot<maxTot){ tot=maxTot; } else { maxTot=tot; } }
        var showSaved=null;
        if(savedDbTotal!==null){
          showSaved=savedDbTotal;
        } else if(status==='saving' && savingCount!==null){
          showSaved=savingCount;
        } else if(savedCurrent!==null){
          showSaved=savedCurrent;
        }
        if(showSaved!==null){ if(showSaved<maxSaved){ showSaved=maxSaved; } else { maxSaved=showSaved; } }
        if(bar){ var p=(displayedPct||0); bar.style.width=p+'%'; bar.setAttribute('aria-valuenow', p); }
        var label=(status==='saving')? 'Gravando' : ((status==='processing')? 'Processando' : 'Sincronização');
        var pctText=(typeof displayedPct==='number'? Number(displayedPct).toFixed(2) : '--');
        var savedCount2 = (typeof showSaved==='number') ? showSaved : null;
        if (status==='saving' && typeof savingCount==='number' && savingCount>0) {
          var z = savingCount;
          var denom = (typeof tot==='number' && tot>0) ? tot : (typeof knownTotal==='number' && knownTotal>0 ? knownTotal : 0);
          var overallPct = null;
          if(typeof cur==='number' && denom>0){ overallPct = (cur/denom)*100.0; }
          var overallTxt = (typeof overallPct==='number') ? Number(overallPct).toFixed(2) : (typeof pct==='number' ? Number(pct).toFixed(2) : '--');
          var shownTotal = (typeof tot==='number' && tot>0) ? tot : (typeof knownTotal==='number' && knownTotal>0 ? knownTotal : 0);
          if(txt){ txt.textContent='Gravando lote: '+z+' · Total: '+shownTotal+' · Geral: '+overallTxt+'% ('+(cur||0)+'/'+(shownTotal||0)+')' + (prog && prog.last_cve_id ? ' ('+prog.last_cve_id+')' : ''); }
        } else {
          if(txt){ txt.textContent=label+': '+pctText + (prog && prog.last_cve_id ? ' ('+prog.last_cve_id+')' : '') + (savedCount2!==null ? ' · Gravados: '+savedCount2 : ''); }
        }
        try{
          if(bar){
            bar.classList.remove('bg-primary','bg-info','bg-warning','bg-danger','bg-success');
            if(status==='saving'){ bar.classList.add('bg-warning'); } else { bar.classList.add('bg-success'); }
          }
        }catch(_){}
        try{
          var desired = (typeof window.computeSyncPollingInterval==='function' ? window.computeSyncPollingInterval(status) : ((status==='processing' || status==='saving') ? 10000 : 600000));
          if (desired !== pollMs) {
            pollMs = desired;
            setNextRefresh(desired/1000);
            if (window.__pollHandle) { clearInterval(window.__pollHandle); }
            startPolling();
          }
        }catch(_){}
        if(err){ err.classList.add('d-none'); }
      })
      .catch(function(){ if(err){ err.classList.remove('d-none'); } });
  }
  function pollTick(){ updateBootstrap(); updateProgress(); }
  function startPolling(){ if(window.__pollHandle){ clearInterval(window.__pollHandle); } window.__pollHandle=setInterval(pollTick, pollMs); }
  function schedule(){ pollTick(); startPolling(); }
  updateBootstrap();
  updateProgress();
  setTimeout(schedule, 300);
  var btn=document.getElementById('retry-sync');
  if(btn){
    btn.addEventListener('click', function(){
      try{
        var csrf = (function(){ var m=document.querySelector('meta[name="csrf-token"]'); return m? m.getAttribute('content') : ''; })();
        var prevHtml = btn.innerHTML; btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Forçando...';
        fetch('/api/v1/sync/trigger', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrf}, body: JSON.stringify({full:true})})
          .then(function(){
            try{ setTimeout(function(){ btn.disabled=false; btn.innerHTML=prevHtml; }, 15000); }catch(_){}
            try{ pollMs=10000; setNextRefresh(10); startPolling(); }catch(_){}
            updateProgress(); updateBootstrap();
          });
      }catch(_){}
    });
  }
});
</script>
{% endblock %}
