{% extends 'core/base.html' %}

{% block title %}Busca - Open Monitor{% endblock %}

{% block meta_description %}Busque e encontre vulnerabilidades, hosts e informações de segurança rapidamente. Sistema de busca avançado com filtros e resultados em tempo real.{% endblock %}

{% block meta_keywords %}busca, pesquisa, vulnerabilidades, hosts, segurança, filtros, CVE, sistema de busca{% endblock %}

{% block og_title %}Busca - Sistema de Monitoramento de Segurança{% endblock %}

{% block og_description %}Ferramenta de busca avançada para encontrar vulnerabilidades, hosts e informações de segurança de forma rápida e eficiente.{% endblock %}

{% block og_type %}website{% endblock %}

{% macro pagination(total_pages, current_page, page_size) %}
  <nav class="pagination d-flex gap-2 justify-content-center mt-3 align-items-center" aria-label="Paginação de resultados">
    <button class="btn btn-sm btn-outline-secondary"
            id="prev-page"
            {{ 'disabled' if current_page <= 1 else '' }}
            aria-label="Página anterior">
      <i class="bi bi-chevron-left" aria-hidden="true"></i>
      <span class="visually-hidden">Página anterior</span>
    </button>
    <span id="page-info" class="small text-muted">
      Página {{ current_page }} de {{ total_pages }}
    </span>
    <button class="btn btn-sm btn-outline-secondary"
            id="next-page"
            {{ 'disabled' if current_page >= total_pages else '' }}
            aria-label="Próxima página">
      <i class="bi bi-chevron-right" aria-hidden="true"></i>
      <span class="visually-hidden">Próxima página</span>
    </button>
    <input type="number"
           id="go-to-page"
           class="form-control form-control-sm w-16"
           min="1"
           max="{{ total_pages }}"
           value="{{ current_page }}"
           aria-label="Ir para página"
           placeholder="Página">
    <select id="page-size"
            class="form-select form-select-sm"
            aria-label="Resultados por página">
      {% for size in [10, 25, 50] %}
        <option value="{{ size }}" {{ 'selected' if size == page_size else '' }}>
          {{ size }}
        </option>
      {% endfor %}
    </select>
  </nav>
{% endmacro %}

{% block extra_css %}
  {# Removido: CSS de página já importado via main.css #}
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" nonce="{{ csp_nonce }}">
  <style nonce="{{ csp_nonce }}">
    /* Estilos específicos para elementos únicos da página search */
    .quick-examples {
      background: var(--glass-bg-medium);
      border-radius: var(--radius-modern-md);
      padding: 1rem;
      border: 1px solid var(--glass-border-light);
      backdrop-filter: var(--glass-blur-light);
    }
    
    .quick-examples h6 {
      color: var(--neutral-700);
    }
    
    .example-btn:hover {
      transform: translateX(4px);
    }
    
    .recent-searches {
      background: var(--glass-bg-medium);
      border: 1px solid var(--glass-border-light);
      border-radius: var(--radius-modern-md);
      padding: 1rem;
      max-height: 200px;
      overflow-y: auto;
      backdrop-filter: var(--glass-blur-light);
    }
    
    .recent-searches h6 {
      color: var(--neutral-700);
    }
    
    .recent-search-item {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.25rem;
      background: var(--surface-50);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-modern-sm);
      cursor: pointer;
      transition: var(--transition-soft-fast);
      font-size: 0.875rem;
    }
    
    .recent-search-item:hover {
      background: var(--primary-50);
      border-color: var(--primary-200);
      transform: translateX(2px);
    }
    
    .recent-search-item span {
      flex: 1;
      margin-left: 0.5rem;
    }
    
    .recent-search-item .remove-recent {
      opacity: 0;
      transition: var(--transition-soft-fast);
      padding: 0.125rem 0.25rem;
      font-size: 0.75rem;
    }
    
    .recent-search-item:hover .remove-recent {
      opacity: 1;
    }

    /* Enhanced Components */
    .stat-card {
      background: var(--glass-bg-light);
      border: 1px solid var(--glass-border-light);
      border-radius: var(--radius-modern-lg);
      backdrop-filter: var(--glass-blur-light);
      transition: var(--transition-soft-normal);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft-lg);
      border-color: var(--primary-200);
    }

    .search-input-container {
      position: relative;
    }

    .search-suggestions {
      background: var(--surface-0);
      border: 1px solid var(--glass-border-light);
      border-radius: 0 0 var(--radius-modern-md) var(--radius-modern-md);
      box-shadow: var(--shadow-soft-lg);
      backdrop-filter: var(--glass-blur-light);
      max-height: 250px;
      overflow-y: auto;
      z-index: 1050;
    }

    .suggestion-item {
      padding: var(--space-sm) var(--space-md);
      cursor: pointer;
      transition: var(--transition-soft-fast);
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--surface-100);
    }

    .suggestion-item:hover,
    .suggestion-item.active {
      background: var(--primary-50);
      color: var(--primary-600);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .search-options {
      background: var(--surface-50);
      border-radius: var(--radius-modern-md);
      padding: var(--space-md);
      border: 1px solid var(--surface-200);
    }

    .form-check-input:checked {
      background-color: var(--primary-500);
      border-color: var(--primary-500);
    }

    .form-check-input:focus {
      border-color: var(--primary-300);
      box-shadow: 0 0 0 0.25rem var(--primary-100);
    }

    /* Loading States */
    .btn-loading {
      position: relative;
      pointer-events: none;
    }

    .btn-loading .btn-text {
      opacity: 0;
    }

    .btn-loading .spinner-border {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* Responsive Improvements */
    @media (max-width: 768px) {
      .stat-card {
        margin-bottom: var(--space-sm);
      }
      
      .search-options {
        padding: var(--space-sm);
      }
      
      .form-check-label {
        font-size: 0.875rem;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="search-container" role="main">
  <!-- Page Header -->
  <header class="page-header mb-4">
    <div class="page-header-content">
      <div class="page-title-section">
        <h1 class="page-title">
          <i class="bi bi-search me-2"></i>
          Consulta de IP
        </h1>
        <p class="page-subtitle">Digite um endereço IP ou domínio para consultar informações detalhadas via Shodan API.</p>
      </div>
    </div>
  </header>

  <!-- Search Card -->
  <section class="search-card mb-4" aria-labelledby="search-title">
    <div class="card-header">
      <h2 id="search-title" class="card-title">
        <i class="bi bi-globe me-2"></i>
        Buscar Endereço IP ou Domínio
      </h2>
    </div>
    <div class="card-body p-4">
      <!-- Search Statistics -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="stat-card text-center p-3">
            <i class="bi bi-search fs-2 text-primary mb-2"></i>
            <div class="fw-bold fs-5" id="total-searches">0</div>
            <small class="text-muted">Consultas Realizadas</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card text-center p-3">
            <i class="bi bi-clock-history fs-2 text-success mb-2"></i>
            <div class="fw-bold fs-5" id="avg-response-time">0ms</div>
            <small class="text-muted">Tempo Médio</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card text-center p-3">
            <i class="bi bi-shield-check fs-2 text-info mb-2"></i>
            <div class="fw-bold fs-5" id="security-score">100%</div>
            <small class="text-muted">Score de Segurança</small>
          </div>
        </div>
      </div>

      <form id="search-form" method="POST" action="{{ url_for('main.search') }}" novalidate role="search">
        <!-- Enhanced Search Input -->
        <div class="search-input-container position-relative mb-3">
          <div class="input-group input-group-lg">
            <span class="input-group-text bg-transparent border-end-0">
              <i class="bi bi-search text-muted"></i>
            </span>
            <input 
              type="text" 
              class="form-control border-start-0 ps-0" 
              id="search-ip" 
              name="query" 
              placeholder="Digite um IP, domínio ou URL para consultar... (Ctrl+K)"
              autocomplete="off"
              spellcheck="false"
              required
              aria-describedby="search-help"
              aria-controls="search-suggestions"
              aria-autocomplete="list"
              aria-expanded="false"
              value="{{ request.args.get('query', '') }}"
            >
            <div class="input-group-append">
              <button type="submit" class="btn btn-primary" aria-label="Buscar">
                <i class="bi bi-search me-1"></i>
                <span class="btn-text">Buscar</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true">
                </span>
              </button>
              <button type="button" class="btn btn-outline-secondary" aria-label="Limpar">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Limpar
              </button>
            </div>
          </div>
          
          <!-- Search Suggestions Dropdown -->
          <div id="search-suggestions" class="search-suggestions position-absolute w-100 bg-white border rounded-bottom shadow-sm d-none" role="listbox" aria-label="Sugestões de busca" aria-hidden="true" style="top: 100%; left: 0; z-index: 1000; max-height: 200px; overflow-y: auto;">
            <!-- Suggestions will be populated by JavaScript -->
          </div>
        </div>

        <!-- Search Options -->
        <div class="search-options mb-3">
          <div class="row g-2">
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="deep-scan" name="deep_scan">
                <label class="form-check-label" for="deep-scan">
                  <i class="bi bi-shield-exclamation me-1"></i>
                  Análise Profunda de Segurança
                </label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="geo-lookup" name="geo_lookup" checked>
                <label class="form-check-label" for="geo-lookup">
                  <i class="bi bi-geo-alt me-1"></i>
                  Localização Geográfica
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row g-3">
          <div class="col-md-8">
            <div class="invalid-feedback" id="ip-error"></div>
            <small id="search-help" class="text-muted mt-1 d-block">
              <i class="bi bi-info-circle me-1"></i>
              Digite um IP válido (ex: 8.8.8.8) ou domínio (ex: google.com)
            </small>
            
            <!-- Recent Searches -->
            <div id="recent-searches" class="recent-searches mt-3 d-none">
              <h6 class="text-muted mb-2">
                <i class="bi bi-clock-history me-1"></i>
                Pesquisas Recentes
              </h6>
              <div class="recent-searches-list" id="recent-searches-list"></div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="form-actions">
              <label class="form-label d-block">&nbsp;</label>
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary" id="search-btn">
                  <i class="bi bi-search me-1"></i>
                  <span class="btn-text">Buscar</span>
                  <span class="btn-loading d-none">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    Buscando...
                  </span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="clear-form">
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  Limpar
                </button>
              </div>
            </div>
            
            <!-- Quick Examples -->
            <div class="quick-examples mt-3">
              <h6 class="text-muted mb-2">
                <i class="bi bi-lightbulb me-1"></i>
                Exemplos Rápidos
              </h6>
              <div class="d-grid gap-1">
                <button type="button" class="btn btn-sm btn-outline-info example-btn" data-query="8.8.8.8">
                  <i class="bi bi-dns me-1"></i>
                  DNS Google
                </button>
                <button type="button" class="btn btn-sm btn-outline-info example-btn" data-query="1.1.1.1">
                  <i class="bi bi-shield-check me-1"></i>
                  Cloudflare DNS
                </button>
                <button type="button" class="btn btn-sm btn-outline-info example-btn" data-query="github.com">
                  <i class="bi bi-github me-1"></i>
                  GitHub
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </section>

  <!-- Results Section -->
  <section id="result-section" class="d-none" aria-labelledby="results-title">
    <!-- Summary Card -->
    <div class="card summary-card mb-4">
      <div class="card-header py-2 bg-primary text-white">
        <h2 id="results-title" class="h6 mb-0 d-flex align-items-center gap-2">
          Resumo do Host
          <span id="demo-badge" class="badge bg-warning d-none">Demo</span>
        </h2>
      </div>
      <div class="card-body p-3">
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-5 g-3">
          {% for metric in [
            {'id': 'summary-ip', 'title': 'IP', 'icon': 'globe'},
            {'id': 'summary-isp', 'title': 'ISP', 'icon': 'wifi'},
            {'id': 'summary-org', 'title': 'Organização', 'icon': 'building'},
            {'id': 'summary-ports', 'title': 'Portas', 'icon': 'plug'},
            {'id': 'summary-location', 'title': 'Localização', 'icon': 'geo-alt'}
          ] %}
            <div class="card metric-card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="small text-muted text-uppercase">{{ metric.title }}</div>
                  <div class="fs-5 fw-semibold" id="{{ metric.id }}">N/A</div>
                </div>
                <i class="bi bi-{{ metric.icon }} text-primary fs-3" aria-hidden="true"></i>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Google Maps -->
    <div class="card map-card mb-4">
      <div class="card-header py-2">
        <h2 class="h6 mb-0">Localização no Mapa</h2>
      </div>
      <div class="card-body p-3 position-relative">
        <div id="map-loading" class="map-loading d-flex justify-content-center align-items-center d-none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando mapa...</span>
          </div>
        </div>
        <div id="map" class="map-container" role="region" aria-label="Mapa com localização do IP"></div>
      </div>
    </div>

    <!-- Detailed Results Table -->
    <div class="card table-card">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Detalhes da Consulta</h2>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary"
                  id="reset-demo"
                  aria-label="Restaurar dados de demonstração">
            <i class="bi bi-arrow-repeat me-1" aria-hidden="true"></i> Restaurar Demo
          </button>
          <button class="btn btn-sm btn-primary"
                  id="export-results"
                  aria-label="Exportar resultados">
            <i class="bi bi-download me-1" aria-hidden="true"></i> Exportar
          </button>
        </div>
      </div>
      <div class="card-body p-3">
        <div id="table-loading" class="d-none d-flex justify-content-center p-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando tabela...</span>
          </div>
        </div>
        <div id="results-status" class="visually-hidden" aria-live="polite"></div>
        <div class="table-responsive" role="region" aria-labelledby="table-title">
          <h2 id="table-title" class="visually-hidden">Resultados da consulta</h2>
          <table class="table table-hover" aria-label="Detalhes da consulta de IP ou domínio">
            <caption class="visually-hidden">Tabela com propriedades e valores da busca; use Tab para navegar e Enter para acionar ações.</caption>
            <thead>
              <tr>
                <th scope="col" class="ps-3 sortable" data-sort="property" aria-sort="none">
                  Propriedade <i class="bi bi-arrow-down-up" aria-hidden="true"></i>
                </th>
                <th scope="col" class="ps-3 sortable" data-sort="value" aria-sort="none">
                  Valor <i class="bi bi-arrow-down-up" aria-hidden="true"></i>
                </th>
                <th scope="col" class="ps-3 text-center">Ações</th>
              </tr>
            </thead>
            <tbody id="result-table-body" aria-live="polite"></tbody>
          </table>
        </div>
        {{ pagination(total_pages | default(1), current_page | default(1), page_size | default(10)) }}
      </div>
    </div>
  </section>

  <!-- Loading State -->
  <div id="loading-spinner" class="spinner d-none" role="status" aria-live="polite">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
  </div>

  <!-- Error Message -->
  <div id="error-message" class="alert alert-danger d-none mx-auto max-w-lg mt-3" role="alert">
    <span id="error-text"></span>
    <button class="btn btn-sm btn-outline-secondary ms-2"
            id="retry-btn"
            type="button"
            aria-label="Tentar novamente">
      Tentar Novamente
    </button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
   <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" nonce="{{ csp_nonce }}"></script>
   <script nonce="{{ csp_nonce }}">
     window.MAPBOX_ACCESS_TOKEN = {{ config.get('MAPBOX_ACCESS_TOKEN') | tojson | safe }};
     const init = () => { if (typeof initMap === 'function') { initMap(); } };
     if (document.readyState === 'loading') {
       document.addEventListener('DOMContentLoaded', init);
     } else {
       init();
     }
   </script>
  <script defer
          src="{{ url_for('static', filename='js/features/search.js') }}"
          nonce="{{ csp_nonce }}"
          onerror="this.onerror=null;this.src='{{ url_for('static', filename='js/features/search-fallback.js') }}'"></script>
  
{% endblock %}