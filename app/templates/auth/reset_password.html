{% extends "core/base.html" %}

{% block title %}Redefinir Senha - Open Monitor{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h2>Redefinir Senha</h2>
            <p>Digite sua nova senha abaixo</p>
        </div>
        
        <form method="POST" class="auth-form">
            {{ csrf_token() }}
            
            <div class="form-group">
                <label for="password">Nova Senha:</label>
                <input type="password" id="password" name="password" required 
                       placeholder="Digite sua nova senha" 
                       minlength="8">
                <small class="form-help">Mínimo de 8 caracteres</small>
            </div>
            
            <div class="form-group">
                <label for="confirm_password">Confirmar Nova Senha:</label>
                <input type="password" id="confirm_password" name="confirm_password" required 
                       placeholder="Confirme sua nova senha" 
                       minlength="8">
            </div>
            
            <div class="password-strength" id="password-strength" style="display: none;">
                <div class="strength-bar">
                    <div class="strength-fill" id="strength-fill"></div>
                </div>
                <span class="strength-text" id="strength-text"></span>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full">
                Redefinir Senha
            </button>
        </form>
        
        <div class="auth-footer">
            <p><a href="{{ url_for('main.index') }}">Voltar ao Início</a></p>
            <p>Link expirado? <a href="{{ url_for('auth.forgot_password') }}">Solicitar Novo Link</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Validação de força da senha
function checkPasswordStrength(password) {
    let strength = 0;
    let feedback = [];
    
    if (password.length >= 8) strength += 1;
    else feedback.push('pelo menos 8 caracteres');
    
    if (/[a-z]/.test(password)) strength += 1;
    else feedback.push('letras minúsculas');
    
    if (/[A-Z]/.test(password)) strength += 1;
    else feedback.push('letras maiúsculas');
    
    if (/[0-9]/.test(password)) strength += 1;
    else feedback.push('números');
    
    if (/[^A-Za-z0-9]/.test(password)) strength += 1;
    else feedback.push('caracteres especiais');
    
    return { strength, feedback };
}

// Atualizar indicador de força da senha
function updatePasswordStrength() {
    const password = document.getElementById('password').value;
    const strengthDiv = document.getElementById('password-strength');
    const strengthFill = document.getElementById('strength-fill');
    const strengthText = document.getElementById('strength-text');
    
    if (password.length === 0) {
        strengthDiv.style.display = 'none';
        return;
    }
    
    strengthDiv.style.display = 'block';
    const result = checkPasswordStrength(password);
    const percentage = (result.strength / 5) * 100;
    
    strengthFill.style.width = percentage + '%';
    
    if (result.strength <= 2) {
        strengthFill.className = 'strength-fill weak';
        strengthText.textContent = 'Fraca';
        strengthText.className = 'strength-text weak';
    } else if (result.strength <= 3) {
        strengthFill.className = 'strength-fill medium';
        strengthText.textContent = 'Média';
        strengthText.className = 'strength-text medium';
    } else {
        strengthFill.className = 'strength-fill strong';
        strengthText.textContent = 'Forte';
        strengthText.className = 'strength-text strong';
    }
}

// Validação de confirmação de senha
function validatePasswordMatch() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const confirmInput = document.getElementById('confirm_password');
    
    if (confirmPassword && password !== confirmPassword) {
        confirmInput.setCustomValidity('As senhas não coincidem');
    } else {
        confirmInput.setCustomValidity('');
    }
}

// Event listeners
document.getElementById('password').addEventListener('input', function() {
    updatePasswordStrength();
    validatePasswordMatch();
});

document.getElementById('confirm_password').addEventListener('input', validatePasswordMatch);

// Validação do formulário
document.querySelector('.auth-form').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (!password || !confirmPassword) {
        e.preventDefault();
        alert('Por favor, preencha todos os campos.');
        return;
    }
    
    if (password !== confirmPassword) {
        e.preventDefault();
        alert('As senhas não coincidem.');
        return;
    }
    
    if (password.length < 8) {
        e.preventDefault();
        alert('A senha deve ter pelo menos 8 caracteres.');
        return;
    }
});
</script>

<style>
.password-strength {
    margin-top: 10px;
}

.strength-bar {
    width: 100%;
    height: 6px;
    background-color: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 5px;
}

.strength-fill {
    height: 100%;
    transition: width 0.3s ease, background-color 0.3s ease;
    border-radius: 3px;
}

.strength-fill.weak {
    background-color: #ff4444;
}

.strength-fill.medium {
    background-color: #ffaa00;
}

.strength-fill.strong {
    background-color: #00aa00;
}

.strength-text {
    font-size: 12px;
    font-weight: 500;
}

.strength-text.weak {
    color: #ff4444;
}

.strength-text.medium {
    color: #ffaa00;
}

.strength-text.strong {
    color: #00aa00;
}
</style>
{% endblock %}