{% extends 'core/base.html' %}

{% block title %}Criar Conta{% endblock %}

{% block content %}
<section class="auth-container auth-minimal container d-flex align-items-center justify-content-center min-vh-100">
  <div class="auth-card auth-minimal w-100" style="max-width: 560px;">
    <header class="text-center mb-4">
      <h1 class="mb-2">Criar conta</h1>
      <p class="text-muted">Cadastre-se para começar a usar o Open-Monitor</p>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" class="auth-form" novalidate id="register-form">
      {{ form.hidden_tag() }}

      <div class="form-group mb-3">
        <label for="first_name" class="form-label required">Nome</label>
        {{ form.first_name(class="form-control" + (" is-invalid" if form.first_name.errors else ""), id="first_name", placeholder="Digite seu nome", autocomplete="given-name") }}
        {% if form.first_name.errors %}
          <div class="invalid-feedback">{{ form.first_name.errors[0] }}</div>
        {% endif %}
      </div>

      <div class="form-group mb-3">
        <label for="last_name" class="form-label required">Sobrenome</label>
        {{ form.last_name(class="form-control" + (" is-invalid" if form.last_name.errors else ""), id="last_name", placeholder="Digite seu sobrenome", autocomplete="family-name") }}
        {% if form.last_name.errors %}
          <div class="invalid-feedback">{{ form.last_name.errors[0] }}</div>
        {% endif %}
      </div>

      <div class="form-group mb-3">
        <label for="username" class="form-label required">Nome de usuário</label>
        {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else ""), id="username", placeholder="Digite seu nome de usuário", autocomplete="username") }}
        {% if form.username.errors %}
          <div class="invalid-feedback">{{ form.username.errors[0] }}</div>
        {% endif %}
        <small class="text-muted mt-1 d-block">Mínimo de 3 caracteres, apenas letras, números e underscore</small>
      </div>

      <div class="form-group mb-3">
        <label for="email" class="form-label required">E-mail</label>
        {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else ""), id="email", placeholder="Digite seu e-mail", autocomplete="email") }}
        {% if form.email.errors %}
          <div class="invalid-feedback">{{ form.email.errors[0] }}</div>
        {% endif %}
      </div>

      <div class="form-group mb-3">
        <label for="phone" class="form-label">Telefone (opcional)</label>
        {{ form.phone(class="form-control" + (" is-invalid" if form.phone.errors else ""), id="phone", placeholder="(11) 99999-9999", autocomplete="tel") }}
        {% if form.phone.errors %}
          <div class="invalid-feedback">{{ form.phone.errors[0] }}</div>
        {% endif %}
      </div>

      <div class="form-group mb-3">
        <label for="password" class="form-label required">Senha</label>
        <div class="input-group">
          {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else ""), id="password", placeholder="Digite sua senha", autocomplete="new-password") }}
          <button class="btn btn-outline-secondary" type="button" id="togglePassword" aria-label="Mostrar/ocultar senha">
            <i class="bi bi-eye" id="togglePasswordIcon"></i>
          </button>
        </div>
        {% if form.password.errors %}
          <div class="invalid-feedback">{{ form.password.errors[0] }}</div>
        {% endif %}
        <div class="password-strength mt-2">
          <div class="password-strength-bar"><div class="password-strength-fill" id="passwordStrengthFill"></div></div>
          <small class="password-strength-text" id="passwordStrengthText">Digite uma senha</small>
        </div>
      </div>

      <div class="form-group mb-3">
        <label for="confirm_password" class="form-label required">Confirmar senha</label>
        <div class="input-group">
          {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else ""), id="confirm_password", placeholder="Confirme sua senha", autocomplete="new-password") }}
          <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword" aria-label="Mostrar/ocultar senha">
            <i class="bi bi-eye" id="toggleConfirmPasswordIcon"></i>
          </button>
        </div>
        {% if form.confirm_password.errors %}
          <div class="invalid-feedback">{{ form.confirm_password.errors[0] }}</div>
        {% endif %}
        <div class="password-match mt-2" id="passwordMatch" style="display: none;">
          <small class="text-success"><i class="bi bi-check"></i> As senhas coincidem</small>
        </div>
        <div class="password-mismatch mt-2" id="passwordMismatch" style="display: none;">
          <small class="text-danger"><i class="bi bi-x"></i> As senhas não coincidem</small>
        </div>
      </div>

      <div class="form-group mb-3">
        <div class="form-check">
          {{ form.terms_accepted(class="form-check-input" + (" is-invalid" if form.terms_accepted.errors else ""), id="terms_accepted") }}
          <label class="form-check-label" for="terms_accepted">
            Eu aceito os <a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#termsModal">Termos de Uso</a> e a <a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#privacyModal">Política de Privacidade</a>
          </label>
          {% if form.terms_accepted.errors %}
            <div class="invalid-feedback d-block">{{ form.terms_accepted.errors[0] }}</div>
          {% endif %}
        </div>
      </div>

      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary btn-lg" id="register-btn">
          <span class="btn-text"><i class="bi bi-person-plus me-2"></i> Criar Conta</span>
          <span class="btn-loading" style="display: none;">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Criando conta...
          </span>
        </button>
      </div>
    </form>

    <footer class="auth-footer auth-minimal mt-5 text-center" role="contentinfo" aria-label="Ações de navegação">
      <div class="footer-links d-flex justify-content-center align-items-center gap-3">
        <a href="{{ url_for('auth.login') }}" class="footer-link">Entrar</a>
        <span class="text-muted" aria-hidden="true">·</span>
        <a href="{{ url_for('main.index') }}" class="footer-link">Voltar ao início</a>
      </div>
    </footer>
  </div>
</section>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/auth.js') }}" defer nonce="{{ nonce }}"></script>
{% endblock %}
