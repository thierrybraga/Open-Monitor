{% extends 'core/base.html' %}
{% set footer_has_utility = true %}

{% block title %}Analytics Dashboard - Open CVE Report{% endblock %}

{% block extra_css %}
{# Removido: CSS de página já importado via main.css #}
{% endblock %}

{% block header_brand %}
  <span>Open CVE Report - Analytics Dashboard</span>
{% endblock %}

{% block content %}
<div class="analytics-dashboard" role="main">
  <!-- Page Header -->
  <header class="dashboard-header d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
    <div>
      <h1 class="h3 fw-semibold mb-1">Analytics Dashboard</h1>
      <p class="text-muted small">Real-time CVE monitoring and security insights</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-primary d-flex align-items-center gap-2" id="refresh-data" aria-label="Refresh dashboard data">
        <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> Refresh
      </button>
    </div>
  </header>

  <!-- Key Metrics -->
  <section class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 mb-4">
    <div class="col">
      <div class="card metric-card border-primary h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Total CVEs</div>
              <div class="fs-4 fw-semibold text-primary" id="total-cves">{{ total_cves | default(0, true) }}</div>
            </div>
            <i class="bi bi-shield-fill text-primary fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-danger h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Critical</div>
              <div class="fs-4 fw-semibold text-danger" id="critical-severity-cves">{{ critical_cves | default(0, true) }}</div>
            </div>
            <i class="bi bi-exclamation-triangle-fill text-danger fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-warning h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">High</div>
              <div class="fs-4 fw-semibold text-warning" id="high-severity-cves">{{ high_cves | default(0, true) }}</div>
            </div>
            <i class="bi bi-exclamation-circle-fill text-warning fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-success h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Medium</div>
              <div class="fs-4 fw-semibold text-success" id="medium-severity-cves">{{ medium_cves | default(0, true) }}</div>
            </div>
            <i class="bi bi-exclamation text-success fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-success h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Patched</div>
              <div class="fs-4 fw-semibold text-success" id="patched-cves">{{ patched_cves | default(0, true) }}</div>
            </div>
            <i class="bi bi-check-circle-fill text-success fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-danger h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Unpatched</div>
              <div class="fs-4 fw-semibold text-danger" id="unpatched-cves">{{ unpatched_cves | default(0, true) }}</div>
            </div>
            <i class="bi bi-x-circle-fill text-danger fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-primary h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Active Threats</div>
              <div class="fs-4 fw-semibold text-primary" id="active-threats">{{ active_threats | default(0, true) }}</div>
            </div>
            <i class="bi bi-bell-fill text-primary fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-primary h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Avg. CVSS Score</div>
              <div class="fs-4 fw-semibold text-primary" id="avg-cvss-score">{{ avg_cvss_score | default(0.0, true) }}</div>
            </div>
            <i class="bi bi-graph-up text-primary fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-warning h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Avg. Exploitability</div>
              <div class="fs-4 fw-semibold text-warning" id="avg-exploit-score">{{ avg_exploit_score | default(0.0, true) }}</div>
            </div>
            <i class="bi bi-lightning-fill text-warning fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-success h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Patch Coverage</div>
              <div class="fs-4 fw-semibold text-success" id="patch-coverage">{{ patch_coverage | default(0, true) }}%</div>
            </div>
            <i class="bi bi-shield-check text-success fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-primary h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Vendors</div>
              <div class="fs-4 fw-semibold text-primary" id="vendor-count">{{ vendor_count | default(0, true) }}</div>
            </div>
            <i class="bi bi-building text-primary fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-primary h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">Products</div>
              <div class="fs-4 fw-semibold text-primary" id="product-count">{{ product_count | default(0, true) }}</div>
            </div>
            <i class="bi bi-box-seam text-primary fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card metric-card border-danger h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small text-muted text-uppercase">CWEs</div>
              <div class="fs-4 fw-semibold text-danger" id="cwe-count">{{ cwe_count | default(0, true) }}</div>
            </div>
            <i class="bi bi-bug-fill text-danger fs-3" aria-hidden="true"></i>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Visual Insights -->
  <section class="card chart-section mb-4">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
      <h2 class="h6 mb-0">Visual Insights</h2>
      <button class="btn btn-sm btn-outline-secondary" id="export-charts" aria-label="Export charts">
        <i class="bi bi-download" aria-hidden="true"></i> Export
      </button>
    </div>
    <div class="card-body p-3">
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3">
        <div class="col">
          <div class="card chart-card h-100">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="h6 fw-semibold mb-0">Severity Distribution</h3>
                <button class="btn btn-sm btn-outline-primary expand-chart-btn" data-chart="severityChart" data-title="Distribuição de Severidade">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
              </div>
              <div class="chart-container doughnut-chart">
                <canvas id="severityChart" aria-label="Severity distribution chart"></canvas>
              </div>
            </div>
          </div>
    </div>
    <div class="col">
      <div class="card chart-card h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h6 fw-semibold mb-0">Patch Status</h3>
            <button class="btn btn-sm btn-outline-primary expand-chart-btn" data-chart="patchStatusChart" data-title="Status de Patches">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
          <div class="chart-container doughnut-chart">
            <canvas id="patchStatusChart" aria-label="Patch status chart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card chart-card h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h6 fw-semibold mb-0">Top Products</h3>
            <button class="btn btn-sm btn-outline-primary expand-chart-btn" data-chart="productChart" data-title="Top Produtos">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
          <div class="chart-container pie-chart">
            <canvas id="productChart" aria-label="Product distribution chart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card chart-card h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h6 fw-semibold mb-0">Top CWEs</h3>
            <button class="btn btn-sm btn-outline-primary expand-chart-btn" data-chart="cweChart" data-title="Top CWEs">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
          <div class="chart-container pie-chart">
            <canvas id="cweChart" aria-label="CWE distribution chart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card chart-card h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h6 fw-semibold mb-0">Exploit × Impact</h3>
            <button class="btn btn-sm btn-outline-primary expand-chart-btn" data-chart="exploitImpactChart" data-title="Exploit × Impact">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
          <div class="chart-container">
            <canvas id="exploitImpactChart" aria-label="Exploit vs impact scatter chart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card chart-card h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h6 fw-semibold mb-0">CVE History</h3>
            <button class="btn btn-sm btn-outline-primary expand-chart-btn" data-chart="cveHistoryChart" data-title="Histórico de CVEs">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
          <div class="chart-container">
            <canvas id="cveHistoryChart" aria-label="CVE history chart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card chart-card h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h6 fw-semibold mb-0">Attack Vector</h3>
            <button class="btn btn-sm btn-outline-primary expand-chart-btn" data-chart="attackVectorChart" data-title="Vetores de Ataque">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
          <div class="chart-container">
            <canvas id="attackVectorChart" aria-label="Attack vector distribution chart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card chart-card h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h6 fw-semibold mb-0">Top Assigners</h3>
            <button class="btn btn-sm btn-outline-primary expand-chart-btn" data-chart="assigneeChart" data-title="Top Assigners">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
          <div class="chart-container">
            <canvas id="assigneeChart" aria-label="Top assigners chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Top Products Table -->
<section class="card table-card mb-4">
  <div class="card-header py-2 d-flex justify-content-between align-items-center">
    <h2 class="h6 mb-0">Top Products</h2>
    <div class="d-flex gap-2 align-items-center">
      <!-- Filtros -->
      <select class="form-select form-select-sm w-auto" id="severity-filter">
        <option value="">Todas Severidades</option>
        <option value="CRITICAL">Crítico</option>
        <option value="HIGH">Alto</option>
        <option value="MEDIUM">Médio</option>
        <option value="LOW">Baixo</option>
      </select>
      <select class="form-select form-select-sm w-auto" id="risk-filter">
        <option value="">Todos Riscos</option>
        <option value="80">Risco Extremo (80+)</option>
        <option value="60">Risco Alto (60+)</option>
        <option value="40">Risco Médio (40+)</option>
      </select>
      <button class="btn btn-sm btn-outline-secondary" id="clear-filters" title="Limpar Filtros">
        <i class="fas fa-times"></i>
      </button>
      <div class="pagination-info">
        <small class="text-muted" id="products-pagination-info">Loading...</small>
      </div>
    </div>
  </div>
  <div class="card-body p-3">
    <!-- Barra de busca -->
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="input-group input-group-sm">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" class="form-control" id="product-search" placeholder="Buscar produtos ou vendors...">
        </div>
      </div>
      <div class="col-md-6 text-end">
        <div class="btn-group btn-group-sm" role="group">
          <button class="btn btn-outline-primary" id="export-products" title="Exportar Dados">
            <i class="fas fa-download"></i> Exportar
          </button>
          <button class="btn btn-outline-secondary" id="refresh-products" title="Atualizar Dados">
            <i class="fas fa-sync-alt"></i> Atualizar
          </button>
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table class="analytics-table" aria-label="Top products affected by CVEs">
        <thead>
          <tr>
            <th scope="col" class="sortable" data-sort="product" data-bs-toggle="tooltip" title="Nome do produto ou software" aria-sort="none">
              Product <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="sortable" data-sort="vendor" data-bs-toggle="tooltip" title="Fornecedor ou desenvolvedor do produto" aria-sort="none">
              Vendor <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="total_cves" data-bs-toggle="tooltip" title="Número total de CVEs identificadas" aria-sort="none">
              Total CVEs <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="risk_score" data-bs-toggle="tooltip" title="Pontuação de risco calculada baseada em severidade e exposição" aria-sort="none">
              Risk Score <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="critical_count" data-bs-toggle="tooltip" title="Número de vulnerabilidades críticas" aria-sort="none">
              Critical CVEs <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="avg_cvss" data-bs-toggle="tooltip" title="Pontuação CVSS média das vulnerabilidades" aria-sort="none">
              CVSS Avg <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="recent_cves" data-bs-toggle="tooltip" title="CVEs descobertas nos últimos 30 dias" aria-sort="none">
              Recent Activity <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="patch_percentage" data-bs-toggle="tooltip" title="Percentual de vulnerabilidades com patches disponíveis" aria-sort="none">
              Patch Status <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column" data-bs-toggle="tooltip" title="Tendência de crescimento ou redução de vulnerabilidades">
              Trend
            </th>
          </tr>
        </thead>
        <tbody id="product-table-body"></tbody>
      </table>
    </div>
    <!-- Pagination Controls -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="pagination-controls">
        <button class="btn btn-sm btn-outline-primary" id="products-prev-btn" disabled>
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span class="mx-3">
          Page <span id="products-current-page">1</span> of <span id="products-total-pages">1</span>
        </span>
        <button class="btn btn-sm btn-outline-primary" id="products-next-btn" disabled>
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="page-size-controls">
        <label for="products-page-size" class="form-label mb-0 me-2">Items per page:</label>
        <select class="form-select form-select-sm" id="products-page-size" style="width: auto;">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- Top CWEs Table -->
<section class="card table-card mb-4">
  <div class="card-header py-2 d-flex justify-content-between align-items-center flex-wrap">
    <h2 class="h6 mb-0">Top CWEs</h2>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <select class="form-select form-select-sm w-auto" id="cwe-severity-filter">
        <option value="">Todas Severidades</option>
        <option value="CRITICAL">Crítico</option>
        <option value="HIGH">Alto</option>
        <option value="MEDIUM">Médio</option>
        <option value="LOW">Baixo</option>
      </select>
      <select class="form-select form-select-sm w-auto" id="cwe-risk-filter">
        <option value="">Todos Riscos</option>
        <option value="8">Risco Extremo (8.0+)</option>
        <option value="6">Risco Alto (6.0+)</option>
        <option value="4">Risco Médio (4.0+)</option>
      </select>
      <button class="btn btn-sm btn-outline-secondary" id="clear-cwe-filters" title="Limpar Filtros">
        <i class="fas fa-times"></i>
      </button>
      <div class="pagination-info">
        <small class="text-muted" id="cwes-pagination-info">Loading...</small>
      </div>
    </div>
  </div>
  <div class="card-body p-3">
    <!-- Barra de busca -->
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="input-group input-group-sm">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" class="form-control" id="cwe-search" placeholder="Buscar CWEs...">
        </div>
      </div>
      <div class="col-md-6 text-end">
        <div class="btn-group btn-group-sm" role="group">
          <button class="btn btn-outline-primary" id="export-cwes" title="Exportar Dados">
            <i class="fas fa-download"></i> Exportar
          </button>
          <button class="btn btn-outline-secondary" id="refresh-cwes" title="Atualizar Dados">
            <i class="fas fa-sync-alt"></i> Atualizar
          </button>
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table class="analytics-table" aria-label="Top CWEs associated with CVEs">
        <thead>
          <tr>
            <th scope="col" class="sortable" data-sort="cwe" data-bs-toggle="tooltip" title="Identificador da Common Weakness Enumeration" aria-sort="none">
              CWE <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="count" data-bs-toggle="tooltip" title="Número total de CVEs associadas a esta CWE" aria-sort="none">
              CVEs <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="avg_cvss" data-bs-toggle="tooltip" title="Pontuação CVSS média das CVEs desta CWE" aria-sort="none">
              CVSS Médio <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="max_cvss" data-bs-toggle="tooltip" title="Maior pontuação CVSS encontrada para esta CWE" aria-sort="none">
              CVSS Max <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="critical_count" data-bs-toggle="tooltip" title="Número de CVEs com severidade crítica" aria-sort="none">
              Crítico <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="high_count" data-bs-toggle="tooltip" title="Número de CVEs com severidade alta" aria-sort="none">
              Alto <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="medium_count" data-bs-toggle="tooltip" title="Número de CVEs com severidade média" aria-sort="none">
              Médio <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="low_count" data-bs-toggle="tooltip" title="Número de CVEs com severidade baixa" aria-sort="none">
              Baixo <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="critical_percentage" data-bs-toggle="tooltip" title="Percentual de CVEs críticas em relação ao total" aria-sort="none">
              % Crítico <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="recent_cves" data-bs-toggle="tooltip" title="CVEs descobertas nos últimos 30 dias" aria-sort="none">
              CVEs Recentes <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column sortable" data-sort="active_years" data-bs-toggle="tooltip" title="Número de anos com atividade de CVEs" aria-sort="none">
              Anos Ativos <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="metric-column" data-bs-toggle="tooltip" title="Tendência de crescimento ou redução de CVEs">
              Tendência
            </th>
            <th scope="col" class="metric-column sortable" data-sort="risk_score" data-bs-toggle="tooltip" title="Pontuação de risco calculada para esta CWE" aria-sort="none">
              Score Risco <i class="fas fa-sort text-muted"></i>
            </th>
          </tr>
        </thead>
        <tbody id="cwe-table-body"></tbody>
      </table>
    </div>
    <!-- Pagination Controls -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="pagination-controls">
        <button class="btn btn-sm btn-outline-primary" id="cwes-prev-btn" disabled>
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span class="mx-3">
          Page <span id="cwes-current-page">1</span> of <span id="cwes-total-pages">1</span>
        </span>
        <button class="btn btn-sm btn-outline-primary" id="cwes-next-btn" disabled>
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="page-size-controls">
        <label for="cwes-page-size" class="form-label mb-0 me-2">Items per page:</label>
        <select class="form-select form-select-sm w-auto" id="cwes-page-size">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- Latest CVEs Table -->
<section class="card table-card mb-4">
  <div class="card-header py-2 d-flex justify-content-between align-items-center flex-wrap">
    <h2 class="h6 mb-0">Latest CVEs</h2>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <select class="form-select form-select-sm w-auto" id="cve-severity-filter-header">
        <option value="">Todas Severidades</option>
        <option value="CRITICAL">Crítico</option>
        <option value="HIGH">Alto</option>
        <option value="MEDIUM">Médio</option>
        <option value="LOW">Baixo</option>
      </select>
      <select class="form-select form-select-sm w-auto" id="cve-patch-filter-header">
        <option value="">Todos Status</option>
        <option value="Available">Disponível</option>
        <option value="Pending">Pendente</option>
        <option value="Not Available">Não Disponível</option>
      </select>
      <button class="btn btn-sm btn-outline-secondary" id="clear-cve-filters-header" title="Limpar Filtros">
        <i class="fas fa-times"></i>
      </button>
      <div class="pagination-info">
        <small class="text-muted" id="cves-pagination-info">Loading...</small>
      </div>
    </div>
  </div>
  <div class="card-body p-3">
    <!-- Barra de busca -->
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="input-group input-group-sm">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" class="form-control" id="cve-search" placeholder="Buscar CVE ID ou descrição...">
        </div>
      </div>
      <div class="col-md-6 text-end">
        <div class="btn-group btn-group-sm" role="group">
          <button class="btn btn-outline-primary" id="export-cves" title="Exportar Dados">
            <i class="fas fa-download"></i> Exportar
          </button>
          <button class="btn btn-outline-secondary" id="refresh-cves" title="Atualizar Dados">
            <i class="fas fa-sync-alt"></i> Atualizar
          </button>
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table class="analytics-table" aria-label="Paginated list of latest CVEs">
        <thead>
          <tr>
            <th scope="col" class="sortable text-nowrap" data-sort="cve_id" data-bs-toggle="tooltip" title="Identificador único da vulnerabilidade CVE" aria-sort="none">
              CVE <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="d-none d-md-table-cell" style="min-width: 250px;" data-bs-toggle="tooltip" title="Descrição detalhada da vulnerabilidade">Description</th>
            <th scope="col" class="sortable text-nowrap metric-column" data-sort="published_date" data-bs-toggle="tooltip" title="Data de publicação da CVE" aria-sort="none">
              Published <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="sortable text-nowrap metric-column" data-sort="severity" data-bs-toggle="tooltip" title="Nível de severidade da vulnerabilidade" aria-sort="none">
              Severity <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="sortable text-nowrap metric-column" data-sort="cvss_score" data-bs-toggle="tooltip" title="Pontuação CVSS da vulnerabilidade" aria-sort="none">
              CVSS <i class="fas fa-sort text-muted"></i>
            </th>
            <th scope="col" class="sortable text-nowrap metric-column" data-sort="patch_status" data-bs-toggle="tooltip" title="Status de disponibilidade de patch" aria-sort="none">
              Patch <i class="fas fa-sort text-muted"></i>
            </th>
          </tr>
        </thead>
        <tbody id="cve-table-body"></tbody>
      </table>
    </div>
    <!-- Pagination Controls -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="pagination-controls">
        <button class="btn btn-sm btn-outline-primary" id="cves-prev-btn" disabled>
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span class="mx-3">
          Page <span id="cves-current-page">1</span> of <span id="cves-total-pages">1</span>
        </span>
        <button class="btn btn-sm btn-outline-primary" id="cves-next-btn" disabled>
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="page-size-controls">
        <label for="cves-page-size" class="form-label mb-0 me-2">Items per page:</label>
        <select class="form-select form-select-sm w-auto" id="cves-page-size">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- Loading & Error -->
<div class="spinner d-none align-items-center justify-content-center" id="loading-spinner">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
<div class="alert alert-danger d-none mx-auto" id="error-message" role="alert"></div>

<!-- Modal para exibição expandida dos gráficos -->
<div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="chartModalLabel">Gráfico Expandido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="chart-container-expanded">
          <canvas id="expandedChart" aria-label="Expanded chart view"></canvas>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-primary" id="downloadExpandedChart">
          <i class="bi bi-download"></i> Download
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/pages/analytics.js') }}" defer nonce="{{ nonce }}"></script>
{% endblock %}