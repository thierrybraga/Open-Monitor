{% extends "core/base.html" %}

{% block title %}{{ report.title }} - {{ super() }}{% endblock %}

{% block meta_description %}Visualize relatório de cybersegurança: {{ report.title }}. Análise detalhada de vulnerabilidades, riscos e recomendações de segurança.{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header do Relatório -->
    <div class="report-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h2 mb-2">{{ report.title }}</h1>
                    <p class="mb-3 opacity-75">{{ report.description or 'Relatório de cybersegurança' }}</p>
                    
                    <!-- Badges -->
                    <div class="mb-3">
                        <span class="report-badge report-badge-neutral">
                            <i class="bi bi-file-earmark-text me-1"></i>
                            {{ report.report_type.value.replace('_', ' ').title() }}
                        </span>
                        <span class="report-badge report-badge-neutral">
                            <i class="bi bi-calendar me-1"></i>
                            {% if report.period_start and report.period_end %}
                                {{ report.period_start.strftime('%d/%m/%Y') }} - {{ report.period_end.strftime('%d/%m/%Y') }}
                            {% elif report.period_start %}
                                {{ report.period_start.strftime('%d/%m/%Y') }}
                            {% elif report.period_end %}
                                {{ report.period_end.strftime('%d/%m/%Y') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                        <span class="report-badge report-badge-neutral">
                            <i class="bi bi-bullseye me-1"></i>
                            {{ report.scope.value.replace('_', ' ').title() }}
                        </span>
                        
                        {% set meta = report.report_metadata or {} %}
                        {% if meta.get('badges') %}
                            {% for badge in meta.get('badges') %}
                                <span class="report-badge {{ badge.type }}-{{ badge.level }}">
                                    <i class="bi bi-{{ badge.icon }} me-1"></i>
                                    {{ badge.label }}
                                </span>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-4 text-md-end">
                    <div class="mb-3">
                        {% if report.status.value == 'pendente' %}
                            <span class="badge bg-warning fs-6">
                                <i class="bi bi-clock me-1"></i>
                                Pendente
                            </span>
                        {% elif report.status.value == 'gerando' %}
                            <span class="badge bg-info fs-6 status-processing">
                                <i class="bi bi-arrow-repeat me-1"></i>
                                Processando
                            </span>
                        {% elif report.status.value == 'concluido' %}
                            <span class="badge bg-success fs-6">
                                <i class="bi bi-check-circle me-1"></i>
                                Concluído
                            </span>
                        {% elif report.status.value == 'falhou' %}
                            <span class="badge bg-danger fs-6">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Erro
                            </span>
                        {% endif %}
                    </div>
                    
                    <div class="text-white-50 small">
                        <div><strong>Criado:</strong> {{ report.created_at.strftime('%d/%m/%Y %H:%M') }}</div>
                        {% if report.generated_at %}
                            <div><strong>Gerado:</strong> {{ report.generated_at.strftime('%d/%m/%Y %H:%M') }}</div>
                        {% endif %}
                        {% if report.user %}
                            <div><strong>Por:</strong> {{ report.user.username }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toolbar de Exportação -->
    <div class="export-toolbar no-print">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('report.list_reports') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        Voltar
                    </a>
                    
                    {% if report.status.value == 'concluido' %}
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary dropdown-toggle" 
                                    data-bs-toggle="dropdown">
                                <i class="bi bi-download me-1"></i>
                                Exportar
                            </button>
                            {% set export_formats = report.export_formats or ['html', 'pdf', 'json', 'docx'] %}
                            <ul class="dropdown-menu">
                                {% for format in export_formats %}
                                    <li>
                                        <a class="dropdown-item" 
                                           href="{{ url_for('report.export_report', report_id=report.id, format=format) }}">
                                            <i class="bi bi-file-earmark-{{ 'pdf' if format == 'pdf' else 'code' }} me-2"></i>
                                            {{ format.upper() }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    
                    <button type="button" class="btn btn-outline-secondary" onclick="printReport()">
                        <i class="bi bi-printer me-1"></i>
                        Imprimir
                    </button>
                </div>
            </div>
            
            <div class="col-md-6 text-end">
                {% if report.status.value in ['falhou', 'concluido'] %}
                    <form method="POST" action="{{ url_for('report.regenerate_report', report_id=report.id) }}" 
                          class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-outline-warning" 
                                onclick="return confirm('Deseja regenerar este relatório?')">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Regenerar
                        </button>
                    </form>
                {% endif %}
                
                <form method="POST" action="{{ url_for('report.delete_report', report_id=report.id) }}" 
                      class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-danger" 
                            onclick="return confirm('Deseja deletar este relatório?')">
                        <i class="bi bi-trash me-1"></i>
                        Deletar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Conteúdo do Relatório -->
    {% if report.content %}
        {% if report.status.value == 'falhou' %}
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <div>
                Houve uma falha na geração automática. Conteúdo padrão foi exibido.
                {% if report.report_metadata and report.report_metadata.error_message %}
                    <br><small class="text-muted">Detalhes: {{ report.report_metadata.error_message }}</small>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Resumo Executivo -->
        {% if report.content.executive_summary %}
        <div class="section-card" id="executive-summary">
            <div class="section-header">
                <h3 class="mb-0">
                    <i class="bi bi-briefcase me-2"></i>
                    Resumo Executivo
                </h3>
            </div>
            <div class="section-content">
                {% if report.content.executive_summary.ai_generated %}
                    <div class="ai-analysis">
                        <h5>
                            <i class="bi bi-robot ai-icon"></i>
                            Análise Inteligente
                        </h5>
                        <p>{{ report.content.executive_summary.content | safe }}</p>
                    </div>
                {% else %}
                    <p>{{ report.content.executive_summary.content | safe }}</p>
                {% endif %}
                
                <!-- Métricas Principais -->
                {% if report.content.executive_summary.key_metrics %}
                    <div class="row mt-4">
                        {% for metric in report.content.executive_summary.key_metrics %}
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value text-{{ metric.color or 'primary' }}">
                                        {{ metric.value }}
                                    </div>
                                    <div class="metric-label">{{ metric.label }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if report.content.enums_table %}
        <div class="section-card" id="totals-summary">
            <div class="section-header">
                <h3 class="mb-0">
                    <i class="bi bi-clipboard-data me-2"></i>
                    Resumo de Totais
                </h3>
            </div>
            <div class="section-content">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Métrica</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Vendors</td><td class="text-end">{{ report.content.enums_table.vendors_total }}</td></tr>
                            <tr><td>Produtos</td><td class="text-end">{{ report.content.enums_table.products_total }}</td></tr>
                            <tr><td>CVEs</td><td class="text-end">{{ report.content.enums_table.cves_total }}</td></tr>
                            <tr><td>CWEs</td><td class="text-end">{{ report.content.enums_table.cwes_total }}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Gráficos e Visualizações -->
        {% if report.content.charts %}
        <div class="section-card" id="charts">
            <div class="section-header">
                <h3 class="mb-0">
                    <i class="bi bi-bar-chart me-2"></i>
                    Visualizações
                </h3>
            </div>
            <div class="section-content">
                <div class="row">
                    {% for chart in report.content.charts %}
                <div class="col-md-6 mb-4">
                    <h5>{{ chart.title }}</h5>
                    <div class="chart-container {{ chart.size or 'medium' }}" data-lazy="chart" data-chart-id="chart-{{ loop.index }}" data-chart-data="{{ chart.data | tojson | e }}" data-chart-type="{{ chart.type }}">
                        <!-- Placeholder do gráfico -->
                        <div class="chart-placeholder d-flex align-items-center justify-content-center h-100">
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Carregando gráfico...</span>
                                </div>
                                <div class="text-muted">Carregando {{ chart.title }}...</div>
                            </div>
                        </div>
                        <canvas id="chart-{{ loop.index }}" class="d-none"></canvas>
                    </div>
                </div>
                {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if report.content.cvss_analysis %}
        <div class="section-card" id="cvss-analysis">
            <div class="section-header">
                <h3 class="mb-0">
                    <i class="bi bi-shield-lock me-2"></i>
                    Análise de CVSS
                </h3>
            </div>
            <div class="section-content">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value text-info">{{ report.content.cvss_analysis.stats.mean or 0 }}</div>
                            <div class="metric-label">Média</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value text-success">{{ report.content.cvss_analysis.stats.min or 0 }}</div>
                            <div class="metric-label">Mínimo</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value text-danger">{{ report.content.cvss_analysis.stats.max or 0 }}</div>
                            <div class="metric-label">Máximo</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value text-primary">{{ report.content.cvss_analysis.stats.count or 0 }}</div>
                            <div class="metric-label">Amostras</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h5>Versões CVSS</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">{{ report.content.cvss_analysis.versions.v2 or 0 }}</div>
                                    <div class="metric-label">CVSS v2</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">{{ report.content.cvss_analysis.versions.v3_0 or 0 }}</div>
                                    <div class="metric-label">CVSS v3.0</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">{{ report.content.cvss_analysis.versions.v3_1 or 0 }}</div>
                                    <div class="metric-label">CVSS v3.1</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value">{{ report.content.cvss_analysis.versions.v4_0 or 0 }}</div>
                                    <div class="metric-label">CVSS v4.0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if report.content.cvss_analysis.ranges and report.content.cvss_analysis.ranges|length > 0 %}
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>Distribuição por Faixas de Score</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Faixa</th>
                                        <th class="text-end">Quantidade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in report.content.cvss_analysis.ranges %}
                                    <tr>
                                        <td>{{ item.range }}</td>
                                        <td class="text-end">{{ item.count }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Análise de Vulnerabilidades -->
        {% if report.content.vulnerabilities %}
        <div class="section-card" id="vulnerabilities">
            <div class="section-header">
                <h3 class="mb-0">
                    <i class="bi bi-shield-exclamation me-2"></i>
                    Análise de Vulnerabilidades
                </h3>
            </div>
            <div class="section-content">
                <!-- Resumo de Vulnerabilidades -->
                {% if report.content.vulnerabilities.summary %}
                    <div class="row mb-4">
                        {% for severity, count in report.content.vulnerabilities.summary.items() %}
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value text-{{ 'danger' if severity == 'critical' else 'warning' if severity == 'high' else 'info' if severity == 'medium' else 'success' }}">
                                        {{ count }}
                                    </div>
                                    <div class="metric-label">{{ severity.title() }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Lista de Vulnerabilidades -->
                {% if report.content.vulnerabilities.details %}
                    <h5>Vulnerabilidades Identificadas</h5>
                    {% for vuln in report.content.vulnerabilities.details %}
                        <div class="vulnerability-item {{ vuln.severity }}">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>{{ vuln.title or vuln.cve_id }}</h6>
                                    <p class="mb-2">{{ vuln.description[:200] }}{% if vuln.description|length > 200 %}...{% endif %}</p>
                                    {% if vuln.affected_assets %}
                                        <small class="text-muted">
                                            <strong>Ativos Afetados:</strong> {{ vuln.affected_assets | length }}
                                        </small>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-{{ 'danger' if vuln.severity == 'critical' else 'warning' if vuln.severity == 'high' else 'info' if vuln.severity == 'medium' else 'success' }}">
                                        {{ vuln.severity.title() }}
                                    </span>
                                    {% if vuln.cvss_score %}
                                        <div class="mt-2">
                                            <small class="text-muted">CVSS: {{ vuln.cvss_score }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Análise de Impacto nos Negócios (BIA) -->
        {% if report.content.bia_analysis %}
        <div class="section-card" id="bia-analysis">
            <div class="section-header">
                <h3 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    Análise de Impacto nos Negócios
                </h3>
            </div>
            <div class="section-content">
                {% if report.content.bia_analysis.ai_generated %}
                    <div class="ai-analysis">
                        <h5>
                            <i class="bi bi-robot ai-icon"></i>
                            Análise Inteligente de Impacto
                        </h5>
                        <p>{{ report.content.bia_analysis.content | safe }}</p>
                    </div>
                {% else %}
                    <p>{{ report.content.bia_analysis.content | safe }}</p>
                {% endif %}

                <!-- Ativos Críticos -->
                {% if report.content.bia_analysis.critical_assets %}
                    <h5 class="mt-4">Ativos Críticos</h5>
                    <div class="row">
                        {% for asset in report.content.bia_analysis.critical_assets %}
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ asset.name }}</h6>
                                        <p class="card-text small">{{ asset.description }}</p>
                                        <div class="d-flex justify-content-between">
                                            <span class="badge bg-{{ 'danger' if asset.risk_level == 'high' else 'warning' if asset.risk_level == 'medium' else 'success' }}">
                                                Risco {{ asset.risk_level.title() }}
                                            </span>
                                            <small class="text-muted">Impacto: {{ asset.business_impact }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Plano de Remediação -->
        {% if report.content.remediation_plan %}
        <div class="section-card" id="remediation-plan">
            <div class="section-header">
                <h3 class="mb-0">
                    <i class="bi bi-tools me-2"></i>
                    Plano de Remediação
                </h3>
            </div>
            <div class="section-content">
                {% if report.content.remediation_plan.ai_generated %}
                    <div class="ai-analysis">
                        <h5>
                            <i class="bi bi-robot ai-icon"></i>
                            Recomendações Inteligentes
                        </h5>
                        <p>{{ report.content.remediation_plan.content | safe }}</p>
                    </div>
                {% else %}
                    <p>{{ report.content.remediation_plan.content | safe }}</p>
                {% endif %}

                <!-- Timeline de Ações -->
                {% if report.content.remediation_plan.actions %}
                    <h5 class="mt-4">Cronograma de Ações</h5>
                    <div class="timeline">
                        {% for action in report.content.remediation_plan.actions %}
                            <div class="timeline-item">
                                <h6>{{ action.title }}</h6>
                                <p>{{ action.description }}</p>
                                <div class="d-flex justify-content-between">
                                    <span class="badge bg-{{ 'danger' if action.priority == 'high' else 'warning' if action.priority == 'medium' else 'success' }}">
                                        Prioridade {{ action.priority.title() }}
                                    </span>
                                    <small class="text-muted">Prazo: {{ action.deadline }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Análise Técnica -->
        {% if report.content.technical_analysis %}
        <div class="section-card" id="technical-analysis">
            <div class="section-header">
                <h3 class="mb-0">
                    <i class="bi bi-code-slash me-2"></i>
                    Análise Técnica
                </h3>
            </div>
            <div class="section-content">
                {{ report.content.technical_analysis.content | safe }}
            </div>
        </div>
        {% endif %}

        <!-- Estudo Técnico (IA) -->
        {% if report.ai_analysis and report.ai_analysis.technical_study %}
        <div class="section-card" id="technical-study">
            <div class="section-header">
                <h3 class="mb-0">
                    <i class="bi bi-robot me-2"></i>
                    Estudo Técnico
                </h3>
            </div>
            <div class="section-content">
                {{ (report.ai_analysis.technical_study.markdown or report.ai_analysis.technical_study) | safe }}
            </div>
        </div>
        {% endif %}

    {% elif not report.content and report.status.value == 'gerando' %}
        <!-- Estado de Processamento -->
        <div class="section-card">
            <div class="section-content text-center py-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Processando...</span>
                </div>
                <h4>Relatório em Processamento</h4>
                <p class="text-muted">Seu relatório está sendo gerado. Isso pode levar alguns minutos.</p>
                <div class="progress mx-auto" style="max-width: 400px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: {{ report.progress or 0 }}%">
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Progresso: {{ report.progress or 0 }}%</small>
                </div>
            </div>
        </div>

    {% elif not report.content and report.status.value == 'falhou' %}
        <!-- Estado de Erro -->
        <div class="section-card">
            <div class="section-content text-center py-5">
                <i class="bi bi-exclamation-triangle display-1 text-danger"></i>
                <h4 class="mt-3">Erro na Geração do Relatório</h4>
                <p class="text-muted">Ocorreu um erro durante a geração do relatório.</p>
                {% if report.error_message %}
                    <div class="alert alert-danger mt-3">
                        <strong>Detalhes do erro:</strong> {{ report.error_message }}
                    </div>
                {% endif %}
                <div class="mt-3">
                    <form method="POST" action="{{ url_for('report.regenerate_report', report_id=report.id) }}" 
                          class="d-inline">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Tentar Novamente
                        </button>
                    </form>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Estado Pendente -->
        <div class="section-card">
            <div class="section-content text-center py-5">
                <i class="bi bi-clock display-1 text-warning"></i>
                <h4 class="mt-3">Relatório Pendente</h4>
                <p class="text-muted">Este relatório ainda não foi processado.</p>
            </div>
        </div>
    {% endif %}

    <!-- Índice Flutuante -->
    <div class="floating-toc no-print" id="floatingToc" style="display: none;">
        <h6 class="mb-3">Índice</h6>
        <ul id="tocList">
            <!-- Preenchido via JavaScript -->
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<script nonce="{{ nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    // Lazy loading para gráficos
    if ('IntersectionObserver' in window) {
        const chartObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    const container = entry.target;
                    if (container.dataset.lazy === 'chart') {
                        loadChartLazy(container);
                        chartObserver.unobserve(container);
                    }
                }
            });
        }, {
            rootMargin: '50px' // Carregar quando estiver 50px antes de aparecer
        });
        
        // Observar todos os containers de gráficos
        document.querySelectorAll('[data-lazy="chart"]').forEach(function(container) {
            chartObserver.observe(container);
        });
    } else {
        // Fallback para navegadores sem suporte ao Intersection Observer
        {% if report.content and report.content.charts %}
            {% for chart in report.content.charts %}
                setTimeout(function() {
                    const container = document.querySelector('[data-chart-id="chart-{{ loop.index }}"]');
                    if (container) {
                        loadChartLazy(container);
                    }
                }, {{ loop.index0 * 200 }}); // Carregar com delay escalonado
            {% endfor %}
        {% endif %}
    }
    
    // Gerar índice flutuante
    generateFloatingToc();
    
    // Auto-refresh para relatórios em processamento
    {% if report.status.value == 'gerando' %}
        setTimeout(function() {
            location.reload();
        }, 30000); // Refresh a cada 30 segundos
    {% endif %}
});

function generateChart(canvasId, chartData, chartType) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    
    const config = {
        type: chartType,
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: chartType !== 'pie' && chartType !== 'doughnut' ? {
                y: {
                    beginAtZero: true
                }
            } : {}
        }
    };
    
    new Chart(ctx, config);
}

function loadChartLazy(container) {
    const chartId = container.dataset.chartId;
    const chartData = JSON.parse(container.dataset.chartData);
    const chartType = container.dataset.chartType;
    const placeholder = container.querySelector('.chart-placeholder');
    const canvas = container.querySelector('canvas');
    
    // Simular delay de carregamento para mostrar o placeholder
    setTimeout(function() {
        try {
            // Mostrar o canvas e gerar o gráfico
            canvas.classList.remove('d-none');
            generateChart(chartId, chartData, chartType);
            
            // Fade out do placeholder
            placeholder.classList.add('fade-out');
            
            // Remover placeholder após a transição
            setTimeout(function() {
                placeholder.remove();
            }, 300);
            
        } catch (error) {
            console.error('Erro ao carregar gráfico:', error);
            placeholder.innerHTML = '<div class="text-center text-danger"><i class="bi bi-exclamation-triangle"></i><br>Erro ao carregar gráfico</div>';
        }
    }, 500); // Delay para mostrar o loading
}

function generateFloatingToc() {
    const sections = document.querySelectorAll('.section-card[id]');
    if (sections.length === 0) return;
    
    const tocList = document.getElementById('tocList');
    const floatingToc = document.getElementById('floatingToc');
    
    sections.forEach(section => {
        const title = section.querySelector('.section-header h3');
        if (title) {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + section.id;
            a.textContent = title.textContent.trim();
            a.addEventListener('click', function(e) {
                e.preventDefault();
                section.scrollIntoView({ behavior: 'smooth' });
            });
            li.appendChild(a);
            tocList.appendChild(li);
        }
    });
    
    if (tocList.children.length > 0) {
        floatingToc.style.display = 'block';
        
        // Highlight ativo baseado no scroll
        window.addEventListener('scroll', function() {
            let current = '';
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 100) {
                    current = section.id;
                }
            });
            
            tocList.querySelectorAll('a').forEach(a => {
                a.classList.remove('active');
                if (a.getAttribute('href') === '#' + current) {
                    a.classList.add('active');
                }
            });
        });
    }
}

// Função para imprimir apenas o conteúdo do relatório
function printReport() {
    const printContent = document.querySelector('.container-fluid').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    location.reload();
}
</script>
{% endblock %}
