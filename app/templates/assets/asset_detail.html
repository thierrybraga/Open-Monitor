{% extends 'core/base.html' %}

{% block title %}Detalhes do Ativo{% endblock %}

{% block extra_css %}
  {# Removido: CSS de página já importado via main.css #}
{% endblock %}

{% block content %}
<div class="container-fluid py-4 fade-in">
  {% import 'core/asset_macros.html' as assetui %}
  {% import 'core/macros.html' as ui %}
  <!-- Page Header -->
  <header class="page-header mb-5">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div>
        <h1 class="h3 fw-semibold mb-2">
          <i class="bi bi-server me-2 text-primary"></i>
          Detalhes do Ativo
        </h1>
        <p class="text-muted fs-6 mb-0">
          Informações completas do ativo selecionado
        </p>
      </div>
      <div class="d-flex gap-2">
        {% if asset %}
          <a href="{{ url_for('asset.edit_asset', asset_id=asset.id) }}" class="btn btn-warning">
            <i class="bi bi-pencil me-1"></i>Editar
          </a>
        {% endif %}
        <a href="{{ url_for('asset.list_assets') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Voltar à Lista
        </a>
      </div>
    </div>
  </header>

  {% if asset %}
    <div class="row">
      <!-- Asset Information Card -->
      <div class="col-lg-8">
        <div class="asset-detail-card mb-4">
          <div class="asset-detail-header">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
              <div class="d-flex align-items-center">
                <div class="asset-icon me-3">
                  <i class="bi bi-server" style="font-size: 2.5rem; color: #0d6efd;"></i>
                </div>
                <div>
                  <h2 class="h4 fw-bold mb-1">{{ asset.name }}</h2>
                  {% if asset.hostname_safe %}
                    <p class="text-muted mb-0">
                      <i class="bi bi-pc-display me-1"></i>{{ asset.hostname_safe }}
                    </p>
                  {% endif %}
                </div>
              </div>
              <div class="text-end">
                {{ assetui.status_badge(asset.status) }}
                {% if asset.created_at_safe %}
                  <div class="text-muted mt-2">
                    <small>
                      <i class="bi bi-calendar-plus me-1"></i>
                      Cadastrado em {{ asset.created_at_safe|datetimeformat('%d/%m/%Y às %H:%M') }}
                    </small>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="asset-detail-body">
            <h3 class="h5 fw-semibold mb-4">
              <i class="bi bi-info-circle me-2"></i>
              Informações Gerais
            </h3>
            
            <!-- Grid de informações em cards -->
            <div class="row g-3 detail-info-grid">
              <div class="col-sm-6 col-lg-4">
                <div class="info-card p-3 bg-light rounded-3 h-100">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-diagram-3 fs-5 text-primary me-2"></i>
                    <div>
                      <small class="text-muted d-block">Tipo</small>
            <span class="fw-semibold">{{ assetui.type_badge(asset.asset_type_safe) }}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-4">
                <div class="info-card p-3 bg-light rounded-3 h-100">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-router fs-5 text-primary me-2"></i>
                      <div>
                        <small class="text-muted d-block">Endereço IP</small>
                        <code class="text-primary">{{ asset.ip_address }}</code>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Copiar IP" onclick="copyText('{{ asset.ip_address }}')">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-4">
                <div class="info-card p-3 bg-light rounded-3 h-100">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-building fs-5 text-primary me-2"></i>
                      <div>
                        <small class="text-muted d-block">Fornecedor</small>
                        <span class="fw-semibold">{{ assetui.vendor_badge(asset.vendor.name if asset.vendor else None) }}</span>
                      </div>
                    </div>
                    <a href="{{ url_for('asset.edit_asset', asset_id=asset.id) }}#vendor_name" class="btn btn-link btn-sm p-0" data-bs-toggle="tooltip" title="Selecionar fornecedor">
                      Selecionar
                    </a>
                  </div>
                </div>
              </div>
              {% if asset.vendor %}
              <style>
                .info-card form[action*="link-product"]{display:none!important}
              </style>
              <div class="col-sm-6 col-lg-4">
                <div class="info-card p-3 bg-light rounded-3 h-100">
                  <div class="d-flex align-items-start justify-content-between">
                    <div class="flex-grow-1">
                      <small class="text-muted d-block">Produto do fornecedor</small>
                      <div class="mt-1">
                        <span class="badge bg-primary" title="Total de produtos deste fornecedor">
                          {{ vendor_product_count if vendor_product_count is not none else 0 }}
                        </span>
                      </div>
                      
                    </div>
                    <i class="bi bi-boxes fs-5 text-primary ms-2"></i>
                  </div>
                </div>
              </div>
              {% endif %}
              <!-- Produtos vinculados: sempre visível -->
              <div class="col-sm-6 col-lg-4">
                <div class="info-card p-3 bg-light rounded-3 h-100">
                  <div class="d-flex align-items-start justify-content-between">
                    <div class="flex-grow-1">
                      <small class="text-muted d-block">Produtos vinculados</small>
                      {% if asset_products_safe %}
                        <ul class="mb-0 ps-3">
                          {% for ap in asset_products_safe %}
                            <li>
                              {{ ap.product.name if ap.product else 'Produto ID ' ~ ap.product_id }}
                              {% if ap.installed_version %}
                                <span class="text-muted">(versão {{ ap.installed_version }})</span>
                              {% endif %}
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <span class="text-muted">Nenhum produto vinculado</span>
                      {% endif %}
                    </div>
                    <i class="bi bi-box-seam fs-5 text-primary ms-2"></i>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-4">
                <div class="info-card p-3 bg-light rounded-3 h-100">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-geo-alt fs-5 text-primary me-2"></i>
                    <div>
                      <small class="text-muted d-block">Localização</small>
                      <span class="fw-semibold">{{ asset.location_safe or 'Não informado' }}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-4">
                <div class="info-card p-3 bg-light rounded-3 h-100">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-person fs-5 text-primary me-2"></i>
                    <div>
                      <small class="text-muted d-block">Proprietário</small>
                      <span class="fw-semibold">
                        {% if asset.owner %}
                          <i class="bi bi-person-circle text-primary me-1"></i>
                          {{ asset.owner.username }}
                          {% if asset.owner.first_name or asset.owner.last_name %}
                            ({{ asset.owner.first_name }} {{ asset.owner.last_name }})
                          {% endif %}
                        {% else %}
                          <span class="text-muted">Não atribuído</span>
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 col-lg-4">
                <div class="info-card p-3 bg-light rounded-3 h-100">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-activity fs-5 text-primary me-2"></i>
                    <div>
                      <small class="text-muted d-block">Status</small>
                {{ assetui.status_badge(asset.status) }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            {% if asset.description_safe %}
            <div class="mt-4">
              <h3 class="h5 fw-semibold mb-3">
                <i class="bi bi-file-text me-2"></i>
                Descrição
              </h3>
              <div class="p-3 bg-light rounded-3">
                <p class="mb-0">{{ asset.description_safe }}</p>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        <!-- Vulnerabilidades do Ativo -->
        <div class="asset-card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="h5 fw-semibold mb-0">
              <i class="bi bi-shield-exclamation me-2"></i>
              Vulnerabilidades
            </h3>
            <a href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}?asset_id={{ asset.id }}{% if asset.vendor %}&vendor_ids={{ asset.vendor.id }}{% endif %}" class="btn btn-sm btn-outline-secondary" title="Abrir lista com contexto do ativo">
              <i class="bi bi-box-arrow-up-right me-1"></i>Ver Todas
            </a>
          </div>
          <div class="card-body">
            <!-- Barra de filtros e visualização -->
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
              <div class="btn-group btn-group-sm" role="group" aria-label="Filtro Severidade">
                <button type="button" class="btn btn-outline-secondary active" data-filter="ALL" aria-label="Filtro: Todas ({{ vuln_pagination.total if vuln_pagination else 0 }})">
                  Todas
                  <span class="badge bg-primary ms-2">{{ vuln_pagination.total if vuln_pagination else 0 }}</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-filter="CRITICAL" aria-label="Filtro: Críticas ({{ (severity_counts.critical if severity_counts else 0) }})">
                  Críticas
                  <span class="badge bg-danger ms-2">{{ (severity_counts.critical if severity_counts else 0) }}</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-filter="HIGH" aria-label="Filtro: Altas ({{ (severity_counts.high if severity_counts else 0) }})">
                  Altas
                  <span class="badge bg-warning text-dark ms-2">{{ (severity_counts.high if severity_counts else 0) }}</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-filter="MEDIUM" aria-label="Filtro: Médias ({{ (severity_counts.medium if severity_counts else 0) }})">
                  Médias
                  <span class="badge bg-info text-dark ms-2">{{ (severity_counts.medium if severity_counts else 0) }}</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" data-filter="LOW" aria-label="Filtro: Baixas ({{ (severity_counts.low if severity_counts else 0) }})">
                  Baixas
                  <span class="badge bg-success ms-2">{{ (severity_counts.low if severity_counts else 0) }}</span>
                </button>
              </div>
              <div class="btn-group btn-group-sm" role="group" aria-label="Visualização">
                <button type="button" class="btn btn-outline-secondary active" data-view="cards" aria-controls="vuln-cards-container" aria-pressed="true">Cards</button>
                <button type="button" class="btn btn-outline-secondary" data-view="table" aria-controls="vuln-table-container" aria-pressed="false">Tabela</button>
              </div>
            </div>
            

            <div class="row g-3 mb-3">
              <div class="col-6 col-md-3">
                <div class="text-center p-3 bg-light rounded-3">
                  <div class="h5 fw-bold text-danger mb-1">{{ (severity_counts.critical if severity_counts else 0) }}</div>
                  <small class="text-muted">Críticas</small>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="text-center p-3 bg-light rounded-3">
                  <div class="h5 fw-bold text-warning mb-1">{{ (severity_counts.high if severity_counts else 0) }}</div>
                  <small class="text-muted">Altas</small>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="text-center p-3 bg-light rounded-3">
                  <div class="h5 fw-bold text-info mb-1">{{ (severity_counts.medium if severity_counts else 0) }}</div>
                  <small class="text-muted">Médias</small>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="text-center p-3 bg-light rounded-3">
                  <div class="h5 fw-bold text-success mb-1">{{ (severity_counts.low if severity_counts else 0) }}</div>
                  <small class="text-muted">Baixas</small>
                </div>
              </div>
            </div>

            {% if vuln_pagination and vuln_pagination.total > 0 %}
            <div id="vuln-cards-container" class="row g-3">
              {% for av in vuln_pagination.items %}
                {% set vuln = av.vulnerability if av.vulnerability else av %}
                {% set sev = (vuln.base_severity|upper if vuln else 'UNKNOWN') %}
                <div class="col-12 col-md-6 col-lg-4" data-severity="{{ sev|upper }}">
                <div class="vuln-card p-3 h-100 bg-light rounded-3 border">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    {% if vuln %}
                      <a href="{{ url_for('vulnerability_ui.vulnerability_details', cve_id=vuln.cve_id) }}" class="fw-semibold text-decoration-none">{{ vuln.cve_id }}</a>
                    {% else %}
                      <span class="text-muted">N/A</span>
                    {% endif %}
                    <span class="badge {% if sev == 'CRITICAL' %}bg-danger{% elif sev == 'HIGH' %}bg-warning{% elif sev == 'MEDIUM' %}bg-info text-dark{% elif sev == 'LOW' %}bg-success{% else %}bg-secondary{% endif %}">{{ sev }}</span>
                  </div>
                  <p class="text-muted mb-3">
                    {% if vuln and vuln.description %}
                      {{ vuln.description[:140] }}{% if vuln.description|length > 140 %}...{% endif %}
                    {% else %}
                      Sem descrição
                    {% endif %}
                  </p>
                  <div class="d-flex justify-content-between align-items-center">
                    {% set status_label = av.status if av.status else 'Sem vínculo direto' %}
                    <span class="badge {% if status_label == 'OPEN' %}bg-danger{% elif status_label == 'MITIGATED' %}bg-info text-dark{% elif status_label == 'CLOSED' %}bg-success{% else %}bg-secondary{% endif %}">{{ status_label }}</span>
                    {% if vuln %}
                      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('vulnerability_ui.vulnerability_details', cve_id=vuln.cve_id) }}">Detalhes</a>
                    {% else %}
                      <button class="btn btn-sm btn-outline-secondary" disabled>Detalhes</button>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            <div id="vuln-table-container" class="table-responsive d-none">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width: 15%">CVE</th>
                    <th>Descrição</th>
                    <th style="width: 10%">Severidade</th>
                    <th style="width: 10%">Vínculo</th>
                  </tr>
                </thead>
                <tbody>
                  {% if vuln_pagination and vuln_pagination.total > 0 %}
                    {% for av in vuln_pagination.items %}
                      {% set vuln = av.vulnerability if av.vulnerability else av %}
                      {% set sev = (vuln.base_severity|upper if vuln else 'UNKNOWN') %}
                      <tr data-severity="{{ sev|upper }}">
                        <td>
                          {% if vuln %}
                            <a href="{{ url_for('vulnerability_ui.vulnerability_details', cve_id=vuln.cve_id) }}" class="text-decoration-none">{{ vuln.cve_id }}</a>
                          {% else %}
                            <span class="text-muted">N/A</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if vuln and vuln.description %}
                            {{ vuln.description[:140] }}{% if vuln.description|length > 140 %}...{% endif %}
                          {% else %}
                            <span class="text-muted">Sem descrição</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if vuln and vuln.base_severity %}
                            <span class="badge {% if sev == 'CRITICAL' %}bg-danger{% elif sev == 'HIGH' %}bg-warning{% elif sev == 'MEDIUM' %}bg-info text-dark{% elif sev == 'LOW' %}bg-success{% else %}bg-secondary{% endif %}">{{ sev }}</span>
                          {% else %}
                            <span class="badge bg-secondary">N/A</span>
                          {% endif %}
                        </td>
                        <td>
                          {% set status_label = av.status if av.status else 'Sem vínculo direto' %}
                          <span class="badge {% if status_label == 'OPEN' %}bg-danger{% elif status_label == 'MITIGATED' %}bg-info text-dark{% elif status_label == 'CLOSED' %}bg-success{% else %}bg-secondary{% endif %}">{{ status_label }}</span>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="4"><span class="text-muted">Sem dados</span></td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
            {% if vuln_pagination %}
            <div class="pagination-section mt-3">
              {{ ui.render_pagination(vuln_pagination, 'asset.asset_detail', variant='minimal', extra_params={'asset_id': asset.id}) }}
            </div>
            {% endif %}

            
            {% else %}
              <div class="p-4 bg-light rounded-3 border d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <i class="bi bi-shield-exclamation fs-4 text-muted me-3" aria-hidden="true"></i>
                  <div>
                    <div class="fw-semibold">Nenhuma vulnerabilidade encontrada para este ativo</div>
                    <small class="text-muted">Você pode sincronizar vulnerabilidades conforme o fornecedor do ativo.</small>
                  </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#syncAssetVulnerabilitiesModal" data-vendor-id="{{ asset.vendor.id if asset.vendor else '' }}" {% if not asset.vendor %}disabled title="Selecione um fornecedor para sincronizar"{% endif %}>
                  <i class="bi bi-arrow-repeat me-1"></i>Sincronizar
                </button>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- Quick Actions Sidebar -->
      <div class="col-lg-4">
        <div class="asset-card">
          <div class="card-header">
            <h3 class="h5 fw-semibold mb-0">
              <i class="bi bi-lightning me-2"></i>
              Ações Rápidas
            </h3>
          </div>
          <div class="card-body">
            <div class="d-grid gap-3">
              <a href="{{ url_for('asset.edit_asset', asset_id=asset.id) }}" class="btn btn-warning">
                <i class="bi bi-pencil me-2"></i>
                Editar Ativo
              </a>
              
              <button type="button" class="btn btn-outline-primary" id="ping-btn" data-asset-id="{{ asset.id }}" data-ip="{{ asset.ip_address }}" onclick="pingAsset()">
                <i class="bi bi-wifi me-2"></i>
                <span class="btn-text">Testar Conectividade</span>
                <span class="btn-loading d-none">
                  <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                  Testando...
                </span>
              </button>
              
              <button type="button" class="btn btn-outline-info" id="scan-btn" data-asset-id="{{ asset.id }}" data-ip="{{ asset.ip_address }}" onclick="scanPorts()">
                <i class="bi bi-search me-2"></i>
                <span class="btn-text">Escanear Portas</span>
                <span class="btn-loading d-none">
                  <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                  Escaneando...
                </span>
              </button>

              <button type="button" class="btn btn-outline-success" id="sync-btn" onclick="syncVulnerabilities({{ asset.id }})" data-vendor-id="{{ asset.vendor.id if asset.vendor else '' }}" {% if not asset.vendor %}disabled data-bs-toggle="tooltip" title="Selecione um fornecedor para sincronizar"{% endif %}>
                <i class="bi bi-arrow-repeat me-2"></i>
                <span class="btn-text">Sincronizar Vulnerabilidades</span>
                <span class="btn-loading d-none">
                  <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                  Sincronizando...
                </span>
              </button>
              
              <hr>
              
              <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAssetModal">
                <i class="bi bi-trash me-2"></i>
                Excluir Ativo
              </button>
            </div>
          </div>
        </div>
        
        <!-- Asset Statistics -->
        <div class="asset-card mt-4">
          <div class="asset-card-header">
            <h3 class="h5 fw-semibold mb-0">Estatísticas do Ativo</h3>
          </div>
          <div class="asset-card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <div class="stat-tile">
                  <div class="stat-value">{{ vuln_count }}</div>
                  <div class="stat-label">Vulnerabilidades</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-tile">
                  <div class="stat-value">{{ 'Sim' if asset.ip_address else 'Não' }}</div>
                  <div class="stat-label">IP configurado</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-tile">
                  <div class="stat-value">{{ asset.status|capitalize if asset.status else 'N/A' }}</div>
                  <div class="stat-label">Status</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="asset-card text-center py-5">
      <div class="mb-4">
        <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #ffc107;"></i>
      </div>
      <h3 class="h5 fw-semibold mb-3">Ativo não encontrado</h3>
      <p class="text-muted mb-4">
        O ativo solicitado não existe ou foi removido do sistema.
      </p>
      <a href="{{ url_for('asset.list_assets') }}" class="btn btn-primary">
        <i class="bi bi-arrow-left me-2"></i>Voltar à Lista de Ativos
      </a>
    </div>
{% endif %}
</div>

<!-- Delete Confirmation Modal -->
{% if asset %}
<div class="modal fade" id="deleteAssetModal" tabindex="-1" aria-labelledby="deleteAssetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-semibold" id="deleteAssetModalLabel">
          <i class="bi bi-exclamation-triangle text-warning me-2"></i>
          Confirmar Exclusão
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Tem certeza que deseja excluir o ativo <strong>{{ asset.name }}</strong>?</p>
        <div class="alert alert-warning d-flex align-items-center" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <div>Esta ação não pode ser desfeita e removerá todas as informações relacionadas ao ativo.</div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Cancelar
        </button>
        <form method="POST" id="delete-asset-form-detail" action="{{ url_for('asset.delete_asset', asset_id=asset.id) }}" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger" id="delete-asset-btn">
            <i class="bi bi-trash me-1"></i>
            <span class="btn-text">Excluir Ativo</span>
            <span class="btn-loading d-none">
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              Excluindo...
            </span>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if asset %}
<!-- Sync Asset Vulnerabilities Modal -->
<div class="modal fade" id="syncAssetVulnerabilitiesModal" tabindex="-1" aria-labelledby="syncAssetVulnerabilitiesModalLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-semibold" id="syncAssetVulnerabilitiesModalLabel">
          <i class="bi bi-arrow-repeat text-primary me-2"></i>
          Sincronizar Vulnerabilidades do Ativo
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Essa ação irá associar vulnerabilidades conhecidas ao fornecedor do ativo <strong>{{ asset.name }}</strong>.</p>
        <ul class="text-muted mb-0">
          <li>O ativo precisa ter um fornecedor cadastrado.</li>
          <li>Novas associações serão criadas conforme CVEs do fornecedor.</li>
        </ul>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-success" onclick="confirmSyncAssetVulnerabilities({{ asset.id }}, {{ asset.vendor.id if asset.vendor else 'null' }})" {% if not asset.vendor %}disabled data-bs-toggle="tooltip" title="Selecione um fornecedor primeiro"{% endif %}>
          <i class="bi bi-arrow-repeat me-1"></i>
          Sincronizar
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Toast for Feedback -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="feedback-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="bi bi-info-circle-fill text-info me-2"></i>
      <strong class="me-auto">Informação</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      Operação realizada com sucesso!
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ nonce }}">
// Asset detail functionality
  (function() {
    'use strict';
    function getCsrfToken(){ var m=document.querySelector('meta[name="csrf-token"]'); return m?m.getAttribute('content'):'' }
  
  // Tooltips são inicializados globalmente em base.js

  // Exclusão via AJAX com toast e redirecionamento
  (function setupAjaxDelete() {
    var deleteForm = document.getElementById('delete-asset-form-detail');
    var deleteModalEl = document.getElementById('deleteAssetModal');
    var getModalSafely = (typeof window.getModalInstance === 'function')
      ? window.getModalInstance
      : function(el, options) {
          if (!el) return null;
          try {
            if (typeof window.bootstrap !== 'undefined' && bootstrap.Modal) {
              return bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el, options);
            }
          } catch (e) {
            try { console.warn('Bootstrap Modal init failed:', e); } catch(_){}
          }
          return {
            show: function() {
              el.classList.add('show');
              el.style.display = 'block';
              document.body.classList.add('modal-open');
            },
            hide: function() {
              el.classList.remove('show');
              el.style.display = 'none';
              document.body.classList.remove('modal-open');
              var backs = document.querySelectorAll('.modal-backdrop');
              Array.prototype.forEach.call(backs, function(b){ if (b && b.parentNode) b.parentNode.removeChild(b); });
            }
          };
        };
    var deleteModal = getModalSafely(deleteModalEl);
    var assetsListUrl = "{{ url_for('asset.list_assets') }}";

    if (!deleteForm) return;

    deleteForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      var submitBtn = document.getElementById('delete-asset-btn');
      if (submitBtn) {
        submitBtn.disabled = true;
        var btnTextEl = submitBtn.querySelector('.btn-text');
        var btnLoadEl = submitBtn.querySelector('.btn-loading');
        if (btnTextEl) btnTextEl.classList.add('d-none');
        if (btnLoadEl) btnLoadEl.classList.remove('d-none');
      }

      try {
        var formData = new FormData(deleteForm);
        var csrfMeta = document.querySelector('meta[name="csrf-token"]');
        var csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';
        var res = await fetch(deleteForm.action, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRF-Token': csrfToken,
            'X-CSRFToken': csrfToken
          },
          body: formData
        });

        var contentType = (res.headers.get('content-type') || '').toLowerCase();
        var isJson = contentType.indexOf('application/json') !== -1;
        var data = isJson ? (await res.json().catch(function(){ return {}; })) : {};
        if (!res.ok) {
          throw new Error(data.message || ('Falha ao excluir ativo (status ' + res.status + ')'));
        }

        // Fechar modal
        if (deleteModal && deleteModal.hide) { deleteModal.hide(); }

        // Mostrar toast de sucesso
        if (typeof window.safeNotify === 'function') {
          window.safeNotify('success', null, 'Ativo removido com sucesso.', 2000);
        } else {
          var toastEl = document.getElementById('feedback-toast');
          var toastInst = (typeof window.getToastInstance === 'function') ? window.getToastInstance(toastEl, { delay: 2000 }) : null;
          var toastIcon = document.querySelector('#feedback-toast .toast-header i');
          var toastTitle = document.querySelector('#feedback-toast .toast-header strong');
          var toastBody = document.querySelector('#feedback-toast .toast-body');
          if (toastIcon) toastIcon.className = 'bi bi-check-circle-fill text-success me-2';
          if (toastTitle) toastTitle.textContent = 'Excluído';
          if (toastBody) toastBody.textContent = 'Ativo removido com sucesso.';
          if (toastInst && toastInst.show) toastInst.show();
        }

        // Redirecionar para a lista após breve atraso
        setTimeout(function() { window.location.href = assetsListUrl; }, 1200);

      } catch (err) {
        if (typeof window.safeNotify === 'function') {
          window.safeNotify('error', null, (err && err.message) ? err.message : 'Erro ao excluir ativo.', 5000);
        } else {
          var toastEl2 = document.getElementById('feedback-toast');
          var toast2 = (typeof window.getToastInstance === 'function') ? window.getToastInstance(toastEl2, { delay: 5000 }) : null;
          var toastIcon2 = document.querySelector('#feedback-toast .toast-header i');
          var toastTitle2 = document.querySelector('#feedback-toast .toast-header strong');
          var toastBody2 = document.querySelector('#feedback-toast .toast-body');
          if (toastIcon2) toastIcon2.className = 'bi bi-exclamation-triangle text-warning me-2';
          if (toastTitle2) toastTitle2.textContent = 'Erro';
          if (toastBody2) toastBody2.textContent = (err && err.message) ? err.message : 'Erro ao excluir ativo.';
          if (toast2 && toast2.show) toast2.show();
        }
      } finally {
        if (submitBtn) {
          var btnLoadEl2 = submitBtn.querySelector('.btn-loading');
          var btnTextEl2 = submitBtn.querySelector('.btn-text');
          if (btnLoadEl2) btnLoadEl2.classList.add('d-none');
          if (btnTextEl2) btnTextEl2.classList.remove('d-none');
          submitBtn.disabled = false;
        }
      }
    });
  })();
  

  // Utilitário: copiar texto para clipboard com feedback
  window.copyText = function(text) {
    if (typeof window.safeNotify === 'function') {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => window.safeNotify('success', null, 'Valor copiado para a área de transferência.', 3000))
          .catch(() => window.safeNotify('warning', null, 'Não foi possível copiar automaticamente.', 4000));
      } else {
        const tmp = document.createElement('textarea');
        tmp.value = text;
        document.body.appendChild(tmp);
        tmp.select();
        try {
          document.execCommand('copy');
          window.safeNotify('success', null, 'Valor copiado para a área de transferência.', 3000);
        } catch (e) {
          window.safeNotify('warning', null, 'Não foi possível copiar automaticamente.', 4000);
        }
        document.body.removeChild(tmp);
      }
      return;
    }

    // Fallback para implementação antiga baseada no #feedback-toast
    const toast = window.getToastInstance(document.getElementById('feedback-toast'));
    const toastBody = document.querySelector('#feedback-toast .toast-body');
    const toastIcon = document.querySelector('#feedback-toast .toast-header i');
    const toastTitle = document.querySelector('#feedback-toast .toast-header strong');

    function successFeedback() {
      toastIcon.className = 'bi bi-clipboard-check text-success me-2';
      toastTitle.textContent = 'Copiado';
      toastBody.textContent = 'Valor copiado para a área de transferência.';
      toast.show();
    }

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(successFeedback).catch(() => {
        toastIcon.className = 'bi bi-exclamation-triangle text-warning me-2';
        toastTitle.textContent = 'Aviso';
        toastBody.textContent = 'Não foi possível copiar automaticamente.';
        toast.show();
      });
    } else {
      // Fallback
      const tmp = document.createElement('textarea');
      tmp.value = text;
      document.body.appendChild(tmp);
      tmp.select();
      try { document.execCommand('copy'); successFeedback(); }
      catch (e) {
        toastIcon.className = 'bi bi-exclamation-triangle text-warning me-2';
        toastTitle.textContent = 'Aviso';
        toastBody.textContent = 'Não foi possível copiar automaticamente.';
        toast.show();
      }
      document.body.removeChild(tmp);
    }
  };
  
  window.pingAsset = function() {
    var btn = document.getElementById('ping-btn');
    var assetId = btn ? btn.getAttribute('data-asset-id') : '';
    var ip = btn ? btn.getAttribute('data-ip') : '';
    if (!assetId) return;
    if (!ip) {
      if (typeof window.safeNotify === 'function') {
        window.safeNotify('warning', 'IP ausente', 'Este ativo não possui IP configurado.', 4000);
      }
      return;
    }
    if (btn) {
      var t = btn.querySelector('.btn-text');
      var l = btn.querySelector('.btn-loading');
      if (t) t.classList.add('d-none');
      if (l) l.classList.remove('d-none');
    }
    fetch(`${window.location.origin}/assets/${assetId}/ping`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({ ip: ip })
    }).then(async function(res) {
      var isJson = ((res.headers.get('content-type') || '').indexOf('application/json') !== -1);
      var data = isJson ? await res.json() : {};
      if (!res.ok) throw new Error(data.message || 'Falha ao testar conectividade.');
      var reachable = !!data.reachable;
      var msg = reachable ? 'Ativo respondeu com sucesso.' : 'Ativo não respondeu.';
      if (typeof window.safeNotify === 'function') {
        window.safeNotify(reachable ? 'success' : 'warning', reachable ? 'Sucesso' : 'Sem resposta', msg, 4000);
      } else {
        var toast = window.getToastInstance(document.getElementById('feedback-toast'));
        var tb = document.querySelector('#feedback-toast .toast-body');
        var ti = document.querySelector('#feedback-toast .toast-header i');
        var tt = document.querySelector('#feedback-toast .toast-header strong');
        if (ti) ti.className = reachable ? 'bi bi-check-circle-fill text-success me-2' : 'bi bi-exclamation-triangle text-warning me-2';
        if (tt) tt.textContent = reachable ? 'Sucesso' : 'Sem resposta';
        if (tb) tb.textContent = msg;
        toast && toast.show && toast.show();
      }
    }).catch(function(err) {
      if (typeof window.safeNotify === 'function') {
        window.safeNotify('error', 'Erro', err.message || 'Falha ao testar conectividade.', 5000);
      } else {
        var toast = window.getToastInstance(document.getElementById('feedback-toast'));
        var tb = document.querySelector('#feedback-toast .toast-body');
        var ti = document.querySelector('#feedback-toast .toast-header i');
        var tt = document.querySelector('#feedback-toast .toast-header strong');
        if (ti) ti.className = 'bi bi-exclamation-triangle text-warning me-2';
        if (tt) tt.textContent = 'Erro';
        if (tb) tb.textContent = err && err.message ? err.message : 'Falha ao testar conectividade.';
        toast && toast.show && toast.show();
      }
    }).finally(function() {
      if (btn) {
        var t = btn.querySelector('.btn-text');
        var l = btn.querySelector('.btn-loading');
        if (l) l.classList.add('d-none');
        if (t) t.classList.remove('d-none');
      }
    });
  };
  
  window.scanPorts = function() {
    var btn = document.getElementById('scan-btn');
    var assetId = btn ? btn.getAttribute('data-asset-id') : '';
    var ip = btn ? btn.getAttribute('data-ip') : '';
    var ports = [22,80,443,53,3389,25,110];
    if (!assetId) return;
    if (!ip) {
      if (typeof window.safeNotify === 'function') {
        window.safeNotify('warning', 'IP ausente', 'Este ativo não possui IP configurado.', 4000);
      }
      return;
    }
    if (btn) {
      var t = btn.querySelector('.btn-text');
      var l = btn.querySelector('.btn-loading');
      if (t) t.classList.add('d-none');
      if (l) l.classList.remove('d-none');
    }
    fetch(`${window.location.origin}/assets/${assetId}/scan_ports`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({ ip: ip, ports: ports })
    }).then(async function(res) {
      var isJson = ((res.headers.get('content-type') || '').indexOf('application/json') !== -1);
      var data = isJson ? await res.json() : {};
      if (!res.ok) throw new Error(data.message || 'Falha ao escanear portas.');
      var openCount = Number(data.open_count || 0);
      var msg = openCount > 0 ? `Foram encontradas ${openCount} portas abertas.` : 'Nenhuma porta aberta encontrada.';
      if (typeof window.safeNotify === 'function') {
        window.safeNotify(openCount > 0 ? 'success' : 'info', openCount > 0 ? 'Concluído' : 'Sem portas abertas', msg, 4500);
      } else {
        var toast = window.getToastInstance(document.getElementById('feedback-toast'));
        var tb = document.querySelector('#feedback-toast .toast-body');
        var ti = document.querySelector('#feedback-toast .toast-header i');
        var tt = document.querySelector('#feedback-toast .toast-header strong');
        if (ti) ti.className = openCount > 0 ? 'bi bi-check-circle-fill text-success me-2' : 'bi bi-info-circle-fill text-info me-2';
        if (tt) tt.textContent = openCount > 0 ? 'Concluído' : 'Sem portas abertas';
        if (tb) tb.textContent = msg;
        toast && toast.show && toast.show();
      }
    }).catch(function(err) {
      if (typeof window.safeNotify === 'function') {
        window.safeNotify('error', 'Erro', err.message || 'Falha ao escanear portas.', 5000);
      } else {
        var toast = window.getToastInstance(document.getElementById('feedback-toast'));
        var tb = document.querySelector('#feedback-toast .toast-body');
        var ti = document.querySelector('#feedback-toast .toast-header i');
        var tt = document.querySelector('#feedback-toast .toast-header strong');
        if (ti) ti.className = 'bi bi-exclamation-triangle text-warning me-2';
        if (tt) tt.textContent = 'Erro';
        if (tb) tb.textContent = err && err.message ? err.message : 'Falha ao escanear portas.';
        toast && toast.show && toast.show();
      }
    }).finally(function() {
      if (btn) {
        var t = btn.querySelector('.btn-text');
        var l = btn.querySelector('.btn-loading');
        if (l) l.classList.add('d-none');
        if (t) t.classList.remove('d-none');
      }
    });
  };
  
  // Sync vulnerabilities functionality
  window.syncVulnerabilities = function(assetId) {
    var btn = document.getElementById('sync-btn');
    var toastInst = (typeof window.getToastInstance === 'function') ? window.getToastInstance(document.getElementById('feedback-toast')) : null;
    var toastBody = document.querySelector('#feedback-toast .toast-body');
    var toastIcon = document.querySelector('#feedback-toast .toast-header i');
    var toastTitle = document.querySelector('#feedback-toast .toast-header strong');

    // Toggle loading state
    if (btn) {
      var t = btn.querySelector('.btn-text');
      var l = btn.querySelector('.btn-loading');
      if (t) t.classList.add('d-none');
      if (l) l.classList.remove('d-none');
    }

    // Verificar fornecedor antes de sincronizar
    var vendorIdAttr = btn ? (btn.getAttribute('data-vendor-id') || '') : '';
    var hasVendor = vendorIdAttr && vendorIdAttr.trim().length > 0;
    if (!hasVendor) {
      if (typeof window.safeNotify === 'function') {
        window.safeNotify('warning', 'Fornecedor ausente', 'Este ativo não possui fornecedor selecionado. Selecione um fornecedor para sincronizar vulnerabilidades.', 5000);
      } else {
        if (toastIcon) toastIcon.className = 'bi bi-exclamation-triangle text-warning me-2';
        if (toastTitle) toastTitle.textContent = 'Fornecedor ausente';
        if (toastBody) toastBody.textContent = 'Este ativo não possui fornecedor selecionado. Selecione um fornecedor para sincronizar vulnerabilidades.';
        if (toastInst && toastInst.show) toastInst.show();
      }
      // Reverter estado de loading
      if (btn) {
        var l2 = btn.querySelector('.btn-loading');
        var t2 = btn.querySelector('.btn-text');
        if (l2) l2.classList.add('d-none');
        if (t2) t2.classList.remove('d-none');
      }
      return;
    }

    fetch(`${window.location.origin}/assets/${assetId}/sync_vulnerabilities`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-Token': getCsrfToken(),
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({})
    })
    .then(async (res) => {
      const isJson = ((res.headers.get('content-type') || '').indexOf('application/json') !== -1);
      const data = isJson ? await res.json() : {};
      if (res.ok && isJson) {
        var createdCount = (typeof data.created === 'number') ? data.created : (data.created || 0);
        if (typeof window.safeNotify === 'function') {
          if (createdCount > 0) {
            window.safeNotify('success', 'Sincronizado', `Foram criadas ${createdCount} associações.`, 4000);
          } else {
            window.safeNotify('info', 'Sem novas associações', 'Nenhuma nova associação foi criada para o fornecedor selecionado.', 4500);
          }
        } else {
          var t2 = (typeof window.getToastInstance === 'function') ? window.getToastInstance(document.getElementById('feedback-toast')) : null;
          var tb2 = document.querySelector('#feedback-toast .toast-body');
          var ti2 = document.querySelector('#feedback-toast .toast-header i');
          var tt2 = document.querySelector('#feedback-toast .toast-header strong');
          if (createdCount > 0) {
            if (ti2) ti2.className = 'bi bi-check-circle-fill text-success me-2';
            if (tt2) tt2.textContent = 'Sincronizado';
            if (tb2) tb2.textContent = 'Foram criadas ' + createdCount + ' associações.';
          } else {
            if (ti2) ti2.className = 'bi bi-info-circle-fill text-info me-2';
            if (tt2) tt2.textContent = 'Sem novas associações';
            if (tb2) tb2.textContent = 'Nenhuma nova associação foi criada para o fornecedor selecionado.';
          }
          if (t2 && t2.show) t2.show();
        }
      } else {
        throw new Error(data.message || 'Falha ao sincronizar vulnerabilidades.');
      }
    })
    .catch(err => {
      if (typeof window.safeNotify === 'function') {
        window.safeNotify('error', 'Erro', err.message || 'Falha ao sincronizar vulnerabilidades.', 5000);
      } else {
        var t3 = (typeof window.getToastInstance === 'function') ? window.getToastInstance(document.getElementById('feedback-toast')) : null;
        var tb3 = document.querySelector('#feedback-toast .toast-body');
        var ti3 = document.querySelector('#feedback-toast .toast-header i');
        var tt3 = document.querySelector('#feedback-toast .toast-header strong');
        if (ti3) ti3.className = 'bi bi-exclamation-triangle text-warning me-2';
        if (tt3) tt3.textContent = 'Erro';
        if (tb3) tb3.textContent = err && err.message ? err.message : 'Falha ao sincronizar vulnerabilidades.';
        if (t3 && t3.show) t3.show();
      }
    })
    .finally(() => {
      if (btn) {
        var l2 = btn.querySelector('.btn-loading');
        var t2 = btn.querySelector('.btn-text');
        if (l2) l2.classList.add('d-none');
        if (t2) t2.classList.remove('d-none');
      }
    });
  };

  // Confirm from modal and hide it before starting sync
  window.confirmSyncAssetVulnerabilities = function(assetId, vendorId) {
    if (!vendorId) {
      // Feedback amigável quando não há fornecedor
      if (typeof window.safeNotify === 'function') {
        window.safeNotify('warning', 'Fornecedor ausente', 'Este ativo não possui fornecedor selecionado. Selecione um fornecedor para sincronizar vulnerabilidades.', 5000);
      } else {
        var toastEl = document.getElementById('feedback-toast');
        var toastInst = (typeof window.getToastInstance === 'function') ? window.getToastInstance(toastEl) : null;
        var toastIcon = document.querySelector('#feedback-toast .toast-header i');
        var toastTitle = document.querySelector('#feedback-toast .toast-header strong');
        var toastBody = document.querySelector('#feedback-toast .toast-body');
        if (toastIcon) toastIcon.className = 'bi bi-exclamation-triangle text-warning me-2';
        if (toastTitle) toastTitle.textContent = 'Fornecedor ausente';
        if (toastBody) toastBody.textContent = 'Este ativo não possui fornecedor selecionado. Selecione um fornecedor para sincronizar vulnerabilidades.';
        if (toastInst && toastInst.show) toastInst.show();
      }
      return;
    }
    const modalEl = document.getElementById('syncAssetVulnerabilitiesModal');
    if (modalEl) {
      const modal = (typeof window.getModalInstance === 'function' ? window.getModalInstance : function(el, options) {
    if (!el) return null;
    try {
      if (typeof window.bootstrap !== 'undefined' && bootstrap.Modal) {
        return bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el, options);
      }
    } catch (e) {
      console.warn('Bootstrap Modal init failed:', e);
    }
    return {
      show() {
        el.classList.add('show');
        el.style.display = 'block';
        document.body.classList.add('modal-open');
      },
      hide() {
        el.classList.remove('show');
        el.style.display = 'none';
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
      }
    };
  })(modalEl);
      modal && modal.hide();
    }
  // Reusar lógica existente
  window.syncVulnerabilities(assetId);
  };
  
  // Filtros e alternância de visualização de vulnerabilidades
  (function setupVulnFilters() {
    var filterButtons = document.querySelectorAll('[aria-label="Filtro Severidade"] button');
    var viewButtons = document.querySelectorAll('[aria-label="Visualização"] button');
    var cardsContainer = document.getElementById('vuln-cards-container');
    var tableContainer = document.getElementById('vuln-table-container');

    if (!cardsContainer || !tableContainer) return;

    var currentFilter = (localStorage.getItem('asset_vuln_filter') || 'ALL');
    var currentView = (localStorage.getItem('asset_vuln_view') || 'cards');

    function applyFilter() {
      var applyTo = currentView === 'cards' ? cardsContainer.querySelectorAll('[data-severity]')
                                            : tableContainer.querySelectorAll('tr[data-severity]');
      Array.prototype.forEach.call(applyTo, function(el){
        var sev = (el.getAttribute('data-severity') || 'UNKNOWN').toUpperCase();
        var show = currentFilter === 'ALL' || sev === currentFilter;
        if (el && el.classList) { el.classList.toggle('d-none', !show); }
      });
    }

    Array.prototype.forEach.call(filterButtons, function(btn){
      btn.addEventListener('click', function() {
        Array.prototype.forEach.call(filterButtons, function(b){ if (b && b.classList) b.classList.remove('active'); });
        if (btn && btn.classList) btn.classList.add('active');
        if (btn) btn.setAttribute('aria-pressed', 'true');
        Array.prototype.forEach.call(filterButtons, function(b){ if (b !== btn) b && b.setAttribute('aria-pressed', 'false'); });
        currentFilter = (btn && btn.dataset && btn.dataset.filter) ? btn.dataset.filter : 'ALL';
        try { localStorage.setItem('asset_vuln_filter', currentFilter); } catch(e){}
        applyFilter();
      });
    });

    Array.prototype.forEach.call(viewButtons, function(btn){
      btn.addEventListener('click', function() {
        Array.prototype.forEach.call(viewButtons, function(b){ if (b && b.classList) b.classList.remove('active'); });
        if (btn && btn.classList) btn.classList.add('active');
        if (btn) btn.setAttribute('aria-pressed', 'true');
        Array.prototype.forEach.call(viewButtons, function(b){ if (b !== btn) b && b.setAttribute('aria-pressed', 'false'); });
        currentView = (btn && btn.dataset && btn.dataset.view) ? btn.dataset.view : 'cards';
        if (currentView === 'cards') {
          if (tableContainer && tableContainer.classList) tableContainer.classList.add('d-none');
          if (cardsContainer && cardsContainer.classList) cardsContainer.classList.remove('d-none');
        } else {
          if (cardsContainer && cardsContainer.classList) cardsContainer.classList.add('d-none');
          if (tableContainer && tableContainer.classList) tableContainer.classList.remove('d-none');
        }
        try { localStorage.setItem('asset_vuln_view', currentView); } catch(e){}
        applyFilter();
      });
    });

    // Inicializar estados visuais
    Array.prototype.forEach.call(filterButtons, function(b){
      var val = (b && b.dataset && b.dataset.filter) ? b.dataset.filter : 'ALL';
      if (val === currentFilter) { b.classList.add('active'); b.setAttribute('aria-pressed','true'); }
      else { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); }
    });
    Array.prototype.forEach.call(viewButtons, function(b){
      var val = (b && b.dataset && b.dataset.view) ? b.dataset.view : 'cards';
      if (val === currentView) { b.classList.add('active'); b.setAttribute('aria-pressed','true'); }
      else { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); }
    });

    // Aplicar filtro inicial e revelar contêiner correto
    if (currentView === 'cards') {
      if (tableContainer && tableContainer.classList) tableContainer.classList.add('d-none');
      if (cardsContainer && cardsContainer.classList) cardsContainer.classList.remove('d-none');
    } else {
      if (cardsContainer && cardsContainer.classList) cardsContainer.classList.add('d-none');
      if (tableContainer && tableContainer.classList) tableContainer.classList.remove('d-none');
    }

    applyFilter();
  })();

  })();

</script>
{% endblock %}
    (function() {
      try {
        var els = document.querySelectorAll('.info-card small.text-muted');
        var target = null;
        Array.prototype.forEach.call(els, function(el){
          var txt = (el.textContent || '').trim();
          if (txt === 'Produto do fornecedor') { target = el; }
        });
        if (!target) return;
        var container = (target.closest && target.closest('.flex-grow-1')) || target.parentNode;
        if (!container) return;
        var forms = container.querySelectorAll('form[action*="link-product"]');
        Array.prototype.forEach.call(forms, function(f){ try { f.remove(); } catch(_){} });
        var nodes = Array.prototype.slice.call(container.childNodes || []);
        nodes.forEach(function(n){
          try {
            if (n && n.nodeType === 3) {
              var t = (n.textContent || '').trim();
              if (t && t.indexOf('.') > 0) {
                var parts = t.split('.');
                if (parts.length === 3 && t.length > 40) { n.remove(); }
              }
            }
          } catch(_){ }
        });
      } catch(_){ }
    })();
