{% extends 'core/base.html' %}

{% block title %}{{ action|capitalize }} Asset{% endblock %}

{% block extra_css %}
  {# Removido: CSS de página já importado via main.css #}
{% endblock %}

{% block content %}
<div class="container-fluid py-4 fade-in">
  <!-- Page Header -->
  <header class="page-header mb-5">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div>
        <h1 class="h3 fw-semibold mb-2">
          <i class="bi bi-{{ 'pencil' if action == 'editar' else 'plus-circle' }} me-2 text-primary"></i>
          {{ action|capitalize }} Asset
        </h1>
        <p class="text-muted fs-6 mb-0">
          {% if action == 'editar' %}
            Atualize as informações do asset
          {% else %}
            Adicione um novo asset ao inventário
          {% endif %}
        </p>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('asset.list_assets') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Voltar aos Assets
        </a>
      </div>
    </div>
  </header>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="row justify-content-center mb-4">
        <div class="col-lg-8">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
              <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endwith %}

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="form-card">
        <div class="form-card-header">
          <h3 class="form-card-title">
            <i class="bi bi-server me-2"></i>
            Informações do Asset
          </h3>
          <p class="form-card-subtitle">
            Preencha os dados do asset para adicionar ao inventário
          </p>
        </div>

        <form method="POST" novalidate class="form" id="asset-form">
          {{ form.csrf_token }}

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="name" class="form-label required">
                  <i class="bi bi-tag me-1"></i>
                  Nome do Asset
                </label>
                {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""), id="name", placeholder="Ex: Servidor Web Principal", required=true) }}
                {% if form.name.errors %}
                  <div class="invalid-feedback">
                    {{ form.name.errors[0] }}
                  </div>
                {% endif %}
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-group">
                <label for="ip_address" class="form-label required">
                  <i class="bi bi-globe me-1"></i>
                  Endereço IP
                </label>
                {{ form.ip_address(class="form-control" + (" is-invalid" if form.ip_address.errors else ""), id="ip_address", placeholder="Ex: 192.168.1.100", required=true) }}
                {% if form.ip_address.errors %}
                  <div class="invalid-feedback">
                    {{ form.ip_address.errors[0] }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
            {% if form.hostname is defined %}
            <div class="form-group">
              <label for="hostname" class="form-label">
                <i class="bi bi-pc-display me-1"></i>
                Hostname
              </label>
              {{ form.hostname(class="form-control" + (" is-invalid" if form.hostname.errors else ""), id="hostname", placeholder="Ex: web-server-01") }}
              {% if form.hostname.errors %}
                <div class="invalid-feedback">
                  {{ form.hostname.errors[0] }}
                </div>
              {% endif %}
            </div>
            {% endif %}
            </div>
            
            <div class="col-md-6">
              {% if form.location is defined %}
              <div class="form-group">
                <label for="location" class="form-label">
                  <i class="bi bi-geo-alt me-1"></i>
                  Localização
                </label>
                {{ form.location(class="form-control" + (" is-invalid" if form.location.errors else ""), id="location", placeholder="Ex: Data Center A - Rack 15") }}
                {% if form.location.errors %}
                  <div class="invalid-feedback">
                    {{ form.location.errors[0] }}
                  </div>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="status" class="form-label required">
                  <i class="bi bi-activity me-1"></i>
                  Status do Ativo
                </label>
                {% if form.status is defined %}
                {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else ""), id="status") }}
                {% if form.status.errors %}
                  <div class="invalid-feedback">
                    {{ form.status.errors[0] }}
                  </div>
                {% endif %}
                {% else %}
                <select id="status" class="form-select" disabled>
                  <option>Ativo</option>
                </select>
                {% endif %}
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-group">
                <label for="owner_id" class="form-label">
                  <i class="bi bi-person-check me-1"></i>
                  Proprietário
                </label>
                {% if form.owner_id is defined %}
                {{ form.owner_id(class="form-select" + (" is-invalid" if form.owner_id.errors else ""), id="owner_id") }}
                {% if form.owner_id.errors %}
                  <div class="invalid-feedback">
                    {{ form.owner_id.errors[0] }}
                  </div>
                {% endif %}
                {% else %}
                <select id="owner_id" class="form-select" disabled>
                  <option>Nenhum</option>
                </select>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="vendor_name" class="form-label">
                  <i class="bi bi-building me-1"></i>
                  Fornecedor
                </label>
                {% if form.vendor_name is defined %}
                <div class="position-relative">
                  {{ form.vendor_name(class="form-control" + (" is-invalid" if form.vendor_name.errors else ""), id="vendor_name", placeholder="Ex: Microsoft, Cisco, Oracle, etc.", autocomplete="off") }}
                  {{ form.vendor_id(id="vendor_id") }}
                  <!-- Clear vendor selection button -->
                  <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 mt-2 me-2" id="vendor_clear" aria-label="Limpar fornecedor">
                    <i class="bi bi-x-circle"></i>
                  </button>

                  <!-- Suggestions listbox -->
                  <div id="vendor_suggestions" class="list-group position-absolute w-100 d-none" style="z-index:1060; top:100%; left:0;" role="listbox" aria-label="Sugestões de fornecedor">
                    <div id="vendor_loading" class="list-group-item d-flex align-items-center" hidden>
                      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                      Buscando fornecedores...
                    </div>
                  </div>
                  <small class="form-text text-muted">Digite para buscar; selecione uma sugestão ou informe um novo nome. Se não existir, será criado automaticamente ao salvar.</small>
                  <div id="vendor_status" class="visually-hidden" aria-live="polite"></div>
                  {% if form.vendor_name.errors %}
                    <div class="invalid-feedback">
                      {{ form.vendor_name.errors[0] }}
                    </div>
                  {% endif %}
                </div>
                {% else %}
                <input type="text" class="form-control" id="vendor_name" name="vendor_name" placeholder="Ex: Microsoft, Cisco, Oracle, etc." disabled>
                {% endif %}
              </div>
            </div>
          </div>

          {% if form.description is defined %}
          <div class="form-group">
              <label for="description" class="form-label">
                <i class="bi bi-file-text me-1"></i>
                Descrição
              </label>
              {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), id="description", placeholder="Descreva o propósito e características do asset...", rows="4") }}
              {% if form.description.errors %}
                <div class="invalid-feedback">
                  {{ form.description.errors[0] }}
                </div>
              {% endif %}
            </div>
          {% endif %}

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn">
              <i class="bi bi-{{ 'check-circle' if action == 'editar' else 'plus-circle' }} me-1"></i>
              <span class="btn-text">{{ action|capitalize }} Asset</span>
              <span class="btn-loading d-none">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Processando...
              </span>
            </button>
            <a href="{{ url_for('asset.list_assets') }}" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle me-1"></i>
              Cancelar
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

<script>
// Form validation and submission
document.addEventListener('DOMContentLoaded', function() {
  var form = document.getElementById('asset-form');
  var submitBtn = document.getElementById('submit-btn');
  var btnText = submitBtn ? submitBtn.querySelector('.btn-text') : null;
  var btnLoading = submitBtn ? submitBtn.querySelector('.btn-loading') : null;

  // Form submission with loading state
  if (form) {
    form.addEventListener('submit', function(e) {
      if (typeof form.checkValidity === 'function' ? form.checkValidity() : true) {
        if (submitBtn) {
          submitBtn.disabled = true;
          if (btnText) btnText.classList.add('d-none');
          if (btnLoading) btnLoading.classList.remove('d-none');
        }
      }
    });
  }

  // IP address validation (IPv4 e IPv6)
  var ipInput = document.getElementById('ip_address');
  function isValidIPv4(ip) {
    const ipv4 = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    return ipv4.test(ip);
  }
  function isValidIPv6(ip) {
    // Suporte para formatos comuns, incluindo abreviações (::) e hextets
    const ipv6 = /^(?:([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|:((:[0-9a-fA-F]{1,4}){1,7})|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7})|::)$/;
    return ipv6.test(ip);
  }
  function updateIpValidation() {
    const value = ipInput.value.trim();
    if (!value) { ipInput.classList.remove('is-invalid','is-valid'); return; }
    const valid = isValidIPv4(value) || isValidIPv6(value);
    if (!valid) {
      ipInput.classList.add('is-invalid');
      ipInput.classList.remove('is-valid');
      let feedback = ipInput.parentNode.querySelector('.invalid-feedback');
      if (!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        ipInput.parentNode.appendChild(feedback);
      }
      feedback.textContent = 'Por favor, insira um endereço IPv4 ou IPv6 válido';
    } else {
      ipInput.classList.remove('is-invalid');
      ipInput.classList.add('is-valid');
    }
  }
  if (ipInput) {
    ipInput.addEventListener('blur', updateIpValidation);
    ipInput.addEventListener('input', function() { if (ipInput.classList.contains('is-invalid')) updateIpValidation(); });
  }

  // Real-time validation feedback
  if (form) {
    var inputs = form.querySelectorAll('input, select, textarea');
    Array.prototype.forEach.call(inputs, function(input){
      input.addEventListener('blur', function() {
        validateField(this);
      });

      input.addEventListener('input', function() {
        if (this.classList.contains('is-invalid')) {
          validateField(this);
        }
      });
    });
  }

  function validateField(field) {
    var value = (field.value || '').trim();
    var isRequired = field.hasAttribute('required') || (field.labels && field.labels[0] && field.labels[0].classList && field.labels[0].classList.contains('required'));
    
    if (isRequired && !value) {
      field.classList.add('is-invalid');
      field.classList.remove('is-valid');
    } else if (value) {
      field.classList.remove('is-invalid');
      field.classList.add('is-valid');
    } else {
      field.classList.remove('is-invalid');
      field.classList.remove('is-valid');
    }
  }

  // Vendor remote suggestions and selection
  var vendorInput = document.getElementById('vendor_name');
  var vendorIdInput = document.getElementById('vendor_id');
  var suggestionsEl = document.getElementById('vendor_suggestions');
  var vendorClearBtn = document.getElementById('vendor_clear');
  var vendorLoadingEl = document.getElementById('vendor_loading');
  var vendorStatusEl = document.getElementById('vendor_status');

  if (vendorInput && suggestionsEl && vendorIdInput) {
    var controller = null;
    var debounceTimer = null;
    var isFetching = false;
    var activeIndex = -1;
    var hideSuggestions = function() {
      suggestionsEl.classList.add('d-none');
      var toRemove = suggestionsEl.querySelectorAll('.list-group-item');
      Array.prototype.forEach.call(toRemove, function(el){ if (el && el.parentNode) el.parentNode.removeChild(el); });
      activeIndex = -1;
    };
    var showSuggestions = function() { suggestionsEl.classList.remove('d-none'); };
    var setFetching = function(fetching) {
      isFetching = fetching;
      if (vendorLoadingEl) vendorLoadingEl.hidden = !fetching;
      if (submitBtn) submitBtn.disabled = fetching;
    };
    var updateStatus = function(text) { if (vendorStatusEl) vendorStatusEl.textContent = text; };

    // Clear vendor selection
    if (vendorClearBtn) {
      vendorClearBtn.addEventListener('click', function() {
        vendorInput.value = '';
        vendorIdInput.value = '';
        hideSuggestions();
        updateStatus('Fornecedor limpo');
      });
    }

    vendorInput.addEventListener('input', function() {
      const q = vendorInput.value.trim();
      vendorIdInput.value = '';
      if (debounceTimer) { clearTimeout(debounceTimer); }
      if (!q || q.length < 2) { hideSuggestions(); return; }
      debounceTimer = setTimeout(async function() {
        if (controller && typeof controller.abort === 'function') controller.abort();
        controller = (typeof window.AbortController !== 'undefined') ? new AbortController() : null;
        try {
          setFetching(true);
          var url = '/api/v1/vendors?q=' + encodeURIComponent(q) + '&limit=8';
          var res = await fetch(url, controller ? { signal: controller.signal } : {});
          var json = await res.json();
          var items = (json && json.data) ? json.data : [];
          hideSuggestions();
          Array.prototype.forEach.call(items, function(v){
            var a = document.createElement('a');
            a.href = '#';
            a.className = 'list-group-item list-group-item-action';
            a.textContent = v.name;
            a.setAttribute('role', 'option');
            a.addEventListener('click', function(ev) {
              ev.preventDefault();
              vendorInput.value = v.name;
              vendorIdInput.value = v.id;
              hideSuggestions();
              updateStatus('Fornecedor selecionado: ' + v.name);
            });
            suggestionsEl.appendChild(a);
          });
          if (items.length) {
            showSuggestions();
            activeIndex = 0;
            var options = suggestionsEl.querySelectorAll('.list-group-item');
            var first = options[activeIndex];
            if (first && first.classList) first.classList.add('active');
            updateStatus(items.length + ' fornecedor(es) encontrados');
          } else {
            hideSuggestions();
            updateStatus('Nenhum fornecedor encontrado');
          }
        } catch (err) {
          hideSuggestions();
          updateStatus('Falha ao carregar fornecedores');
        } finally {
          setFetching(false);
        }
      }, 250);
    });

    vendorInput.addEventListener('blur', function() {
      setTimeout(hideSuggestions, 150);
    });

    // Keyboard navigation for suggestions
    vendorInput.addEventListener('keydown', function(ev) {
      var optionsNode = suggestionsEl.querySelectorAll('.list-group-item');
      var options = Array.prototype.slice.call(optionsNode);
      if (!options.length || suggestionsEl.classList.contains('d-none')) return;
      if (ev.key === 'ArrowDown') {
        ev.preventDefault();
        var cur = options[activeIndex];
        if (cur && cur.classList) cur.classList.remove('active');
        activeIndex = (activeIndex + 1) % options.length;
        var next = options[activeIndex];
        if (next && next.classList) next.classList.add('active');
      } else if (ev.key === 'ArrowUp') {
        ev.preventDefault();
        var cur2 = options[activeIndex];
        if (cur2 && cur2.classList) cur2.classList.remove('active');
        activeIndex = (activeIndex - 1 + options.length) % options.length;
        var prev = options[activeIndex];
        if (prev && prev.classList) prev.classList.add('active');
      } else if (ev.key === 'Enter') {
        ev.preventDefault();
        var el = options[activeIndex];
        if (el) el.click();
      } else if (ev.key === 'Escape') {
        hideSuggestions();
      }
    });
  }

  // Show success toast on form submission
  function showToast(message, type = 'success') {
    if (typeof window.safeNotify === 'function') {
      const titleMap = { success: 'Sucesso', error: 'Erro', warning: 'Aviso', info: 'Informação' };
      window.safeNotify(type, titleMap[type] || 'Informação', message, 5000);
      return;
    }
    var toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) return;
    var toastId = 'toast-' + Date.now();
    var iconName = (type === 'success') ? 'check-circle' : 'exclamation-triangle';
    var toastHTML = (
      '<div class="toast align-items-center text-bg-' + type + ' border-0" role="alert" aria-live="assertive" aria-atomic="true" id="' + toastId + '">' +
      '<div class="d-flex">' +
      '<div class="toast-body">' +
      '<i class="bi bi-' + iconName + ' me-2"></i>' +
      String(message) +
      '</div>' +
      '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>' +
      '</div>' +
      '</div>'
    );
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    var toastElement = document.getElementById(toastId);
    var toastInst = (typeof window.getToastInstance === 'function') ? window.getToastInstance(toastElement, { delay: 5000 }) : null;
    if (toastInst && toastInst.show) toastInst.show();
    
    if (toastElement) {
      toastElement.addEventListener('hidden.bs.toast', function() {
        if (this && this.parentNode) { this.parentNode.removeChild(this); }
      });
    }
  }
});
</script>
{% endblock %}