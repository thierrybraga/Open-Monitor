{% extends 'core/base.html' %}

{% block title %}{{ action|capitalize }} Asset{% endblock %}

{% block extra_css %}
  {# Removido: CSS de página já importado via main.css #}
{% endblock %}

{% block content %}
<div class="container-fluid py-4 fade-in">
  <!-- Page Header -->
  <header class="page-header mb-5">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div>
        <h1 class="h3 fw-semibold mb-2">
          <i class="bi bi-{{ 'pencil' if action == 'editar' else 'plus-circle' }} me-2 text-primary"></i>
          {{ action|capitalize }} Asset
        </h1>
        <p class="text-muted fs-6 mb-0">
          {% if action == 'editar' %}
            Atualize as informações do asset
          {% else %}
            Adicione um novo asset ao inventário
          {% endif %}
        </p>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('asset.list_assets') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Voltar aos Assets
        </a>
      </div>
    </div>
  </header>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="row justify-content-center mb-4">
        <div class="col-lg-8">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
              <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endwith %}

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="form-card">
        <div class="form-card-header">
          <h3 class="form-card-title">
            <i class="bi bi-server me-2"></i>
            Informações do Asset
          </h3>
          <p class="form-card-subtitle">
            Preencha os dados do asset para adicionar ao inventário
          </p>
        </div>

        <form method="POST" novalidate class="form" id="asset-form">
          {{ form.csrf_token }}

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="name" class="form-label required">
                  <i class="bi bi-tag me-1"></i>
                  Nome do Asset
                </label>
                {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""), id="name", placeholder="Ex: Servidor Web Principal", required=true) }}
                {% if form.name.errors %}
                  <div class="invalid-feedback">
                    {{ form.name.errors[0] }}
                  </div>
                {% endif %}
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-group">
                <label for="ip_address" class="form-label required">
                  <i class="bi bi-globe me-1"></i>
                  Endereço IP
                </label>
                {{ form.ip_address(class="form-control" + (" is-invalid" if form.ip_address.errors else ""), id="ip_address", placeholder="Ex: 192.168.1.100", required=true) }}
                {% if form.ip_address.errors %}
                  <div class="invalid-feedback">
                    {{ form.ip_address.errors[0] }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          {% if has_asset_type_col %}
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="asset_type" class="form-label">
                  <i class="bi bi-tag me-1"></i>
                  Tipo do Ativo
                </label>
                {% if form.asset_type is defined %}
                {{ form.asset_type(class="form-control" + (" is-invalid" if form.asset_type.errors else ""), id="asset_type", placeholder="Ex: Servidor, Switch, Firewall") }}
                {% if form.asset_type.errors %}
                  <div class="invalid-feedback">
                    {{ form.asset_type.errors[0] }}
                  </div>
                {% endif %}
                {% else %}
                <input type="text" id="asset_type" class="form-control" placeholder="Ex: Servidor, Switch, Firewall" disabled>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}

          <div class="row">
            <div class="col-md-6">
            {% if form.hostname is defined %}
            <div class="form-group">
              <label for="hostname" class="form-label">
                <i class="bi bi-pc-display me-1"></i>
                Hostname
              </label>
              {{ form.hostname(class="form-control" + (" is-invalid" if form.hostname.errors else ""), id="hostname", placeholder="Ex: web-server-01") }}
              {% if form.hostname.errors %}
                <div class="invalid-feedback">
                  {{ form.hostname.errors[0] }}
                </div>
              {% endif %}
            </div>
            {% endif %}
            </div>
            
            <div class="col-md-6">
              {% if form.location is defined %}
              <div class="form-group">
                <label for="location" class="form-label">
                  <i class="bi bi-geo-alt me-1"></i>
                  Localização
                </label>
                {{ form.location(class="form-control" + (" is-invalid" if form.location.errors else ""), id="location", placeholder="Ex: Data Center A - Rack 15") }}
                {% if form.location.errors %}
                  <div class="invalid-feedback">
                    {{ form.location.errors[0] }}
                  </div>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="status" class="form-label required">
                  <i class="bi bi-activity me-1"></i>
                  Status do Ativo
                </label>
                {% if form.status is defined %}
                {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else ""), id="status") }}
                {% if form.status.errors %}
                  <div class="invalid-feedback">
                    {{ form.status.errors[0] }}
                  </div>
                {% endif %}
                {% else %}
                <select id="status" class="form-select" disabled>
                  <option>Ativo</option>
                </select>
                {% endif %}
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-group">
                <label for="owner_id" class="form-label">
                  <i class="bi bi-person-check me-1"></i>
                  Proprietário
                </label>
                {% if form.owner_id is defined %}
                {{ form.owner_id(class="form-select" + (" is-invalid" if form.owner_id.errors else ""), id="owner_id") }}
                {% if form.owner_id.errors %}
                  <div class="invalid-feedback">
                    {{ form.owner_id.errors[0] }}
                  </div>
                {% endif %}
                {% else %}
                <select id="owner_id" class="form-select" disabled>
                  <option>Nenhum</option>
                </select>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="vendor_name" class="form-label">
                  <i class="bi bi-building me-1"></i>
                  Fornecedor
                </label>
                {% if form.vendor_name is defined %}
                <div class="position-relative">
                  {# Select fixo: somente Cisco/Fortinet #}
                  <select class="form-select{{ ' is-invalid' if form.vendor_name.errors else '' }}" id="vendor_name" name="vendor_name" required>
                    <option value="" disabled {{ 'selected' if not form.vendor_name.data }}>Selecione...</option>
                    <option value="cisco" {{ 'selected' if (form.vendor_name.data and form.vendor_name.data|lower == 'cisco') }}>Cisco</option>
                    <option value="fortinet" {{ 'selected' if (form.vendor_name.data and form.vendor_name.data|lower == 'fortinet') }}>Fortinet</option>
                  </select>
                  {{ form.vendor_id(id="vendor_id") }}
                  <small class="form-text text-muted">Selecione o fornecedor: Fortinet ou Cisco.</small>
                  <div id="vendor_status" class="visually-hidden" aria-live="polite"></div>
                  {% if form.vendor_name.errors %}
                    <div class="invalid-feedback">
                      {{ form.vendor_name.errors[0] }}
                    </div>
                  {% endif %}
                </div>
                {% else %}
                <select id="vendor_name" class="form-select" name="vendor_name" disabled>
                  <option>Selecione</option>
                </select>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Product selection tied to selected vendor -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="product_name" class="form-label">
                  <i class="bi bi-box-seam me-1"></i>
                  Produto (do fornecedor)
                </label>
                <div class="position-relative">
                  <select id="product_select" class="form-select">
                    <option value="" selected disabled>Selecione um produto</option>
                  </select>
                  <input id="product_query" type="text" class="form-control form-control-sm mt-2" placeholder="Buscar produto (incremental)..." autocomplete="off">
                  {{ form.product_id(id="product_id") }}
                  {% if form.product_name is defined %}
                  {{ form.product_name(class="d-none", id="product_name") }}
                  {% endif %}
                  <small class="form-text text-muted">Selecione um produto do fornecedor para correlacionar CVEs.</small>
                  <small id="product_status" class="form-text text-muted"></small>
                </div>
              </div>
            </div>
          </div>

          <!-- Correlation metadata: model, OS, version -->
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label for="model_name" class="form-label">
                  <i class="bi bi-cpu me-1"></i>
                  Modelo
                </label>
                {% if form.model_name is defined %}
                {{ form.model_name(class="form-control" + (" is-invalid" if form.model_name.errors else ""), id="model_name", placeholder="Ex: Windows Server 2019, Catalyst 2960", list="model_list") }}
                <datalist id="model_list"></datalist>
                {% if form.model_name.errors %}
                  <div class="invalid-feedback">
                    {{ form.model_name.errors[0] }}
                  </div>
                {% endif %}
                {% else %}
                <input type="text" class="form-control" id="model_name" name="model_name" placeholder="Ex: Windows Server 2019, Catalyst 2960" disabled>
                {% endif %}
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="operating_system" class="form-label">
                  <i class="bi bi-hdd-network me-1"></i>
                  Sistema Operacional
                  <i class="bi bi-info-circle ms-1 text-muted" tabindex="0" data-bs-toggle="tooltip" title="Sugestões: Windows, Linux, macOS, Cisco IOS, NX-OS, ASA, FortiOS, Junos, ESXi, AIX, Solaris."></i>
                </label>
                {% if form.operating_system is defined %}
                {{ form.operating_system(class="form-control" + (" is-invalid" if form.operating_system.errors else ""), id="operating_system", placeholder="Ex: Windows, Linux, IOS, NX-OS", list="os_list") }}
                {% else %}
                <input type="text" class="form-control" id="operating_system" name="operating_system" placeholder="Ex: Windows, Linux, IOS, NX-OS" disabled>
                {% endif %}
                <datalist id="os_list">
                  <option value="Windows"></option>
                  <option value="Linux"></option>
                  <option value="macOS"></option>
                  <option value="Android"></option>
                  <option value="iOS"></option>
                  <option value="Cisco IOS"></option>
                  <option value="NX-OS"></option>
                  <option value="ASA"></option>
                  <option value="FortiOS"></option>
                  <option value="Junos"></option>
                  <option value="FreeBSD"></option>
                  <option value="VMware ESXi"></option>
                  <option value="AIX"></option>
                  <option value="Solaris"></option>
                </datalist>
                {% if form.operating_system is defined and form.operating_system.errors %}
                  <div class="invalid-feedback">
                    {{ form.operating_system.errors[0] }}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="installed_version" class="form-label">
                  <i class="bi bi-tag me-1"></i>
                  Versão Instalada
                  <i class="bi bi-info-circle ms-1 text-muted" tabindex="0" data-bs-toggle="tooltip" title="Use números/letras/pontos/traços/parênteses. Ex: 10.0.17763, 15.2(2)E9."></i>
                </label>
                {% if form.installed_version is defined %}
                {{ form.installed_version(class="form-control" + (" is-invalid" if form.installed_version.errors else ""), id="installed_version", placeholder="Ex: 10.0.17763, 15.2(2)E9", list="version_list") }}
                <datalist id="version_list"></datalist>
                {% else %}
                <input type="text" class="form-control" id="installed_version" name="installed_version" placeholder="Ex: 10.0.17763, 15.2(2)E9" list="version_list" disabled>
                <datalist id="version_list"></datalist>
                {% endif %}
                <small class="form-text text-muted">Aceita formatos comuns (sem caracteres especiais como @, #, %).</small>
                {% if form.installed_version is defined and form.installed_version.errors %}
                  <div class="invalid-feedback">
                    {{ form.installed_version.errors[0] }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          {% if form.description is defined %}
          <div class="form-group">
              <label for="description" class="form-label">
                <i class="bi bi-file-text me-1"></i>
                Descrição
              </label>
              {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), id="description", placeholder="Descreva o propósito e características do asset...", rows="4") }}
              {% if form.description.errors %}
                <div class="invalid-feedback">
                  {{ form.description.errors[0] }}
                </div>
              {% endif %}
            </div>
          {% endif %}

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn">
              <i class="bi bi-{{ 'check-circle' if action == 'editar' else 'plus-circle' }} me-1"></i>
              <span class="btn-text">{{ action|capitalize }} Asset</span>
              <span class="btn-loading d-none">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Processando...
              </span>
            </button>
            <a href="{{ url_for('asset.list_assets') }}" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle me-1"></i>
              Cancelar
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script nonce="{{ nonce }}">
    (function(){
      const vendorInput = document.getElementById('vendor_name');
      const vendorIdInput = document.getElementById('vendor_id');
      const productInput = document.getElementById('product_name');
      const productIdInput = document.getElementById('product_id');
      const suggBox = document.getElementById('product_suggestions');
      const loadingItem = document.getElementById('product_loading');
      const productStatusEl = document.getElementById('product_status');
      const productQueryInput = document.getElementById('product_query');

      function clearProductSelection(){
        if (productInput) productInput.value = '';
        if (productIdInput) productIdInput.value = '';
        hideSuggestions();
      }

      function showSuggestions(){
        if (suggBox) suggBox.classList.remove('d-none');
      }
      function hideSuggestions(){
        if (suggBox) suggBox.classList.add('d-none');
      }
      function setLoading(loading){
        if (!loadingItem) return;
        loadingItem.hidden = !loading;
      }

      function updateProductStatus(text){ if (productStatusEl) productStatusEl.textContent = text || ''; }

      async function fetchProducts(vendorId, q){
        if (!vendorId) return [];
        const url = new URL(`/api/products/vendors/${vendorId}`, window.location.origin);
        url.searchParams.set('limit', '500');
        if (q && q.trim()) url.searchParams.set('q', q.trim());
        const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
        if (!res.ok) return [];
        const data = await res.json().catch(() => []);
        return Array.isArray(data?.items) ? data.items : [];
      }

      async function fetchProductsByVendorName(vendorName, q){
        if (!vendorName) return [];
        const url = new URL(`/api/products/vendors/by-name/${encodeURIComponent(vendorName)}`, window.location.origin);
        url.searchParams.set('limit', '500');
        if (q && q.trim()) url.searchParams.set('q', q.trim());
        const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
        if (!res.ok) return [];
        const data = await res.json().catch(() => []);
        return Array.isArray(data?.items) ? data.items : [];
      }

      // Resolve vendor_id using search API for robust matching
      async function resolveVendorIdByName(vendorName){
        const name = (vendorName || '').trim();
        if (!name) return null;
        try {
          const url = new URL('/api/v1/vendors', window.location.origin);
          url.searchParams.set('q', name);
          url.searchParams.set('limit', '1');
          const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
          if (!res.ok) return null;
          const json = await res.json().catch(() => ({}));
          const items = Array.isArray(json?.data) ? json.data : [];
          return items.length ? items[0].id : null;
        } catch (_) {
          return null;
        }
      }

      function renderSuggestions(items){
        if (!suggBox) return;
        suggBox.innerHTML = '';
        const frag = document.createDocumentFragment();
        if (!items.length){
          const empty = document.createElement('div');
          empty.className = 'list-group-item text-muted';
          empty.textContent = 'Nenhum produto encontrado para o fornecedor.';
          frag.appendChild(empty);
        } else {
          items.forEach(item => {
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'list-group-item list-group-item-action';
            el.setAttribute('role', 'option');
            el.textContent = `${item.name}`;
            el.addEventListener('click', () => {
              productInput.value = item.name || '';
              productIdInput.value = String(item.id || '');
              hideSuggestions();
              try { if (item && item.id) { window.loadProductMetadata && window.loadProductMetadata(String(item.id)); } } catch (e) { /* noop */ }
              // Heurística Fortinet: definir OS com base no nome do produto
              try {
                const vName = (vendorInput?.value || '').trim().toLowerCase();
                if (vName === 'fortinet' && osInput && (!osInput.value || osInput.value.trim() === '')){
                  const pName = (item.name || '').toLowerCase();
                  let inferred = 'FortiOS';
                  if (pName.startsWith('fortiweb')) inferred = 'FortiWeb';
                  else if (pName.startsWith('fortiproxy')) inferred = 'FortiProxy';
                  else if (pName.startsWith('fortimanager')) inferred = 'FortiManager';
                  else if (pName.startsWith('fortianalyzer')) inferred = 'FortiAnalyzer';
                  else if (pName.startsWith('fortiadc')) inferred = 'FortiADC';
                  else if (pName.startsWith('fortiswitch') || pName.startsWith('fortiap')) inferred = 'FortiOS';
                  osInput.value = inferred;
                }
              } catch (_) { /* noop */ }
            });
            frag.appendChild(el);
          });
        }
        // prepend loading item
        if (loadingItem) frag.prepend(loadingItem);
        suggBox.appendChild(frag);
        showSuggestions();
      }

      let debounceTimer = null;
      function onProductInput(){
        const vendorId = (vendorIdInput?.value || '').trim();
        const query = (productInput?.value || '').trim();
        productIdInput.value = '';
        if (!vendorId){
          const vendorName = (vendorInput?.value || '').trim();
          if (!vendorName){
            updateProductStatus('Selecione um fornecedor para listar produtos.');
            hideSuggestions();
            return;
          }
          updateProductStatus('Buscando produtos pelo nome do fornecedor...');
          setLoading(true);
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(async () => {
            try {
              const items = await fetchProductsByVendorName(vendorName, query);
              renderSuggestions(items);
              updateProductStatus(items.length ? `${items.length} produto(s) encontrados` : 'Nenhum produto encontrado');
            } catch (e) {
              hideSuggestions();
              updateProductStatus('Falha ao buscar produtos');
            } finally {
              setLoading(false);
            }
          }, 250);
          return;
        }
        setLoading(true);
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          try {
            const items = await fetchProducts(vendorId, query);
            renderSuggestions(items);
            updateProductStatus(items.length ? `${items.length} produto(s) encontrados` : 'Nenhum produto encontrado');
          } catch (e) {
            hideSuggestions();
            updateProductStatus('Falha ao buscar produtos');
          } finally {
            setLoading(false);
          }
        }, 250);
      }

      // Substituído por select: eventos de mudança para atualizar IDs
      const productSelect = document.getElementById('product_select');
      function populateProductSelect(items){
        if (!productSelect) return;
        productSelect.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Selecione um produto';
        defaultOpt.disabled = true;
        defaultOpt.selected = true;
        productSelect.appendChild(defaultOpt);
        items.forEach(item => {
          const opt = document.createElement('option');
          opt.value = String(item.id || '');
          opt.textContent = item.name || String(item.id || '');
          productSelect.appendChild(opt);
        });
      }

      function setProductLoading(loading){
        if (!productSelect) return;
        productSelect.disabled = !!loading;
        if (loading){
          productSelect.innerHTML = '';
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Carregando...';
          opt.disabled = true;
          opt.selected = true;
          productSelect.appendChild(opt);
        }
      }

      function rankProducts(items, q){
        if (!q) return items;
        const query = q.toLowerCase();
        const starts = []; const contains = []; const others = [];
        items.forEach(item => {
          const name = (item.name || '').toLowerCase();
          if (name.startsWith(query)) starts.push(item);
          else if (name.includes(query)) contains.push(item);
          else others.push(item);
        });
        return [...starts, ...contains, ...others];
      }

      async function loadAllProductsForVendorId(vendorId, q){
        updateProductStatus('Carregando produtos...');
        setProductLoading(true);
        try {
          let items = await fetchProducts(vendorId, q || null);
          if (q && q.trim()) items = rankProducts(items, q);
          populateProductSelect(items);
          updateProductStatus(items.length ? `${items.length} produtos carregados.` : 'Nenhum produto encontrado.');
        } catch (e) {
          updateProductStatus('Falha ao carregar produtos.');
        } finally {
          setProductLoading(false);
        }
      }

      async function loadAllProductsForVendorName(vendorName, q){
        updateProductStatus('Carregando produtos...');
        setProductLoading(true);
        try {
          let items = await fetchProductsByVendorName(vendorName, q || null);
          if (q && q.trim()) items = rankProducts(items, q);
          populateProductSelect(items);
          updateProductStatus(items.length ? `${items.length} produtos carregados.` : 'Nenhum produto encontrado.');
        } catch (e) {
          updateProductStatus('Falha ao carregar produtos.');
        } finally {
          setProductLoading(false);
        }
      }

      productSelect?.addEventListener('change', (ev) => {
        const sel = ev.target;
        if (!sel) return;
        const pid = sel.value;
        const pname = sel.options[sel.selectedIndex]?.text || '';
        const pidInput = document.getElementById('product_id');
        const pnameInput = document.getElementById('product_name');
        if (pidInput) pidInput.value = String(pid || '');
        if (pnameInput) pnameInput.value = pname;
        try { if (pid) { window.loadProductMetadata && window.loadProductMetadata(String(pid)); } } catch (e) { /* noop */ }
      });

      // Defaults para Fortinet: OS FortiOS, placeholders livres
      const osInput = document.getElementById('operating_system');
      const versionInput = document.getElementById('installed_version');
      const modelInput = document.getElementById('model_name');
      const osPlaceholderDefault = osInput?.getAttribute('placeholder') || '';
      const versionPlaceholderDefault = versionInput?.getAttribute('placeholder') || '';
      const modelPlaceholderDefault = modelInput?.getAttribute('placeholder') || '';

      function applyFortinetDefaults(){
        // Não alterar valores do usuário; apenas placeholders sugeridos
        if (versionInput) versionInput.setAttribute('placeholder', 'Livre');
        if (modelInput) modelInput.setAttribute('placeholder', 'Todas versões');
      }
      function resetDefaults(){
        if (osInput) osInput.setAttribute('placeholder', osPlaceholderDefault);
        if (versionInput) versionInput.setAttribute('placeholder', versionPlaceholderDefault);
        if (modelInput) modelInput.setAttribute('placeholder', modelPlaceholderDefault);
      }

      function onVendorChanged(){
        const name = (vendorInput?.value || '').trim().toLowerCase();
        if (name === 'fortinet'){
          applyFortinetDefaults();
        } else {
          resetDefaults();
        }
        clearProductSelection();
      }

      // Ao mudar fornecedor, aplicar defaults, resolver vendor_id e carregar lista de produtos
      vendorInput?.addEventListener('change', async () => {
        onVendorChanged();
        if (productQueryInput) productQueryInput.value = '';
        const vName = (vendorInput?.value || '').trim().toLowerCase();
        if (!vName) return;
        const vid = await resolveVendorIdByName(vName);
        if (vid) {
          if (vendorIdInput) vendorIdInput.value = String(vid);
          loadAllProductsForVendorId(vid);
          try { window.loadVendorMetadata && window.loadVendorMetadata(String(vid)); } catch (_) { /* noop */ }
        } else {
          // Fallback: carregar por nome se não conseguir resolver o ID
          loadAllProductsForVendorName(vName);
        }
      });

      // Busca incremental por produto (q digitado)
      let queryDebounceTimer = null;
      productQueryInput?.addEventListener('input', () => {
        const q = (productQueryInput.value || '').trim();
        const vid = (vendorIdInput?.value || '').trim();
        const vName = (vendorInput?.value || '').trim().toLowerCase();
        setProductLoading(true);
        updateProductStatus(q ? `Buscando por "${q}"...` : 'Carregando produtos...');
        clearTimeout(queryDebounceTimer);
        queryDebounceTimer = setTimeout(async () => {
          try {
            if (vid) {
              await loadAllProductsForVendorId(vid, q);
            } else if (vName) {
              await loadAllProductsForVendorName(vName, q);
            } else {
              populateProductSelect([]);
              updateProductStatus('Selecione um fornecedor para buscar produtos.');
            }
          } finally {
            setProductLoading(false);
          }
        }, 250);
      });

      const initialVendor = (vendorInput?.value || '').trim().toLowerCase();
      if (initialVendor) {
        onVendorChanged();
        resolveVendorIdByName(initialVendor).then(vid => {
          if (vid) {
            if (vendorIdInput) vendorIdInput.value = String(vid);
            loadAllProductsForVendorId(vid);
            try { window.loadVendorMetadata && window.loadVendorMetadata(String(vid)); } catch (_) {}
          } else {
            loadAllProductsForVendorName(initialVendor);
          }
        });
      }
    })();
  </script>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

<script nonce="{{ nonce }}">
// Form validation and submission
document.addEventListener('DOMContentLoaded', function() {
  var form = document.getElementById('asset-form');
  var submitBtn = document.getElementById('submit-btn');
  var btnText = submitBtn ? submitBtn.querySelector('.btn-text') : null;
  var btnLoading = submitBtn ? submitBtn.querySelector('.btn-loading') : null;

  // Form submission with loading state
  if (form) {
    form.addEventListener('submit', function(e) {
      if (typeof form.checkValidity === 'function' ? form.checkValidity() : true) {
        if (submitBtn) {
          submitBtn.disabled = true;
          if (btnText) btnText.classList.add('d-none');
          if (btnLoading) btnLoading.classList.remove('d-none');
        }
      }
    });
  }

  // IP address validation (IPv4 e IPv6)
  var ipInput = document.getElementById('ip_address');
  function isValidIPv4(ip) {
    const ipv4 = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    return ipv4.test(ip);
  }
  function isValidIPv6(ip) {
    // Suporte para formatos comuns, incluindo abreviações (::) e hextets
    const ipv6 = /^(?:([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|:((:[0-9a-fA-F]{1,4}){1,7})|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7})|::)$/;
    return ipv6.test(ip);
  }
  function updateIpValidation() {
    const value = ipInput.value.trim();
    if (!value) { ipInput.classList.remove('is-invalid','is-valid'); return; }
    const valid = isValidIPv4(value) || isValidIPv6(value);
    if (!valid) {
      ipInput.classList.add('is-invalid');
      ipInput.classList.remove('is-valid');
      let feedback = ipInput.parentNode.querySelector('.invalid-feedback');
      if (!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        ipInput.parentNode.appendChild(feedback);
      }
      feedback.textContent = 'Por favor, insira um endereço IPv4 ou IPv6 válido';
    } else {
      ipInput.classList.remove('is-invalid');
      ipInput.classList.add('is-valid');
    }
  }
  if (ipInput) {
    ipInput.addEventListener('blur', updateIpValidation);
    ipInput.addEventListener('input', function() { if (ipInput.classList.contains('is-invalid')) updateIpValidation(); });
  }

  // Installed version validation (allow digits, letters, dots, dashes, parentheses)
  var versionInput = document.getElementById('installed_version');
  function isValidVersion(v) {
    if (!v) return true; // optional
    const pattern = /^[A-Za-z0-9\.\-\(\)]+$/;
    return v.length >= 2 && pattern.test(v);
  }
  function updateVersionValidation() {
    if (!versionInput) return;
    const value = (versionInput.value || '').trim();
    if (!value) { versionInput.classList.remove('is-invalid','is-valid'); return; }
    const valid = isValidVersion(value);
    if (!valid) {
      versionInput.classList.add('is-invalid');
      versionInput.classList.remove('is-valid');
      let feedback = versionInput.parentNode.querySelector('.invalid-feedback');
      if (!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        versionInput.parentNode.appendChild(feedback);
      }
      feedback.textContent = 'Formato inválido. Use números/letras/pontos/traços/parênteses.';
    } else {
      versionInput.classList.remove('is-invalid');
      versionInput.classList.add('is-valid');
    }
  }
  if (versionInput) {
    versionInput.addEventListener('blur', updateVersionValidation);
    versionInput.addEventListener('input', function(){ if (versionInput.classList.contains('is-invalid')) updateVersionValidation(); });
  }

  // Initialize tooltips for info icons
  try {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      if (window.bootstrap && typeof window.bootstrap.Tooltip === 'function') {
        new window.bootstrap.Tooltip(tooltipTriggerEl);
      } else if (typeof $ !== 'undefined' && typeof $.fn.tooltip === 'function') {
        $(tooltipTriggerEl).tooltip();
      }
    });
  } catch (e) { /* noop */ }

  // Real-time validation feedback
  if (form) {
    var inputs = form.querySelectorAll('input, select, textarea');
    Array.prototype.forEach.call(inputs, function(input){
      input.addEventListener('blur', function() {
        validateField(this);
      });

      input.addEventListener('input', function() {
        if (this.classList.contains('is-invalid')) {
          validateField(this);
        }
      });
    });
  }

  function validateField(field) {
    var value = (field.value || '').trim();
    var isRequired = field.hasAttribute('required') || (field.labels && field.labels[0] && field.labels[0].classList && field.labels[0].classList.contains('required'));
    
    if (isRequired && !value) {
      field.classList.add('is-invalid');
      field.classList.remove('is-valid');
    } else if (value) {
      field.classList.remove('is-invalid');
      field.classList.add('is-valid');
    } else {
      field.classList.remove('is-invalid');
      field.classList.remove('is-valid');
    }
  }

  // Vendor remote suggestions and selection
  // Desativado: bloco antigo de sugestões (envolvido por if(false))
  if (false) {
  var vendorInput = document.getElementById('vendor_name');
  var vendorIdInput = document.getElementById('vendor_id');
  var suggestionsEl = document.getElementById('vendor_suggestions');
  var vendorClearBtn = document.getElementById('vendor_clear');
  var vendorLoadingEl = document.getElementById('vendor_loading');
  var vendorStatusEl = document.getElementById('vendor_status');

  if (vendorInput && suggestionsEl && vendorIdInput) {
    var controller = null;
    var debounceTimer = null;
    var isFetching = false;
    var activeIndex = -1;
    var hideSuggestions = function() {
      suggestionsEl.classList.add('d-none');
      var toRemove = suggestionsEl.querySelectorAll('.list-group-item');
      Array.prototype.forEach.call(toRemove, function(el){ if (el && el.parentNode) el.parentNode.removeChild(el); });
      activeIndex = -1;
    };
    var showSuggestions = function() { suggestionsEl.classList.remove('d-none'); };
    var setFetching = function(fetching) {
      isFetching = fetching;
      if (vendorLoadingEl) vendorLoadingEl.hidden = !fetching;
      if (submitBtn) submitBtn.disabled = fetching;
    };
    var updateStatus = function(text) { if (vendorStatusEl) vendorStatusEl.textContent = text; };

    // Clear vendor selection
    if (vendorClearBtn) {
      vendorClearBtn.addEventListener('click', function() {
        vendorInput.value = '';
        vendorIdInput.value = '';
        hideSuggestions();
        updateStatus('Fornecedor limpo');
      });
    }

    vendorInput.addEventListener('input', function() {
      const q = vendorInput.value.trim();
      vendorIdInput.value = '';
      if (debounceTimer) { clearTimeout(debounceTimer); }
      if (!q || q.length < 2) { hideSuggestions(); return; }
      debounceTimer = setTimeout(async function() {
        if (controller && typeof controller.abort === 'function') controller.abort();
        controller = (typeof window.AbortController !== 'undefined') ? new AbortController() : null;
        try {
          setFetching(true);
          var url = '/api/v1/vendors?q=' + encodeURIComponent(q) + '&limit=8';
          var res = await fetch(url, controller ? { signal: controller.signal } : {});
          var json = await res.json();
          var items = (json && json.data) ? json.data : [];
          hideSuggestions();
          Array.prototype.forEach.call(items, function(v){
            var a = document.createElement('a');
            a.href = '#';
            a.className = 'list-group-item list-group-item-action';
            a.textContent = v.name;
            a.setAttribute('role', 'option');
            a.addEventListener('click', function(ev) {
              ev.preventDefault();
              vendorInput.value = v.name;
              vendorIdInput.value = v.id;
              hideSuggestions();
              updateStatus('Fornecedor selecionado: ' + v.name);
              // Após selecionar o fornecedor, preparar o campo de produto e exibir lista
              try {
                if (productIdInput) productIdInput.value = '';
                if (productInput) {
                  productInput.value = '';
                  // Focar o campo para disparar o carregamento inicial de sugestões
                  productInput.focus();
                }
                // Carregar metadados agregados do vendor
                try { if (vendorIdInput && vendorIdInput.value) { window.loadVendorMetadata && window.loadVendorMetadata(String(vendorIdInput.value)); } } catch (_) {}
              } catch (e) { /* noop */ }
            });
            suggestionsEl.appendChild(a);
          });
          if (items.length) {
            showSuggestions();
            activeIndex = 0;
            var options = suggestionsEl.querySelectorAll('.list-group-item');
            var first = options[activeIndex];
            if (first && first.classList) first.classList.add('active');
            updateStatus(items.length + ' fornecedor(es) encontrados');
          } else {
            hideSuggestions();
            updateStatus('Nenhum fornecedor encontrado');
          }
        } catch (err) {
          hideSuggestions();
          updateStatus('Falha ao carregar fornecedores');
        } finally {
          setFetching(false);
        }
      }, 250);
    });

    vendorInput.addEventListener('blur', function() {
      setTimeout(hideSuggestions, 150);
    });

    // Keyboard navigation for suggestions
    vendorInput.addEventListener('keydown', function(ev) {
      var optionsNode = suggestionsEl.querySelectorAll('.list-group-item');
      var options = Array.prototype.slice.call(optionsNode);
      if (!options.length || suggestionsEl.classList.contains('d-none')) return;
      if (ev.key === 'ArrowDown') {
        ev.preventDefault();
        var cur = options[activeIndex];
        if (cur && cur.classList) cur.classList.remove('active');
        activeIndex = (activeIndex + 1) % options.length;
        var next = options[activeIndex];
        if (next && next.classList) next.classList.add('active');
      } else if (ev.key === 'ArrowUp') {
        ev.preventDefault();
        var cur2 = options[activeIndex];
        if (cur2 && cur2.classList) cur2.classList.remove('active');
        activeIndex = (activeIndex - 1 + options.length) % options.length;
        var prev = options[activeIndex];
        if (prev && prev.classList) prev.classList.add('active');
      } else if (ev.key === 'Enter') {
        ev.preventDefault();
        var el = options[activeIndex];
        if (el) el.click();
      } else if (ev.key === 'Escape') {
        hideSuggestions();
      }
    });
  }

  }
  // Show success toast on form submission
  function showToast(message, type = 'success') {
    if (typeof window.safeNotify === 'function') {
      const titleMap = { success: 'Sucesso', error: 'Erro', warning: 'Aviso', info: 'Informação' };
      window.safeNotify(type, titleMap[type] || 'Informação', message, 5000);
      return;
    }
    var toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) return;
    var toastId = 'toast-' + Date.now();
    var iconName = (type === 'success') ? 'check-circle' : 'exclamation-triangle';
    var toastHTML = (
      '<div class="toast align-items-center text-bg-' + type + ' border-0" role="alert" aria-live="assertive" aria-atomic="true" id="' + toastId + '">' +
      '<div class="d-flex">' +
      '<div class="toast-body">' +
      '<i class="bi bi-' + iconName + ' me-2"></i>' +
      String(message) +
      '</div>' +
      '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>' +
      '</div>' +
      '</div>'
    );
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    var toastElement = document.getElementById(toastId);
    var toastInst = (typeof window.getToastInstance === 'function') ? window.getToastInstance(toastElement, { delay: 5000 }) : null;
    if (toastInst && toastInst.show) toastInst.show();
    
    if (toastElement) {
      toastElement.addEventListener('hidden.bs.toast', function() {
        if (this && this.parentNode) { this.parentNode.removeChild(this); }
      });
    }
  }
});
</script>
<script nonce="{{ nonce }}">
// Metadados de produto/vendor: modelos, SO, versões (escopo global)
(function(){
  function setDatalist(listEl, items){
    if (!listEl) return;
    listEl.innerHTML = '';
    const uniq = Array.from(new Set((items || []).filter(Boolean).map(s => String(s).trim()).filter(s => s.length)));
    uniq.slice(0, 500).forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      listEl.appendChild(opt);
    });
  }

  function normalizeFortinetOS(os){
    if (!os) return os;
    const s = String(os).trim();
    if (/^fortios\b/i.test(s)) return 'FortiOS';
    if (/^fortiweb\b/i.test(s)) return 'FortiWeb';
    if (/^fortiproxy\b/i.test(s)) return 'FortiProxy';
    if (/^fortimanager\b/i.test(s)) return 'FortiManager';
    return s;
  }

  function normalizeVersion(v){
    if (!v) return v;
    const s = String(v).trim();
    const m = s.match(/v?\s*(\d+(?:\.\d+){0,3})/i);
    const b = s.match(/build\s*(\d+)/i);
    if (m) {
      return b ? `${m[1]} build ${b[1]}` : m[1];
    }
    return s;
  }

  async function loadVendorMetadata(vendorId){
    const vendorIdInput = document.getElementById('vendor_id');
    const vendorName = (document.getElementById('vendor_name')?.value || '').trim().toLowerCase();
    const modelList = document.getElementById('model_list');
    const osList = document.getElementById('os_list');
    const versionList = document.getElementById('version_list');
    if (!vendorId) return;
    try {
      const url = new URL(`/api/products/vendors/${vendorId}/metadata`, window.location.origin);
      const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return;
      const json = await res.json().catch(() => ({}));
      const osItems = (vendorName === 'fortinet')
        ? (json.operating_systems || []).map(normalizeFortinetOS)
        : (json.operating_systems || []);
      setDatalist(modelList, json.models || []);
      setDatalist(osList, osItems);
      setDatalist(versionList, (json.versions || []).map(normalizeVersion));
    } catch (e) { /* noop */ }
  }

  async function loadProductMetadata(productId){
    const modelList = document.getElementById('model_list');
    const osList = document.getElementById('os_list');
    const versionList = document.getElementById('version_list');
    if (!productId) return;
    try {
      const url = new URL(`/api/products/${productId}/metadata`, window.location.origin);
      const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return;
      const json = await res.json().catch(() => ({}));
      setDatalist(modelList, json.models || []);
      setDatalist(osList, (json.operating_systems || []).map(normalizeFortinetOS));
      setDatalist(versionList, (json.versions || []).map(normalizeVersion));
    } catch (e) { /* noop */ }
  }

  // Expor globalmente
  window.loadVendorMetadata = loadVendorMetadata;
  window.loadProductMetadata = loadProductMetadata;

  // Normalização automática de versão ao sair do campo
  const versionInput = document.getElementById('installed_version');
  versionInput?.addEventListener('blur', function(){
    const v = (versionInput.value || '').trim();
    if (!v) return;
    versionInput.value = normalizeVersion(v);
  });

  // Carregar metadados se já houver vendor selecionado ao abrir a página
  const initialVendorId = (document.getElementById('vendor_id')?.value || '').trim();
  if (initialVendorId) {
    loadVendorMetadata(initialVendorId);
  }

  // Disparar carregamento inicial de produtos com base no fornecedor selecionado
  const vendorSelectEl = document.getElementById('vendor_name');
  if (vendorSelectEl && vendorSelectEl.value) {
    (async () => {
      try {
        const vName = vendorSelectEl.value.trim().toLowerCase();
        const vid = await (window.resolveVendorIdByName ? window.resolveVendorIdByName(vName) : (async function(name){
          try {
            const url = new URL('/api/v1/vendors', window.location.origin);
            url.searchParams.set('q', name);
            url.searchParams.set('limit', '1');
            const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
            if (!res.ok) return null;
            const json = await res.json().catch(() => ({}));
            const items = Array.isArray(json?.data) ? json.data : [];
            return items.length ? items[0].id : null;
          } catch (_) { return null; }
        })(vName));
        if (vid) {
          const vendorIdInput = document.getElementById('vendor_id');
          if (vendorIdInput) vendorIdInput.value = String(vid);
          if (typeof window.loadVendorMetadata === 'function') window.loadVendorMetadata(String(vid));
          if (typeof window.loadAllProductsForVendorId === 'function') {
            window.loadAllProductsForVendorId(vid);
          } else {
            // Fallback direto
            const url = new URL(`/api/products/vendors/${vid}`, window.location.origin);
            const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
            const json = await res.json().catch(() => ({}));
            const items = Array.isArray(json?.items) ? json.items : [];
            const select = document.getElementById('product_select');
            if (select) {
              select.innerHTML = '';
              const defaultOpt = document.createElement('option');
              defaultOpt.value = '';
              defaultOpt.textContent = 'Selecione um produto';
              defaultOpt.disabled = true;
              defaultOpt.selected = true;
              select.appendChild(defaultOpt);
              items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = String(item.id || '');
                opt.textContent = item.name || String(item.id || '');
                select.appendChild(opt);
              });
            }
          }
        } else {
          // Fallback por nome
          if (typeof window.loadAllProductsForVendorName === 'function') window.loadAllProductsForVendorName(vName);
        }
      } catch (_) { /* noop */ }
    })();
  }
})();
</script>
{% endblock %}
