{% extends 'core/base.html' %}

{% block title %}Lista de Ativos{% endblock %}

{% block extra_css %}
  {# Removido: CSS de página já importado via main.css #}
{% endblock %}

{% block content %}
<div class="container-fluid py-4 fade-in">
  {% import 'core/asset_macros.html' as assetui %}
  <!-- Page Header -->
  <header class="page-header mb-5">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div>
        <h1 class="h3 fw-semibold mb-2">
          <i class="bi bi-server me-2 text-primary"></i>
          Lista de Ativos
        </h1>
        <p class="text-muted fs-6 mb-0">
          Gerencie todos os ativos de infraestrutura do sistema
        </p>
      </div>
      <a href="{{ url_for('asset.create_asset') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle me-2"></i>Adicionar Novo Ativo
      </a>
    </div>
  </header>

  <!-- Search and Filter Bar -->
  <div class="search-filter-bar">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="search-input-group">
          <i class="bi bi-search search-icon"></i>
          <input type="text" class="form-control" placeholder="Buscar por nome, IP ou responsável..." id="asset-search">
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex gap-2 justify-content-md-end mt-3 mt-md-0">
          <select class="form-select" style="width: auto;" id="status-filter">
            <option value="">Todos os status</option>
            <option value="active">Ativo</option>
            <option value="inactive">Inativo</option>
            <option value="maintenance">Manutenção</option>
            <option value="warning">Alerta</option>
          </select>
          <button class="btn btn-outline-secondary" id="clear-filters">
            <i class="bi bi-x-circle"></i>
            Limpar filtros
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Asset Table -->
  <div class="asset-table-container mt-4">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>
              <i class="bi bi-hdd-network me-1"></i>Ativo
            </th>
            <th>
              <i class="bi bi-diagram-3 me-1"></i>Tipo
            </th>
            <th>
              <i class="bi bi-building me-1"></i>Fornecedor
            </th>
            <th>
              <i class="bi bi-globe me-1"></i>IP
            </th>
            <th>
              <i class="bi bi-geo-alt me-1"></i>Localização
            </th>
            <th>
              <i class="bi bi-person-badge me-1"></i>Responsável
            </th>
            <th>
              <i class="bi bi-activity me-1"></i>Status
            </th>
            <th>
              <i class="bi bi-gear me-1"></i>Ações
            </th>
          </tr>
        </thead>
        <tbody>
          {% for asset in assets %}
            <tr data-asset-id="{{ asset.id }}">
              <td>
                <div class="d-flex align-items-center gap-3">
                  <div class="avatar bg-light rounded-circle p-2">
                    <i class="bi bi-hdd-network text-primary"></i>
                  </div>
                  <div>
                    <a href="{{ url_for('asset.asset_detail', asset_id=asset.id) }}" class="fw-semibold text-decoration-none">{{ asset.name }}</a>
                    <div class="text-muted small">Criado por {{ asset.owner.username if asset.owner else 'N/A' }}</div>
                  </div>
                </div>
              </td>
              <td>{{ assetui.type_badge(asset.asset_type_safe) }}</td>
              <td>
                {{ assetui.vendor_badge(asset.vendor.name if asset.vendor else None) }}
              </td>
              <td><code>{{ asset.ip_address }}</code></td>
              <td><span class="text-muted">N/A</span></td>
              <td><span class="text-muted">{{ asset.owner.username if asset.owner else 'N/A' }}</span></td>
              <td>
                {{ assetui.status_badge(asset.status) }}
              </td>
              <td>
                <div class="btn-group" role="group" aria-label="Ações">
                  <a href="{{ url_for('asset.asset_detail', asset_id=asset.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Detalhes">
                    <i class="bi bi-eye"></i>
                  </a>
                  <a href="{{ url_for('asset.edit_asset', asset_id=asset.id) }}" class="btn btn-sm btn-outline-secondary" data-bs-toggle="tooltip" title="Editar">
                    <i class="bi bi-pencil"></i>
                  </a>
                  {% if asset.owner and asset.owner.id == current_user.id %}
                  <button class="btn btn-sm btn-outline-danger delete-asset-btn"
                          data-asset-id="{{ asset.id }}"
                          data-asset-name="{{ asset.name }}"
                          data-delete-url="{{ url_for('asset.delete_asset', asset_id=asset.id) }}"
                          data-bs-toggle="tooltip" title="Excluir">
                    <i class="bi bi-trash"></i>
                  </button>
                  {% else %}
                  <button class="btn btn-sm btn-outline-secondary" disabled data-bs-toggle="tooltip" title="Somente o proprietário pode excluir">
                    <i class="bi bi-lock"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div>
        {% if pagination %}
          {% set start_idx = ((page - 1) * per_page) + 1 %}
          {% set end_idx = ((page - 1) * per_page) + (assets|length) %}
          <span class="text-muted">
            Mostrando <span id="current-range">{{ start_idx }}-{{ end_idx }}</span>
            de <span id="total-assets">{{ pagination.total }}</span> ativos
          </span>
        {% else %}
          <span class="text-muted">Mostrando <span id="current-range">1-{{ assets|length }}</span> de <span id="total-assets">{{ assets|length }}</span> ativos</span>
        {% endif %}
      </div>
      <div class="pagination-controls">
        {% if pagination %}
          <nav aria-label="Paginação de ativos">
            <ul class="pagination mb-0">
              <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                <a class="page-link" href="{{ url_for('asset.list_assets', page=(page-1), per_page=per_page, vendor_ids=(selected_vendor_ids|join(',')) if selected_vendor_ids else None) }}" aria-label="Anterior">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="page-item disabled"><a class="page-link" href="#">Página {{ page }} de {{ pagination.pages }}</a></li>
              <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                <a class="page-link" href="{{ url_for('asset.list_assets', page=(page+1), per_page=per_page, vendor_ids=(selected_vendor_ids|join(',')) if selected_vendor_ids else None) }}" aria-label="Próxima">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        {% else %}
          <div class="d-flex align-items-center">
            <div class="mx-2">Página <span id="current-page">1</span></div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteAssetModal" tabindex="-1" aria-labelledby="deleteAssetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-semibold" id="deleteAssetModalLabel">
          <i class="bi bi-exclamation-triangle text-warning me-2"></i>
          Confirmar Exclusão
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Tem certeza que deseja excluir o ativo <strong id="asset-name-to-delete"></strong>?</p>
        <div class="alert alert-warning d-flex align-items-center" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <div>Esta ação não pode ser desfeita.</div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Cancelar
        </button>
        <form method="POST" id="delete-asset-form" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger" id="delete-btn">
            <i class="bi bi-trash me-1"></i>
            <span class="btn-text">Excluir Ativo</span>
            <span class="btn-loading d-none">
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              Excluindo...
            </span>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast for Feedback -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="feedback-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="bi bi-check-circle-fill text-success me-2"></i>
      <strong class="me-auto">Sucesso</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      Operação realizada com sucesso!
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ nonce }}">
// Asset management functionality
// Executa após o DOM estar pronto para garantir que base.js esteja carregado

document.addEventListener('DOMContentLoaded', function() {
  'use strict';
  
  // Delete asset functionality
  var deleteButtons = document.querySelectorAll('.delete-asset-btn');
  var modalEl = document.getElementById('deleteAssetModal');
  var getModalSafely = (typeof window.getModalInstance === 'function')
    ? window.getModalInstance
    : function(el, options) {
        if (!el) return null;
        try {
          if (typeof window.bootstrap !== 'undefined' && bootstrap.Modal) {
            return bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el, options);
          }
        } catch (e) {
          try { console.warn('Bootstrap Modal init failed:', e); } catch(_){}
        }
        return {
          show: function() {
            el.classList.add('show');
            el.style.display = 'block';
            document.body.classList.add('modal-open');
          },
          hide: function() {
            el.classList.remove('show');
            el.style.display = 'none';
            document.body.classList.remove('modal-open');
            var backs = document.querySelectorAll('.modal-backdrop');
            Array.prototype.forEach.call(backs, function(b){ if (b && b.parentNode) b.parentNode.removeChild(b); });
          }
        };
      };
  var deleteModal = getModalSafely(modalEl);
  var deleteForm = document.getElementById('delete-asset-form');
  var assetNameElement = document.getElementById('asset-name-to-delete');
  var currentAssetId = null;
  var cancelBtn = modalEl ? modalEl.querySelector('button[data-bs-dismiss="modal"]') : null;
  var closeBtn = modalEl ? modalEl.querySelector('.btn-close') : null;
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function(){ if (deleteModal && deleteModal.hide) deleteModal.hide(); });
  }
  if (closeBtn) {
    closeBtn.addEventListener('click', function(){ if (deleteModal && deleteModal.hide) deleteModal.hide(); });
  }
  if (modalEl) {
    modalEl.addEventListener('shown.bs.modal', function(){
      modalEl.style.pointerEvents = 'auto';
      modalEl.style.zIndex = '1055';
      var scrim = document.querySelector('.sidebar-scrim');
      if (scrim) { scrim.classList.remove('visible'); }
    });
    modalEl.addEventListener('hidden.bs.modal', function(){ modalEl.style.pointerEvents = ''; modalEl.style.zIndex = ''; var backs = document.querySelectorAll('.modal-backdrop'); Array.prototype.forEach.call(backs, function(b){ if (b && b.parentNode) b.parentNode.removeChild(b); }); });
  }
  
  Array.prototype.forEach.call(deleteButtons, function(button){
    button.addEventListener('click', function() {
      var assetId = this.dataset.assetId;
      var assetName = this.dataset.assetName;
      var deleteUrl = this.dataset.deleteUrl || ('/assets/' + assetId + '/delete');
      currentAssetId = assetId;
      
      if (assetNameElement) assetNameElement.textContent = assetName;
      if (deleteForm) deleteForm.action = deleteUrl;
      var backs = document.querySelectorAll('.modal-backdrop');
      Array.prototype.forEach.call(backs, function(b){ if (b && b.parentNode) b.parentNode.removeChild(b); });
      if (modalEl) { modalEl.style.zIndex = '1055'; modalEl.style.pointerEvents = 'auto'; }
      if (deleteModal && deleteModal.show) deleteModal.show();
    });
  });

  // Intercepta o submit para exclusão via AJAX com toast
  if (deleteForm) {
    deleteForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      var submitBtn = document.getElementById('delete-btn');
      if (submitBtn) {
        submitBtn.disabled = true;
        var btnTextEl = submitBtn.querySelector('.btn-text');
        var btnLoadEl = submitBtn.querySelector('.btn-loading');
        if (btnTextEl) btnTextEl.classList.add('d-none');
        if (btnLoadEl) btnLoadEl.classList.remove('d-none');
      }

      try {
        var formData = new FormData(deleteForm);
        var csrfMeta = document.querySelector('meta[name="csrf-token"]');
        var csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';
        var res = await fetch(deleteForm.action, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });

        var contentType = (res.headers.get('content-type') || '').toLowerCase();
        var isJson = contentType.indexOf('application/json') !== -1;
        var data = {};
        var textBody = '';
        if (isJson) {
          try { data = await res.json(); } catch(_) { data = {}; }
        } else {
          try { textBody = await res.text(); } catch(_) { textBody = ''; }
        }
        if (!res.ok) {
          var msg = (data && data.message) ? data.message : '';
          var csrfDetected = false;
          if (!msg && textBody) {
            try {
              if (/csrf/i.test(textBody)) {
                msg = 'Falha de CSRF ao excluir. Atualizando a página...';
                csrfDetected = true;
              }
            } catch(_) {}
          }
          if (csrfDetected) {
            if (deleteModal && deleteModal.hide) { deleteModal.hide(); }
            if (typeof window.safeNotify === 'function') {
              window.safeNotify('warning', null, msg, 2500);
            }
            setTimeout(function(){ window.location.reload(); }, 1200);
            return;
          }
          throw new Error(msg || ('Falha ao excluir ativo (status ' + res.status + ')'));
        }

        // Fechar modal
        if (deleteModal && deleteModal.hide) { deleteModal.hide(); }

        // Remover linha da tabela
        if (currentAssetId) {
          var row = document.querySelector('tr[data-asset-id="' + currentAssetId + '"]');
          if (row && row.parentNode) row.parentNode.removeChild(row);
        }

        // Atualizar contadores
        var rows = document.querySelectorAll('tbody tr');
        var totalEl = document.getElementById('total-assets');
        var rangeEl = document.getElementById('current-range');
        if (totalEl) totalEl.textContent = rows.length;
        if (rangeEl) rangeEl.textContent = rows.length ? ('1-' + rows.length) : '0-0';

        // Mostrar toast de sucesso
        if (typeof window.safeNotify === 'function') {
          window.safeNotify('success', null, 'Ativo removido com sucesso.', 4000);
        } else {
          var toastEl = document.getElementById('feedback-toast');
          var toastInst = (typeof window.getToastInstance === 'function') ? window.getToastInstance(toastEl, { delay: 4000 }) : null;
          var toastIcon = document.querySelector('#feedback-toast .toast-header i');
          var toastTitle = document.querySelector('#feedback-toast .toast-header strong');
          var toastBody = document.querySelector('#feedback-toast .toast-body');
          if (toastIcon) toastIcon.className = 'bi bi-check-circle-fill text-success me-2';
          if (toastTitle) toastTitle.textContent = 'Excluído';
          if (toastBody) toastBody.textContent = 'Ativo removido com sucesso.';
          if (toastInst && toastInst.show) toastInst.show();
        }

      } catch (err) {
        if (typeof window.safeNotify === 'function') {
          window.safeNotify('error', null, (err && err.message) ? err.message : 'Erro ao excluir ativo.', 5000);
        } else {
          var toastEl2 = document.getElementById('feedback-toast');
          var toast2 = (typeof window.getToastInstance === 'function') ? window.getToastInstance(toastEl2, { delay: 5000 }) : null;
          var toastIcon2 = document.querySelector('#feedback-toast .toast-header i');
          var toastTitle2 = document.querySelector('#feedback-toast .toast-header strong');
          var toastBody2 = document.querySelector('#feedback-toast .toast-body');
          if (toastIcon2) toastIcon2.className = 'bi bi-exclamation-triangle text-warning me-2';
          if (toastTitle2) toastTitle2.textContent = 'Erro';
          if (toastBody2) toastBody2.textContent = (err && err.message) ? err.message : 'Erro ao excluir ativo.';
          if (toast2 && toast2.show) toast2.show();
        }
      } finally {
        if (submitBtn) {
          var btnLoadEl2 = submitBtn.querySelector('.btn-loading');
          var btnTextEl2 = submitBtn.querySelector('.btn-text');
          if (btnLoadEl2) btnLoadEl2.classList.add('d-none');
          if (btnTextEl2) btnTextEl2.classList.remove('d-none');
          submitBtn.disabled = false;
        }
      }
    });
  }
  
  // Search functionality
  var searchInput = document.getElementById('asset-search');
  var statusFilter = document.getElementById('status-filter');
  
  function filterAssets() {
    var searchTerm = (searchInput && searchInput.value ? searchInput.value : '').toLowerCase();
    var status = (statusFilter && statusFilter.value ? statusFilter.value : '').toLowerCase();
    
    var rows = document.querySelectorAll('tbody tr');
    var visibleCount = 0;
    
    Array.prototype.forEach.call(rows, function(row){
      var nameCell = row.querySelector('.fw-semibold');
      var ipCell = row.querySelector('code');
      var ownerCell = row.querySelector('.text-muted');
      var statusBadge = row.querySelector('.status-badge');
      
      var name = nameCell ? nameCell.textContent.toLowerCase() : '';
      var ip = ipCell ? ipCell.textContent.toLowerCase() : '';
      var owner = ownerCell ? ownerCell.textContent.toLowerCase() : '';
      var rowStatus = statusBadge ? statusBadge.textContent.toLowerCase() : '';
      
      var matchesSearch = !searchTerm || name.indexOf(searchTerm) !== -1 || ip.indexOf(searchTerm) !== -1 || owner.indexOf(searchTerm) !== -1;
      var matchesStatus = !status || rowStatus.indexOf(status) !== -1;
      
      var visible = matchesSearch && matchesStatus;
      row.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });
    
    // Update result count
    var totalEl2 = document.getElementById('total-assets');
    var rangeEl2 = document.getElementById('current-range');
    if (totalEl2) totalEl2.textContent = visibleCount;
    if (rangeEl2) rangeEl2.textContent = visibleCount ? ('1-' + visibleCount) : '0-0';
  }
  
  if (searchInput) { searchInput.addEventListener('input', filterAssets); }
  if (statusFilter) { statusFilter.addEventListener('change', filterAssets); }
  
  var clearBtn = document.getElementById('clear-filters');
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      filterAssets();
    });
  }
});
</script>
{% endblock %}
