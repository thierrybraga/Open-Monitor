{% extends "core/base.html" %}

{% block title %}Relatório de Risco - {{ cve_id }}{% endblock %}

{% block extra_css %}
<style>
    .risk-report-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-lg);
    }
    
    .report-header {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-600) 100%);
        color: white;
        padding: var(--space-xl);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-xl);
        box-shadow: var(--shadow-lg);
    }
    
    .report-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-subtle);
    }
    
    .report-content h1,
    .report-content h2,
    .report-content h3 {
        color: var(--content-strong);
        margin-top: var(--space-lg);
        margin-bottom: var(--space-md);
    }
    
    .report-content h1 {
        font-size: var(--font-size-2xl);
        border-bottom: 2px solid var(--color-primary);
        padding-bottom: var(--space-sm);
    }
    
    .report-content h2 {
        font-size: var(--font-size-xl);
        color: var(--color-primary);
    }
    
    .report-content h3 {
        font-size: var(--font-size-lg);
    }
    
    .report-content p {
        line-height: 1.6;
        margin-bottom: var(--space-md);
        color: var(--content-medium);
    }
    
    .report-content ul,
    .report-content ol {
        margin-bottom: var(--space-md);
        padding-left: var(--space-lg);
    }
    
    .report-content li {
        margin-bottom: var(--space-xs);
        color: var(--content-medium);
    }
    
    .report-content strong {
        color: var(--content-strong);
        font-weight: var(--font-weight-semibold);
    }
    
    .report-content code {
        background: var(--surface-1);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-family: var(--font-mono);
        color: var(--color-primary);
    }
    
    .report-content pre {
        background: var(--surface-1);
        padding: var(--space-md);
        border-radius: var(--radius-md);
        overflow-x: auto;
        border: 1px solid var(--border-subtle);
    }
    
    .report-actions {
        margin-top: var(--space-xl);
        display: flex;
        gap: var(--space-md);
        flex-wrap: wrap;
    }
    
    .btn-print {
        background: var(--color-success);
        border-color: var(--color-success);
    }
    
    .btn-print:hover {
        background: var(--color-success-600);
        border-color: var(--color-success-600);
    }
    
    .btn-export {
        background: var(--color-info);
        border-color: var(--color-info);
    }
    
    .btn-export:hover {
        background: var(--color-info-600);
        border-color: var(--color-info-600);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .loading-spinner {
        background: white;
        padding: var(--space-xl);
        border-radius: var(--radius-lg);
        text-align: center;
        box-shadow: var(--shadow-xl);
    }
    
    .spinner {
        border: 4px solid var(--border-subtle);
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--space-md);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media print {
        .report-actions,
        .navbar,
        .footer {
            display: none !important;
        }
        
        .risk-report-container {
            max-width: none;
            margin: 0;
            padding: 0;
        }
        
        .report-header,
        .report-content {
            box-shadow: none;
            border: none;
        }
    }
    
    @media (max-width: 768px) {
        .risk-report-container {
            padding: var(--space-md);
        }
        
        .report-header {
            padding: var(--space-lg);
        }
        
        .report-content {
            padding: var(--space-lg);
        }
        
        .report-actions {
            flex-direction: column;
        }
        
        .report-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="risk-report-container">
    <!-- Cabeçalho do Relatório -->
    <div class="report-header">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div>
                <h1 class="h2 mb-2">
                    <i class="fas fa-shield-alt me-2"></i>
                    Relatório de Análise de Risco
                </h1>
                <p class="mb-0 opacity-90">
                    <strong>CVE:</strong> {{ cve_id }}
                </p>
                <p class="mb-0 opacity-90">
                    <strong>Gerado em:</strong> {{ generated_at | datetimeformat('%d/%m/%Y %H:%M') }}
                </p>
            </div>
            <div class="text-end">
                {% if vulnerability.base_severity %}
                    {% set severity_class = {
                        'LOW': 'success',
                        'MEDIUM': 'warning', 
                        'HIGH': 'danger',
                        'CRITICAL': 'danger'
                    }[vulnerability.base_severity] or 'secondary' %}
                    <span class="badge bg-{{ severity_class }} fs-6 px-3 py-2">
                        {{ vulnerability.base_severity }}
                    </span>
                {% endif %}
                {% if vulnerability.cvss_score %}
                    <div class="mt-2">
                        <small class="opacity-75">CVSS Score</small>
                        <div class="h4 mb-0">{{ "%.1f"|format(vulnerability.cvss_score) }}</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <style>
        .report-layout{display:grid;grid-template-columns:320px minmax(860px,1fr);gap:2rem;align-items:start}
        .report-layout.collapsed{grid-template-columns:1fr}
        .report-layout.collapsed .report-summary{display:none}
        .report-toc{position:sticky;top:1rem;border:1px solid var(--border-subtle,#e5e7eb);border-radius:12px;padding:1rem;background:var(--surface-0,#fff)}
        .report-toc-title{font-weight:600;margin-bottom:.75rem}
        .report-toc ul{list-style:none;padding:0;margin:0}
        .report-toc li{margin:.25rem 0}
        .report-toc a{display:block;color:var(--content-strong,#111827);text-decoration:none;padding:.25rem .5rem;border-radius:8px}
        .report-toc a:hover{background:var(--surface-1,#f8f9fa)}
        .report-content{min-height:300px;max-width:clamp(860px,75vw,1280px)}
        .markdown-body{line-height:1.75;color:var(--content-strong,#111827)}
        .markdown-body h1,.markdown-body h2,.markdown-body h3{margin-top:1.25rem;margin-bottom:.75rem;font-weight:700}
        .markdown-body h1{font-size:1.75rem}
        .markdown-body h2{font-size:1.35rem;border-bottom:1px solid var(--border-subtle,#e5e7eb);padding-bottom:.35rem}
        .markdown-body h3{font-size:1.1rem;color:var(--content-medium,#374151)}
        .markdown-body p{margin:.75rem 0}
        .markdown-body ul,.markdown-body ol{margin:.65rem 0 .85rem .95rem}
        .markdown-body li{margin:.25rem 0}
        .markdown-body blockquote{border-left:4px solid var(--border-medium,#d1d5db);padding:.5rem 1rem;background:var(--surface-1,#f9fafb);border-radius:8px;color:var(--content-medium,#374151)}
        .markdown-body table{width:100%;border-collapse:collapse;margin:1rem 0;border:1px solid var(--border-subtle,#e5e7eb);border-radius:8px;overflow:hidden}
        .markdown-body th,.markdown-body td{border:1px solid var(--border-subtle,#e5e7eb);padding:.5rem .75rem;text-align:left}
        .markdown-body thead th{background:var(--surface-50,#f3f4f6)}
        .markdown-body pre{position:relative;background:#0f172a;color:#e5e7eb;padding:1rem;border-radius:12px;overflow:auto}
        .code-copy{position:absolute;top:.5rem;right:.5rem;background:#1f2937;color:#fff;border:none;border-radius:6px;padding:.25rem .5rem;font-size:.85rem}
        .anchor-link{color:var(--content-medium,#6b7280);text-decoration:none;margin-left:.4rem;font-size:.85rem}
        .report-actions{display:flex;gap:.75rem;margin-top:1.5rem}
        .btn-print,.btn-export{border:none;border-radius:10px;padding:.5rem 1rem}
        .btn-print{background:#6c757d}
        .btn-export{background:#0d6efd}
        @media(max-width:992px){.report-layout{grid-template-columns:1fr}.report-toc{position:relative}}
        @media print{.report-toc,.report-actions,.alert{display:none}}
    </style>
    <style>
        .report-summary{position:sticky;top:1rem;border:1px solid var(--border-subtle,#e5e7eb);border-radius:12px;padding:1rem;background:var(--surface-0,#fff)}
        .summary-section{margin-bottom:1rem}
        .summary-section h5{margin:0 0 .5rem 0;font-weight:600;color:var(--content-strong,#111827)}
        .summary-item{display:flex;justify-content:space-between;margin:.25rem 0;color:var(--content-medium,#374151)}
        .summary-badge{display:inline-block;padding:.25rem .5rem;border-radius:8px;background:var(--surface-1,#f8f9fa);font-size:.85rem}
    </style>
    <div class="report-layout">
        <aside class="report-summary">
            {% set metric = None %}
            {% for m in vulnerability.metrics %}
                {% if m.is_primary %}
                    {% set metric = m %}
                {% endif %}
            {% endfor %}
            {% if not metric and vulnerability.metrics and vulnerability.metrics|length > 0 %}
                {% set metric = vulnerability.metrics[0] %}
            {% endif %}
            <div class="summary-section">
                <h5>Pré-requisitos Técnicos</h5>
                <div class="summary-item"><span>Vetor de ataque</span><span class="summary-badge">{{ (metric.attack_vector or metric.access_vector) if metric else 'N/A' }}</span></div>
                <div class="summary-item"><span>Complexidade</span><span class="summary-badge">{{ (metric.attack_complexity or metric.access_complexity) if metric else 'N/A' }}</span></div>
                <div class="summary-item"><span>Privilégios</span><span class="summary-badge">{{ (metric.privileges_required or metric.authentication) if metric else 'N/A' }}</span></div>
                <div class="summary-item"><span>Interação do usuário</span><span class="summary-badge">{{ metric.user_interaction if metric else 'N/A' }}</span></div>
                <div class="summary-item"><span>Escopo</span><span class="summary-badge">{{ metric.scope if metric else 'N/A' }}</span></div>
            </div>
            <div class="summary-section">
                <h5>Metadados</h5>
                <div class="summary-item"><span>Publicado</span><span class="summary-badge">{{ vulnerability.published_date.strftime('%d/%m/%Y') if vulnerability.published_date else 'N/A' }}</span></div>
                <div class="summary-item"><span>Atualizado</span><span class="summary-badge">{{ vulnerability.last_update.strftime('%d/%m/%Y') if vulnerability.last_update else 'N/A' }}</span></div>
                <div class="summary-item"><span>Patch oficial</span><span class="summary-badge">{{ 'Sim' if vulnerability.patch_available else 'Não' }}</span></div>
                <div class="summary-item"><span>Status NVD</span><span class="summary-badge">{{ vulnerability.vuln_status or 'N/A' }}</span></div>
            </div>
        </aside>
        <div class="report-content">
            {% if risk_analysis %}
                {% if is_prompt %}
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-lightbulb"></i>
                        Este é um <strong>prompt estruturado</strong> para geração de relatório técnico. Copie e utilize com seu provedor LLM.
                    </div>
                {% endif %}
                <div id="markdown-container" class="markdown-body">{{ risk_analysis | markdown | safe }}</div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                    <h3>Relatório não disponível</h3>
                    <p class="text-muted">Não foi possível gerar o relatório de risco para esta vulnerabilidade.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Ações do Relatório -->
    <div class="report-actions">
        <button type="button" class="btn btn-print text-white" onclick="window.print()">
            <i class="fas fa-print me-2"></i>
            Imprimir Relatório
        </button>
        
        <button type="button" class="btn btn-export text-white" onclick="exportToPDF()">
            <i class="fas fa-file-pdf me-2"></i>
            Exportar PDF
        </button>
        
        <button type="button" class="btn btn-secondary" onclick="copyToClipboard()">
            <i class="fas fa-copy me-2"></i>
            {% if is_prompt %}Copiar Prompt{% else %}Copiar Conteúdo{% endif %}
        </button>
        
        <a href="{{ url_for('vulnerability_ui.vulnerability_details', cve_id=cve_id) }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>
            Voltar aos Detalhes
        </a>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="mb-0">Processando...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ nonce }}">
    const RAW_MD = {{ risk_analysis | tojson | safe if risk_analysis else '""' }};

    // Função para exportar para PDF
    function exportToPDF() {
        try {
            showLoading();
            const exportUrl = "{{ url_for('vulnerability_ui.export_risk_report_pdf', cve_id=cve_id) }}";
            // Navegar para a rota de exportação (inicia download)
            window.location.href = exportUrl;
        } catch (e) {
            console.error('Erro ao iniciar exportação PDF:', e);
            showToast('Erro ao iniciar exportação PDF', 'error');
        } finally {
            // Ocultar loading após breve intervalo para não travar UI
            setTimeout(hideLoading, 1200);
        }
    }
    
    // Função para copiar conteúdo para clipboard (usa Markdown bruto quando disponível)
    async function copyToClipboard() {
        try {
            const reportContent = document.querySelector('.report-content');
            const textContent = (typeof RAW_MD === 'string' && RAW_MD.trim().length > 0)
                ? RAW_MD
                : (reportContent ? reportContent.innerText : '');
            
            await navigator.clipboard.writeText(textContent);
            showToast('Conteúdo copiado para a área de transferência!', 'success');
        } catch (err) {
            console.error('Erro ao copiar:', err);
            showToast('Erro ao copiar conteúdo', 'error');
        }
    }
    
    // Função para mostrar loading
    function showLoading() {
        const el = document.getElementById('loadingOverlay');
        if (el) el.style.display = 'flex';
    }
    
    // Função para esconder loading
    function hideLoading() {
        const el = document.getElementById('loadingOverlay');
        if (el) el.style.display = 'none';
    }
    
    // Função para mostrar toast (feedback)
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
        toast.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        `;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => toast.parentNode && toast.parentNode.removeChild(toast), 300);
        }, 3000);
    }
    
    // Animações CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    // Melhorias de formatação pós-render
    document.addEventListener('DOMContentLoaded', function() {
        const reportContent = document.querySelector('.report-content');
        const layout = document.querySelector('.report-layout');
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn btn-sm btn-outline-secondary';
        toggleBtn.style.marginBottom = '0.75rem';
        toggleBtn.innerHTML = '<i class="bi bi-layout-sidebar-inset"></i> Alternar resumo';
        const header = document.querySelector('.report-header .d-flex');
        if (header) {
            const container = document.createElement('div');
            container.appendChild(toggleBtn);
            header.appendChild(container);
        }
        toggleBtn.addEventListener('click', ()=>{
            if (layout) {
                layout.classList.toggle('collapsed');
            }
        });
        if (reportContent) {
            const headings = reportContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headings.forEach(h => h.classList.add('fw-bold'));
            const lists = reportContent.querySelectorAll('ul, ol');
            lists.forEach(l => l.classList.add('mb-3'));
            const paragraphs = reportContent.querySelectorAll('p');
            paragraphs.forEach(p => { if (p.textContent.trim()) p.classList.add('mb-3'); });

            function slugify(text){
                return text.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
            }
            headings.forEach(h=>{
                const id = h.id || slugify(h.textContent.trim());
                h.id = id;
                const link = document.createElement('a');
                link.href = `#${id}`;
                link.className = 'anchor-link';
                link.textContent = '§';
                h.appendChild(link);
            });

            const pres = reportContent.querySelectorAll('.markdown-body pre');
            pres.forEach(pre=>{
                const btn = document.createElement('button');
                btn.className = 'code-copy';
                btn.textContent = 'Copiar';
                btn.addEventListener('click',()=>{
                    navigator.clipboard.writeText(pre.innerText).then(()=>{
                        showToast('Código copiado para a área de transferência!', 'success');
                    }).catch(()=>{
                        showToast('Erro ao copiar código', 'error');
                    });
                });
                pre.appendChild(btn);
            });
        }
    });
</script>
{% endblock %}
