/**
 * CVE History Chart Module
 * Gráfico interativo para visualizar histórico de CVEs por período
 * Responde aos filtros de severidade e CVSS Score
 */

class CVEHistoryChart {
    constructor() {
        this.chart = null;
        this.chartCanvas = document.getElementById('cveHistoryChart');
        this.chartLoading = document.getElementById('chartLoading');
        this.periodButtons = document.querySelectorAll('.period-btn');
        this.currentPeriod = '30';
        this.currentFilters = {};
        this.apiUrl = '/api/v1/vulnerabilities/history';
        
        this.init();
    }

    async init() {
        try {
            if (!this.chartCanvas) {
                this.showContainerMessage('Gráfico indisponível (canvas não encontrado)');
                return;
            }
            // Garante que Chart.js seja carregado (CSP-friendly) e disponível
            await this.loadChartJS();
            await this.waitForChartJS();
            // Configura event listeners
            this.setupEventListeners();
            // Carrega dados iniciais
            await this.loadData();
            console.log('CVE History Chart inicializado com sucesso');
        } catch (error) {
            console.error('Erro ao inicializar CVE History Chart:', error);
            this.showError('Erro ao carregar gráfico');
        }
    }

    async waitForChartJS() {
        return new Promise((resolve, reject) => {
            if (typeof Chart !== 'undefined') {
                resolve();
                return;
            }

            let attempts = 0;
            const maxAttempts = 50;
            
            const checkChart = () => {
                attempts++;
                if (typeof Chart !== 'undefined') {
                    resolve();
                } else if (attempts >= maxAttempts) {
                    reject(new Error('Chart.js não carregou a tempo'));
                } else {
                    setTimeout(checkChart, 100);
                }
            };
            
            checkChart();
        });
    }

    async loadChartJS() {
        if (typeof window.Chart !== 'undefined') {
            return;
        }

        // Tenta reutilizar um script existente
        const existing = Array.from(document.querySelectorAll('script[src]')).find(s => {
            const src = s.getAttribute('src') || '';
            return src.includes('cdn.jsdelivr.net/npm/chart.js') || /chart(?:\.umd)?(?:\.min)?\.js$/i.test(src);
        });

        if (existing) {
            // Se já existe, aguarda carregar
            await new Promise((resolve, reject) => {
                if (existing.dataset._loaded === '1' || existing.readyState === 'complete') {
                    resolve();
                    return;
                }
                existing.addEventListener('load', () => {
                    existing.dataset._loaded = '1';
                    resolve();
                }, { once: true });
                existing.addEventListener('error', () => reject(new Error('Falha ao carregar Chart.js existente')), { once: true });
            });
            return;
        }

        // Cria script novo respeitando CSP nonce
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
        script.crossOrigin = 'anonymous';
        script.referrerPolicy = 'no-referrer';

        try {
            const anyNonceScript = document.querySelector('script[nonce]');
            const nonce = anyNonceScript ? anyNonceScript.getAttribute('nonce') : (window.__CSP_NONCE__ || null);
            if (nonce) {
                script.setAttribute('nonce', nonce);
            }
        } catch (_) {
            // silencioso
        }

        await new Promise((resolve, reject) => {
            script.onload = () => resolve();
            script.onerror = () => reject(new Error('Falha ao carregar Chart.js'));
            document.head.appendChild(script);
        });
    }

    setupEventListeners() {
        // Event listeners para botões de período
        this.periodButtons.forEach(btn => {
            // Acessibilidade: informar estado e rótulo
            btn.setAttribute('role', 'button');
            btn.setAttribute('aria-pressed', btn.classList.contains('active') ? 'true' : 'false');
            const label = btn.textContent?.trim() || `${btn.dataset.period} dias`;
            btn.setAttribute('aria-label', `Mostrar histórico de ${label}`);

            btn.addEventListener('click', (e) => {
                e.preventDefault();
                this.changePeriod(parseInt(btn.dataset.period));
            });
        });

        // Event listener para mudanças nos filtros
        this.setupFilterListeners();
    }

    setupFilterListeners() {
        // Monitora mudanças nos filtros de severidade
        const severityInputs = document.querySelectorAll('input[name="severity"], select[name*="severity"], #severity');
        severityInputs.forEach(input => {
            input.addEventListener('change', () => {
                this.updateFilters();
            });
        });
    
        // Monitora mudanças no CVSS Score (inputs diretos)
        const cvssInputs = document.querySelectorAll('input[name="cvss_min"], input[name="cvss_max"], input[name*="cvss"], #cvss_min, #cvss_max');
        cvssInputs.forEach(input => {
            input.addEventListener('input', Utils.debounce(() => {
                this.updateFilters();
            }, 500, 'cve-cvss-inputs'));
        });
    
        // Monitora mudanças no CVSS Range (select da página)
        const cvssRangeSelect = document.querySelector('#cvss-filter, select[name="cvss_range"]');
        if (cvssRangeSelect) {
            cvssRangeSelect.addEventListener('change', () => {
                this.updateFilters();
            });
        }
    
        // Monitora submit do formulário de filtros
        const filterForm = document.querySelector('.filters-form, .filter-form, #filter-form');
        if (filterForm) {
            filterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.updateFilters();
            });
        }
    
        // Listen for clear filters button
        const clearBtn = document.querySelector('.clear-filters-btn, #clear-filters, #clear-filters-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                setTimeout(() => this.loadData(), 100); // Small delay to ensure filters are cleared
            });
        }
    }

    async changePeriod(period) {
        this.currentPeriod = period;
        
        // Atualiza botões ativos e estado aria
        this.periodButtons.forEach(btn => {
            const isActive = btn.dataset.period === String(period);
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });

        await this.loadData();
    }

    async updateFilters() {
        // Coleta filtros atuais
        this.currentFilters = this.collectCurrentFilters();
        await this.loadData();
    }

    collectCurrentFilters() {
        const filters = {};
    
        // Severidade (select ou inputs)
        const severitySelect = document.querySelector('#severity, select[name="severity"]');
        if (severitySelect && severitySelect.value) {
            filters.severity = severitySelect.value;
        } else {
            const severityInputs = document.querySelectorAll('input[name="severity"]:checked');
            if (severityInputs.length > 0) {
                // Se múltiplos, considerar apenas um (API atual aceita único)
                const values = Array.from(severityInputs).map(input => input.value);
                filters.severity = values[0];
            }
        }
    
        // CVSS Score via inputs min/max
        const cvssMinInput = document.querySelector('input[name="cvss_min"], #cvss_min');
        const cvssMaxInput = document.querySelector('input[name="cvss_max"], #cvss_max');
        if (cvssMinInput && cvssMinInput.value) {
            const val = parseFloat(cvssMinInput.value);
            if (!isNaN(val)) filters.cvss_min = val;
        }
        if (cvssMaxInput && cvssMaxInput.value) {
            const val = parseFloat(cvssMaxInput.value);
            if (!isNaN(val)) filters.cvss_max = val;
        }
    
        // CVSS Range via select (ex: "7.0-8.9")
        const cvssRangeSelect = document.querySelector('#cvss-filter, select[name="cvss_range"]');
        if (cvssRangeSelect && cvssRangeSelect.value) {
            const parts = (cvssRangeSelect.value || '').split('-').map(s => parseFloat(s.trim()));
            const [min, max] = parts;
            if (!isNaN(min)) filters.cvss_min = min;
            if (!isNaN(max)) filters.cvss_max = max;
        }
    
        return filters;
    }

    async loadData() {
        try {
            this.showLoading(true);

            const params = new URLSearchParams({
                period: this.currentPeriod,
                ...this.currentFilters
            });

            const response = await fetch(`${this.apiUrl}?${params}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            if (!data || !Array.isArray(data.datasets)) {
                this.showContainerMessage('Sem dados para os filtros selecionados');
                return;
            }
            console.debug('Dados carregados para CVE History', {
                period: this.currentPeriod,
                severity: this.currentFilters.severity || null,
                cvss_min: this.currentFilters.cvss_min || null,
                cvss_max: this.currentFilters.cvss_max || null,
                labelsCount: Array.isArray(data.labels) ? data.labels.length : 0,
                datasetsCount: data.datasets.length
            });
            this.renderChart(data);
            this.updateStats(data.statistics);

        } catch (error) {
            console.error('Erro ao carregar dados do gráfico:', error);
            this.showError('Erro ao carregar dados do gráfico');
        } finally {
            this.showLoading(false);
        }
    }

    renderChart(data) {
        if (!this.chartCanvas || typeof this.chartCanvas.getContext !== 'function') {
            this.showContainerMessage('Gráfico indisponível (canvas não disponível)');
            return;
        }
        const ctx = this.chartCanvas.getContext('2d');
        if (!ctx) {
            this.showContainerMessage('Gráfico indisponível (contexto 2D ausente)');
            return;
        }

        // Destrói gráfico anterior se existir
        if (this.chart) {
            this.chart.destroy();
        }

        // Configuração do gráfico
        const datasets = (data.datasets || []).map(dataset => ({
            ...dataset,
            fill: false,
            tension: 0.1,
            pointBackgroundColor: dataset.borderColor,
            pointBorderColor: dataset.borderColor,
            pointHoverBackgroundColor: dataset.borderColor,
            pointHoverBorderColor: dataset.borderColor
        }));

        const config = {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                const raw = context[0].label;
                                try {
                                    const date = new Date(raw);
                                    return `Data: ${date.toLocaleDateString('pt-BR', { year: 'numeric', month: 'short', day: 'numeric' })}`;
                                } catch (_) {
                                    return `Data: ${raw}`;
                                }
                            },
                            label: function(context) {
                                const val = context.parsed?.y ?? 0;
                                const num = Number(val).toLocaleString('pt-BR');
                                return `${context.dataset.label}: ${num} CVEs`;
                            }
                        }
                    },
                    decimation: {
                        enabled: true,
                        algorithm: 'lttb',
                        samples: 100
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Período',
                            font: {
                                size: 14,
                                weight: '600'
                            }
                        },
                        ticks: {
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 10
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Número de CVEs',
                            font: {
                                size: 14,
                                weight: '600'
                            }
                        },
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return Number(value).toLocaleString('pt-BR');
                            }
                        }
                    }
                },
                elements: {
                    point: {
                        radius: 4,
                        hoverRadius: 8,
                        borderWidth: 2,
                        hoverBorderWidth: 3
                    }
                }
            }
        };

        try {
            console.debug('Renderizando gráfico CVE History', {
                labelsCount: Array.isArray(data.labels) ? data.labels.length : 0,
                datasetsInfo: (data.datasets || []).map(d => ({ label: d.label, points: Array.isArray(d.data) ? d.data.length : 0 }))
            });
            this.chart = new Chart(ctx, config);
        } catch (e) {
            console.error('Falha ao renderizar Chart.js:', e);
            this.showError('Erro ao renderizar gráfico');
        }
    }

    updateStats(stats) {
        // Atualiza estatísticas na interface
        const elements = {
            totalCves: document.getElementById('totalCves'),
            criticalCves: document.getElementById('criticalCves'),
            highCves: document.getElementById('highCves'),
            mediumCves: document.getElementById('mediumCves'),
            lowCves: document.getElementById('lowCves')
        };

        // Mapeia as propriedades da API para os elementos da interface
        const statsMapping = {
            totalCves: stats?.total || 0,
            criticalCves: stats?.critical || 0,
            highCves: stats?.high || 0,
            mediumCves: stats?.medium || 0,
            lowCves: stats?.low || 0
        };

        Object.entries(elements).forEach(([key, element]) => {
            if (element && statsMapping[key] !== undefined) {
                element.textContent = statsMapping[key].toLocaleString();
                
                // Adiciona animação de contagem
                this.animateNumber(element, 0, statsMapping[key], 1000);
            }
        });
    }

    animateNumber(element, start, end, duration) {
        const startTime = performance.now();
        
        const updateNumber = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const current = Math.floor(start + (end - start) * progress);
            element.textContent = current.toLocaleString();
            
            if (progress < 1) {
                requestAnimationFrame(updateNumber);
            }
        };
        
        requestAnimationFrame(updateNumber);
    }

    showLoading(show) {
        if (this.chartLoading) {
            this.chartLoading.style.display = show ? 'block' : 'none';
        }
        
        if (this.chartCanvas) {
            this.chartCanvas.style.opacity = show ? '0.3' : '1';
        }
    }

    showError(message) {
        console.error('CVE History Chart Error:', message);
        this.showContainerMessage(message || 'Erro ao renderizar gráfico');
    }

    // Método público para atualizar o gráfico externamente
    refresh() {
        this.updateFilters();
    }

    // Debounce utilitário removido – usar Utils.debounce centralizado
 }

// Inicializa o gráfico de forma robusta, mesmo com script injetado dinamicamente
(function() {
    const boot = () => {
        const canvas = document.getElementById('cveHistoryChart');
        if (canvas) {
            window.cveHistoryChart = new CVEHistoryChart();
        }
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', boot, { once: true });
    } else {
        // DOM já está pronto
        boot();
    }
})();

// Exporta para uso global
window.CVEHistoryChart = CVEHistoryChart;


CVEHistoryChart.prototype.showContainerMessage = function(message) {
    const container = (this.chartCanvas && this.chartCanvas.parentElement) || document.querySelector('.chart-container');
    if (!container) return;
    const msg = document.createElement('div');
    msg.className = 'chart-empty-message text-muted';
    msg.textContent = message || 'Gráfico indisponível';
    container.innerHTML = '';
    container.appendChild(msg);
};