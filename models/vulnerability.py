# models/vulnerability.py

import re
import logging
from datetime import datetime
from typing import Optional, Dict, Any

from sqlalchemy import Column, Integer, String, Text, DateTime, Float, Boolean
from sqlalchemy.orm import relationship, validates
from extensions.db import db
from .base_model import BaseModel
from .enums import severity_levels

logger = logging.getLogger(__name__)

class Vulnerability(db.Model):
    __tablename__ = 'vulnerabilities'

    cve_id          = Column(String(50), primary_key=True, nullable=False, index=True)
    description     = Column(Text, nullable=False)
    published_date  = Column(DateTime, nullable=False, index=True)
    last_update     = Column(DateTime, nullable=False)
    base_severity   = Column(severity_levels, nullable=False, index=True)
    cvss_score      = Column(Float, nullable=False)
    patch_available = Column(Boolean, default=False, nullable=False)
    assigner        = Column(String(255), nullable=True)

    # Relacionamentos
    metrics            = relationship('CVSSMetric', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    severity_metrics   = relationship('SeverityMetric', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload', uselist=False)
    vendors            = relationship('CVEVendor', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    products           = relationship('CVEProduct', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    version_references = relationship('VersionReference', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    weaknesses         = relationship('Weakness', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    references         = relationship('Reference', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    affected_products  = relationship('AffectedProduct', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    assets             = relationship('AssetVulnerability', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')
    risk_assessments   = relationship('RiskAssessment', back_populates='vulnerability', cascade='all, delete-orphan', lazy='noload')

    @validates('cve_id')
    def validate_cve_id(self, key: str, value: str) -> str:
        if not re.match(r'^CVE-\d{4}-\d{4,}$', value):
            raise ValueError("Formato inválido: CVE-YYYY-NNNN")
        return value

    @validates('cvss_score')
    def validate_cvss_score(self, key: str, value: float) -> float:
        if not 0.0 <= value <= 10.0:
            raise ValueError("CVSS score deve estar entre 0.0 e 10.0")
        return value

    @validates('last_update')
    def validate_dates(self, key: str, value: datetime) -> datetime:
        if self.published_date and value < self.published_date:
            raise ValueError("last_update deve ser >= published_date")
        return value

    def to_dict(self) -> Dict[str, Any]:
        """Serialização básica para JSON."""
        return {
            'cve_id'         : self.cve_id,
            'description'    : self.description,
            'published_date' : self.published_date.isoformat(),
            'last_update'    : self.last_update.isoformat(),
            'base_severity'  : self.base_severity,
            'cvss_score'     : self.cvss_score,
            'patch_available': self.patch_available,
            'assigner'       : self.assigner,
        }

    def __repr__(self) -> str:
        return f"<Vulnerability {self.cve_id}>"
