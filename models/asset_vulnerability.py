from sqlalchemy import Column, String, Integer, ForeignKey, DateTime, PrimaryKeyConstraint
from sqlalchemy.orm import relationship
from datetime import datetime
from ..models.base_model import db
from ..models.enums import asset_vuln_status

class AssetVulnerability(db.Model):
    __tablename__ = 'asset_vulnerabilities'

    asset_id = Column(Integer, ForeignKey('asset.id', ondelete='CASCADE'), nullable=False)
    vulnerability_id = Column(String, ForeignKey('vulnerabilities.cve_id', ondelete='CASCADE'), nullable=False)
    status = Column(asset_vuln_status, nullable=False, default='OPEN')
    mitigation_date = Column(DateTime, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    __table_args__ = (
        PrimaryKeyConstraint('asset_id', 'vulnerability_id', name='pk_asset_vulnerability'),
    )

    asset = relationship('Asset', back_populates='vulnerabilities')
    vulnerability = relationship('Vulnerability', back_populates='assets')
