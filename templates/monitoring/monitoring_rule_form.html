{% extends 'base.html' %}

{% block title %}{{ action|capitalize }} Regra de Monitoramento{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/monitoring.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4 fade-in">
  <!-- Page Header -->
  <header class="page-header mb-5">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div>
        <h1 class="h3 fw-semibold mb-2">
          <i class="bi bi-{{ 'pencil' if action == 'editar' else 'plus-circle' }} me-2 text-primary"></i>
          {{ action|capitalize }} Regra de Monitoramento
        </h1>
        <p class="text-muted fs-6 mb-0">
          {% if action == 'editar' %}
            Atualize as configurações da regra de monitoramento
          {% else %}
            Configure uma nova regra para monitoramento automático
          {% endif %}
        </p>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('monitoring.list_monitoring_rules') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Voltar às Regras
        </a>
      </div>
    </div>
  </header>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="row justify-content-center mb-4">
        <div class="col-lg-8">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
              <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endwith %}

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="form-card">
        <div class="form-card-header">
          <h3 class="form-card-title">
            <i class="bi bi-gear me-2"></i>
            Configurações da Regra
          </h3>
          <p class="form-card-subtitle">
            Defina os parâmetros para monitoramento automático de vulnerabilidades
          </p>
        </div>

        <form method="POST" novalidate class="form" id="monitoring-form">
          {{ form.csrf_token }}

          <div class="form-group">
            <label for="name" class="form-label required">
              <i class="bi bi-tag me-1"></i>
              Nome da Regra
            </label>
            {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""), id="name", placeholder="Ex: Alerta Zero-Day") }}
            {% if form.name.errors %}
              <div class="invalid-feedback">
                {{ form.name.errors[0] }}
              </div>
            {% endif %}
            <small class="text-muted mt-1 d-block">
              Escolha um nome descritivo para identificar facilmente esta regra
            </small>
          </div>

          <div class="form-group">
            <label for="vendor" class="form-label">
              <i class="bi bi-building me-1"></i>
              Fornecedor (Opcional)
            </label>
            {{ form.vendor(class="form-control" + (" is-invalid" if form.vendor.errors else ""), id="vendor", placeholder="Ex: Microsoft") }}
            {% if form.vendor.errors %}
              <div class="invalid-feedback">
                {{ form.vendor.errors[0] }}
              </div>
            {% endif %}
            <small class="text-muted mt-1 d-block">
              Filtre vulnerabilidades de um fornecedor específico
            </small>
          </div>

          <div class="form-group">
            <label for="search_term" class="form-label">
              <i class="bi bi-search me-1"></i>
              Termo de Pesquisa (Opcional)
            </label>
            {{ form.search_term(class="form-control" + (" is-invalid" if form.search_term.errors else ""), id="search_term", placeholder="Ex: zero-day") }}
            {% if form.search_term.errors %}
              <div class="invalid-feedback">
                {{ form.search_term.errors[0] }}
              </div>
            {% endif %}
            <small class="text-muted mt-1 d-block">
              Palavras-chave para filtrar vulnerabilidades específicas
            </small>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn">
              <i class="bi bi-{{ 'check-circle' if action == 'editar' else 'plus-circle' }} me-1"></i>
              <span class="btn-text">{{ action|capitalize }} Regra</span>
              <span class="btn-loading d-none">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Processando...
              </span>
            </button>
            <a href="{{ url_for('monitoring.list_monitoring_rules') }}" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle me-1"></i>
              Cancelar
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

<script>
// Form validation and submission
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('monitoring-form');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = submitBtn.querySelector('.btn-text');
  const btnLoading = submitBtn.querySelector('.btn-loading');

  // Form submission with loading state
  form.addEventListener('submit', function(e) {
    if (form.checkValidity()) {
      submitBtn.disabled = true;
      btnText.classList.add('d-none');
      btnLoading.classList.remove('d-none');
    }
  });

  // Real-time validation feedback
  const inputs = form.querySelectorAll('input, select, textarea');
  inputs.forEach(input => {
    input.addEventListener('blur', function() {
      validateField(this);
    });

    input.addEventListener('input', function() {
      if (this.classList.contains('is-invalid')) {
        validateField(this);
      }
    });
  });

  function validateField(field) {
    const value = field.value.trim();
    const isRequired = field.hasAttribute('required') || field.labels[0]?.classList.contains('required');
    
    if (isRequired && !value) {
      field.classList.add('is-invalid');
      field.classList.remove('is-valid');
    } else if (value) {
      field.classList.remove('is-invalid');
      field.classList.add('is-valid');
    } else {
      field.classList.remove('is-invalid', 'is-valid');
    }
  }

  // Show success toast on form submission
  function showToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    
    const toastHTML = `
      <div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
      this.remove();
    });
  }
});
</script>
{% endblock %}