{% extends "base.html" %}

{% block title %}Relatório de Risco - {{ cve_id }}{% endblock %}

{% block extra_css %}
<style>
    .risk-report-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-lg);
    }
    
    .report-header {
        background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-600) 100%);
        color: white;
        padding: var(--space-xl);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-xl);
        box-shadow: var(--shadow-lg);
    }
    
    .report-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-subtle);
    }
    
    .report-content h1,
    .report-content h2,
    .report-content h3 {
        color: var(--content-strong);
        margin-top: var(--space-lg);
        margin-bottom: var(--space-md);
    }
    
    .report-content h1 {
        font-size: var(--font-size-2xl);
        border-bottom: 2px solid var(--color-primary);
        padding-bottom: var(--space-sm);
    }
    
    .report-content h2 {
        font-size: var(--font-size-xl);
        color: var(--color-primary);
    }
    
    .report-content h3 {
        font-size: var(--font-size-lg);
    }
    
    .report-content p {
        line-height: 1.6;
        margin-bottom: var(--space-md);
        color: var(--content-medium);
    }
    
    .report-content ul,
    .report-content ol {
        margin-bottom: var(--space-md);
        padding-left: var(--space-lg);
    }
    
    .report-content li {
        margin-bottom: var(--space-xs);
        color: var(--content-medium);
    }
    
    .report-content strong {
        color: var(--content-strong);
        font-weight: var(--font-weight-semibold);
    }
    
    .report-content code {
        background: var(--surface-1);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-family: var(--font-mono);
        color: var(--color-primary);
    }
    
    .report-content pre {
        background: var(--surface-1);
        padding: var(--space-md);
        border-radius: var(--radius-md);
        overflow-x: auto;
        border: 1px solid var(--border-subtle);
    }
    
    .report-actions {
        margin-top: var(--space-xl);
        display: flex;
        gap: var(--space-md);
        flex-wrap: wrap;
    }
    
    .btn-print {
        background: var(--color-success);
        border-color: var(--color-success);
    }
    
    .btn-print:hover {
        background: var(--color-success-600);
        border-color: var(--color-success-600);
    }
    
    .btn-export {
        background: var(--color-info);
        border-color: var(--color-info);
    }
    
    .btn-export:hover {
        background: var(--color-info-600);
        border-color: var(--color-info-600);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .loading-spinner {
        background: white;
        padding: var(--space-xl);
        border-radius: var(--radius-lg);
        text-align: center;
        box-shadow: var(--shadow-xl);
    }
    
    .spinner {
        border: 4px solid var(--border-subtle);
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--space-md);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media print {
        .report-actions,
        .navbar,
        .footer {
            display: none !important;
        }
        
        .risk-report-container {
            max-width: none;
            margin: 0;
            padding: 0;
        }
        
        .report-header,
        .report-content {
            box-shadow: none;
            border: none;
        }
    }
    
    @media (max-width: 768px) {
        .risk-report-container {
            padding: var(--space-md);
        }
        
        .report-header {
            padding: var(--space-lg);
        }
        
        .report-content {
            padding: var(--space-lg);
        }
        
        .report-actions {
            flex-direction: column;
        }
        
        .report-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="risk-report-container">
    <!-- Cabeçalho do Relatório -->
    <div class="report-header">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div>
                <h1 class="h2 mb-2">
                    <i class="fas fa-shield-alt me-2"></i>
                    Relatório de Análise de Risco
                </h1>
                <p class="mb-0 opacity-90">
                    <strong>CVE:</strong> {{ cve_id }}
                </p>
                <p class="mb-0 opacity-90">
                    <strong>Gerado em:</strong> {{ moment().format('DD/MM/YYYY HH:mm') }}
                </p>
            </div>
            <div class="text-end">
                {% if vulnerability.baseSeverity %}
                    {% set severity_class = {
                        'LOW': 'success',
                        'MEDIUM': 'warning', 
                        'HIGH': 'danger',
                        'CRITICAL': 'danger'
                    }[vulnerability.baseSeverity] or 'secondary' %}
                    <span class="badge bg-{{ severity_class }} fs-6 px-3 py-2">
                        {{ vulnerability.baseSeverity }}
                    </span>
                {% endif %}
                {% if vulnerability.cvssScore %}
                    <div class="mt-2">
                        <small class="opacity-75">CVSS Score</small>
                        <div class="h4 mb-0">{{ "%.1f"|format(vulnerability.cvssScore) }}</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Conteúdo do Relatório -->
    <div class="report-content">
        {% if risk_analysis %}
            {{ risk_analysis | markdown | safe }}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                <h3>Relatório não disponível</h3>
                <p class="text-muted">Não foi possível gerar o relatório de risco para esta vulnerabilidade.</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Ações do Relatório -->
    <div class="report-actions">
        <button type="button" class="btn btn-print text-white" onclick="window.print()">
            <i class="fas fa-print me-2"></i>
            Imprimir Relatório
        </button>
        
        <button type="button" class="btn btn-export text-white" onclick="exportToPDF()">
            <i class="fas fa-file-pdf me-2"></i>
            Exportar PDF
        </button>
        
        <button type="button" class="btn btn-secondary" onclick="copyToClipboard()">
            <i class="fas fa-copy me-2"></i>
            Copiar Conteúdo
        </button>
        
        <a href="{{ url_for('vulnerability_ui.vulnerability_details', cve_id=cve_id) }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>
            Voltar aos Detalhes
        </a>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="mb-0">Processando...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Função para exportar para PDF
    function exportToPDF() {
        showLoading();
        
        // Simular processamento
        setTimeout(() => {
            hideLoading();
            
            // Por enquanto, usar a funcionalidade de impressão do navegador
            // Em uma implementação real, você poderia usar uma biblioteca como jsPDF
            window.print();
        }, 1000);
    }
    
    // Função para copiar conteúdo para clipboard
    async function copyToClipboard() {
        try {
            const reportContent = document.querySelector('.report-content');
            const textContent = reportContent.innerText;
            
            await navigator.clipboard.writeText(textContent);
            
            // Mostrar feedback
            showToast('Conteúdo copiado para a área de transferência!', 'success');
        } catch (err) {
            console.error('Erro ao copiar:', err);
            showToast('Erro ao copiar conteúdo', 'error');
        }
    }
    
    // Função para mostrar loading
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }
    
    // Função para esconder loading
    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
    
    // Função para mostrar toast (feedback)
    function showToast(message, type = 'info') {
        // Criar elemento de toast
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
        toast.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        `;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
        `;
        
        // Adicionar ao DOM
        document.body.appendChild(toast);
        
        // Remover após 3 segundos
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
    
    // Adicionar animações CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    // Adicionar suporte para markdown se não estiver disponível
    document.addEventListener('DOMContentLoaded', function() {
        // Melhorar a formatação de listas e parágrafos
        const reportContent = document.querySelector('.report-content');
        if (reportContent) {
            // Adicionar classes Bootstrap para melhor formatação
            const headings = reportContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
            headings.forEach(heading => {
                heading.classList.add('fw-bold');
            });
            
            const lists = reportContent.querySelectorAll('ul, ol');
            lists.forEach(list => {
                list.classList.add('mb-3');
            });
            
            const paragraphs = reportContent.querySelectorAll('p');
            paragraphs.forEach(p => {
                if (p.textContent.trim()) {
                    p.classList.add('mb-3');
                }
            });
        }
    });
</script>
{% endblock %}