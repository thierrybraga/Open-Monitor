{% extends 'base.html' %}

{% block title %}Lista de Ativos{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/assets.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4 fade-in">
  <!-- Page Header -->
  <header class="page-header mb-5">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div>
        <h1 class="h3 fw-semibold mb-2">
          <i class="bi bi-server me-2 text-primary"></i>
          Lista de Ativos
        </h1>
        <p class="text-muted fs-6 mb-0">
          Gerencie todos os ativos de infraestrutura do sistema
        </p>
      </div>
      <a href="{{ url_for('asset.create_asset') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle me-2"></i>Adicionar Novo Ativo
      </a>
    </div>
  </header>

  <!-- Search and Filter Bar -->
  <div class="search-filter-bar">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="search-input-group">
          <i class="bi bi-search search-icon"></i>
          <input type="text" class="form-control" placeholder="Buscar por nome, IP ou responsável..." id="asset-search">
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex gap-2 justify-content-md-end mt-3 mt-md-0">
          <select class="form-select" style="width: auto;" id="status-filter">
            <option value="">Todos os Status</option>
            <option value="online">Online</option>
            <option value="offline">Offline</option>
            <option value="maintenance">Manutenção</option>
          </select>
          <button class="btn btn-outline-primary" id="export-btn">
            <i class="bi bi-download me-1"></i>
            <span class="btn-text">Exportar</span>
            <span class="btn-loading d-none">
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              Exportando...
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assets Table -->
  {% if assets %}
    <div class="asset-list-container">
      <div class="table-responsive">
        <table class="table asset-table">
          <thead>
            <tr>
              <th>
                <i class="bi bi-tag me-1"></i>Nome
              </th>
              <th>
                <i class="bi bi-diagram-3 me-1"></i>Tipo
              </th>
              <th>
                <i class="bi bi-router me-1"></i>Endereço IP
              </th>
              <th>
                <i class="bi bi-geo-alt me-1"></i>Localização
              </th>
              <th>
                <i class="bi bi-person me-1"></i>Proprietário
              </th>
              <th>
                <i class="bi bi-activity me-1"></i>Status
              </th>
              <th>
                <i class="bi bi-gear me-1"></i>Ações
              </th>
            </tr>
          </thead>
          <tbody>
            {% for asset in assets %}
              <tr data-asset-id="{{ asset.id }}">
                <td>
                  <div class="d-flex align-items-center">
                    <div class="asset-icon me-2">
                      <i class="bi bi-server text-primary"></i>
                    </div>
                    <div>
                      <div class="fw-semibold">{{ asset.name }}</div>
                      {% if asset.hostname %}
                        <small class="text-muted">{{ asset.hostname }}</small>
                      {% endif %}
                    </div>
                  </div>
                </td>
                <td>
                  <span class="badge bg-light text-dark">
                    {{ asset.type or 'Não definido' }}
                  </span>
                </td>
                <td>
                  <code class="text-primary">{{ asset.ip_address }}</code>
                </td>
                <td>
                  {{ asset.location or 'Não informado' }}
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle text-muted me-2"></i>
                    <span class="text-muted">
                      {{ asset.owner.username if asset.owner else 'Não atribuído' }}
                    </span>
                  </div>
                </td>
                <td>
                  <span class="status-badge {{ asset.status or 'unknown' }}">
                    {{ asset.status or 'Desconhecido' }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <a href="{{ url_for('asset.asset_detail', asset_id=asset.id) }}" 
                       class="btn btn-sm btn-outline-primary" 
                       title="Visualizar detalhes">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="{{ url_for('asset.edit_asset', asset_id=asset.id) }}" 
                       class="btn btn-sm btn-outline-warning" 
                       title="Editar ativo">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <button type="button" 
                            class="btn btn-sm btn-outline-danger delete-asset-btn" 
                            data-asset-id="{{ asset.id }}" 
                            data-asset-name="{{ asset.name }}" 
                            title="Excluir ativo">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="pagination-container">
        <button class="pagination-btn" id="prev-page" disabled>
          <i class="bi bi-chevron-left"></i>
        </button>
        <span class="text-muted">Página 1 de 1</span>
        <button class="pagination-btn" id="next-page" disabled>
          <i class="bi bi-chevron-right"></i>
        </button>
        <select class="form-select" style="width: auto;" id="page-size">
          <option value="10">10 por página</option>
          <option value="25">25 por página</option>
          <option value="50">50 por página</option>
        </select>
      </div>
    </div>
  {% else %}
    <div class="asset-card text-center py-5">
      <div class="mb-4">
        <i class="bi bi-server" style="font-size: 4rem; color: #6c757d;"></i>
      </div>
      <h3 class="h5 fw-semibold mb-3">Nenhum ativo cadastrado</h3>
      <p class="text-muted mb-4">
        Comece adicionando seu primeiro ativo de infraestrutura ao sistema.
      </p>
      <a href="{{ url_for('asset.create_asset') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle me-2"></i>Adicionar Primeiro Ativo
      </a>
    </div>
  {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteAssetModal" tabindex="-1" aria-labelledby="deleteAssetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-semibold" id="deleteAssetModalLabel">
          <i class="bi bi-exclamation-triangle text-warning me-2"></i>
          Confirmar Exclusão
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Tem certeza que deseja excluir o ativo <strong id="asset-name-to-delete"></strong>?</p>
        <div class="alert alert-warning d-flex align-items-center" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <div>Esta ação não pode ser desfeita.</div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Cancelar
        </button>
        <form method="POST" id="delete-asset-form" class="d-inline">
          <button type="submit" class="btn btn-danger" id="delete-btn">
            <i class="bi bi-trash me-1"></i>
            <span class="btn-text">Excluir Ativo</span>
            <span class="btn-loading d-none">
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              Excluindo...
            </span>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast for Feedback -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="feedback-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="bi bi-check-circle-fill text-success me-2"></i>
      <strong class="me-auto">Sucesso</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      Operação realizada com sucesso!
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Asset management functionality
(function() {
  'use strict';
  
  // Delete asset functionality
  const deleteButtons = document.querySelectorAll('.delete-asset-btn');
  const deleteModal = new bootstrap.Modal(document.getElementById('deleteAssetModal'));
  const deleteForm = document.getElementById('delete-asset-form');
  const assetNameElement = document.getElementById('asset-name-to-delete');
  
  deleteButtons.forEach(button => {
    button.addEventListener('click', function() {
      const assetId = this.dataset.assetId;
      const assetName = this.dataset.assetName;
      
      assetNameElement.textContent = assetName;
      deleteForm.action = `{{ url_for('asset.delete_asset', asset_id='ASSET_ID') }}`.replace('ASSET_ID', assetId);
      
      deleteModal.show();
    });
  });
  
  // Search functionality
  const searchInput = document.getElementById('asset-search');
  const statusFilter = document.getElementById('status-filter');
  
  function filterAssets() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    const rows = document.querySelectorAll('tbody tr[data-asset-id]');
    
    rows.forEach(row => {
      const name = row.querySelector('td:first-child').textContent.toLowerCase();
      const ip = row.querySelector('code').textContent.toLowerCase();
      const status = row.querySelector('.status-badge').className.toLowerCase();
      
      const matchesSearch = name.includes(searchTerm) || ip.includes(searchTerm);
      const matchesStatus = !statusFilter || status.includes(statusFilter);
      
      row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
  }
  
  if (searchInput) {
    searchInput.addEventListener('input', filterAssets);
  }
  
  if (statusFilter) {
    statusFilter.addEventListener('change', filterAssets);
  }
  
  // Export functionality
  const exportBtn = document.getElementById('export-btn');
  if (exportBtn) {
    exportBtn.addEventListener('click', function() {
      // Placeholder for export functionality
      const toast = new bootstrap.Toast(document.getElementById('feedback-toast'));
      document.querySelector('.toast-body').textContent = 'Funcionalidade de exportação em desenvolvimento.';
      toast.show();
    });
  }
})();
</script>
{% endblock %}
