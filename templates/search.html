{% extends 'base.html' %}

{% block title %}Busca - Open Monitor{% endblock %}

{% block meta_description %}Busque e encontre vulnerabilidades, hosts e informações de segurança rapidamente. Sistema de busca avançado com filtros e resultados em tempo real.{% endblock %}

{% block meta_keywords %}busca, pesquisa, vulnerabilidades, hosts, segurança, filtros, CVE, sistema de busca{% endblock %}

{% block og_title %}Busca - Sistema de Monitoramento de Segurança{% endblock %}

{% block og_description %}Ferramenta de busca avançada para encontrar vulnerabilidades, hosts e informações de segurança de forma rápida e eficiente.{% endblock %}

{% block og_type %}website{% endblock %}

{% macro pagination(total_pages, current_page, page_size) %}
  <nav class="pagination d-flex gap-2 justify-content-center mt-3 align-items-center" aria-label="Paginação de resultados">
    <button class="btn btn-sm btn-outline-secondary"
            id="prev-page"
            {{ 'disabled' if current_page <= 1 else '' }}
            aria-label="Página anterior">
      <i class="bi bi-chevron-left" aria-hidden="true"></i>
      <span class="visually-hidden">Página anterior</span>
    </button>
    <span id="page-info" class="small text-muted">
      Página {{ current_page }} de {{ total_pages }}
    </span>
    <button class="btn btn-sm btn-outline-secondary"
            id="next-page"
            {{ 'disabled' if current_page >= total_pages else '' }}
            aria-label="Próxima página">
      <i class="bi bi-chevron-right" aria-hidden="true"></i>
      <span class="visually-hidden">Próxima página</span>
    </button>
    <input type="number"
           id="go-to-page"
           class="form-control form-control-sm w-16"
           min="1"
           max="{{ total_pages }}"
           value="{{ current_page }}"
           aria-label="Ir para página"
           placeholder="Página">
    <select id="page-size"
            class="form-select form-select-sm"
            aria-label="Resultados por página">
      {% for size in [10, 25, 50] %}
        <option value="{{ size }}" {{ 'selected' if size == page_size else '' }}>
          {{ size }}
        </option>
      {% endfor %}
    </select>
  </nav>
{% endmacro %}

{% block title %}Consulta de IP - {{ app_name }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/vulnerabilities.css') }}">
  <style nonce="{{ csp_nonce }}">
    .search-card {
      background: var(--card-bg, #ffffff);
      border: 1px solid var(--border-color, #e9ecef);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }
    
    .search-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .search-card .card-header {
      background: linear-gradient(135deg, var(--primary-color, #007bff) 0%, var(--primary-dark, #0056b3) 100%);
      color: white;
      border-radius: 12px 12px 0 0;
      padding: 1rem 1.5rem;
      border: none;
    }
    
    .search-card .card-title {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .search-card .card-body {
      padding: 2rem;
    }
    
    .quick-examples {
      background: var(--light-bg, #f8f9fa);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border-light, #e9ecef);
    }
    
    .quick-examples h6 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }
    
    .example-btn {
      font-size: 0.8rem;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      text-align: left;
    }
    
    .example-btn:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }
    
    .recent-searches {
      background: var(--light-bg, #f8f9fa);
      border: 1px solid var(--border-light, #e9ecef);
      border-radius: 8px;
      padding: 1rem;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .recent-searches h6 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }
    
    .recent-search-item {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.25rem;
      background: white;
      border: 1px solid var(--border-light, #e9ecef);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }
    
    .recent-search-item:hover {
      background: var(--primary-light, #e3f2fd);
      border-color: var(--primary-color, #007bff);
      transform: translateX(2px);
    }
    
    .recent-search-item span {
      flex: 1;
      margin-left: 0.5rem;
    }
    
    .recent-search-item .remove-recent {
      opacity: 0;
      transition: opacity 0.2s ease;
      padding: 0.125rem 0.25rem;
      font-size: 0.75rem;
    }
    
    .recent-search-item:hover .remove-recent {
      opacity: 1;
    }
    
    .input-group .btn {
      border-left: none;
    }
    
    .input-group-text {
      background: var(--light-bg, #f8f9fa);
      border-color: var(--border-color, #ced4da);
      color: var(--text-muted, #6c757d);
    }
    
    .form-control:focus + .btn,
    .form-control.is-valid + .btn,
    .form-control.is-invalid + .btn {
      border-color: var(--border-color, #ced4da);
    }
    
    .btn-loading .spinner-border {
      width: 1rem;
      height: 1rem;
    }
    
    @media (max-width: 768px) {
      .search-card .card-body {
        padding: 1.5rem;
      }
      
      .quick-examples,
      .recent-searches {
        margin-top: 1rem;
      }
      
      .form-actions .d-grid {
        margin-top: 1rem;
      }
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .search-card {
        background: var(--dark-card-bg, #2d3748);
        border-color: var(--dark-border, #4a5568);
      }
      
      .quick-examples,
      .recent-searches {
        background: var(--dark-light-bg, #1a202c);
        border-color: var(--dark-border, #4a5568);
      }
      
      .recent-search-item {
        background: var(--dark-card-bg, #2d3748);
        border-color: var(--dark-border, #4a5568);
        color: var(--dark-text, #e2e8f0);
      }
      
      .recent-search-item:hover {
        background: var(--dark-primary-light, #2c5aa0);
      }
      
      .input-group-text {
        background: var(--dark-light-bg, #1a202c);
        border-color: var(--dark-border, #4a5568);
        color: var(--dark-text-muted, #a0aec0);
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="search-container" role="main">
  <!-- Page Header -->
  <header class="page-header mb-4">
    <div class="page-header-content">
      <div class="page-title-section">
        <h1 class="page-title">
          <i class="bi bi-search me-2"></i>
          Consulta de IP
        </h1>
        <p class="page-subtitle">Digite um endereço IP ou domínio para consultar informações detalhadas via Shodan API.</p>
      </div>
    </div>
  </header>

  <!-- Search Card -->
  <section class="search-card mb-4" aria-labelledby="search-title">
    <div class="card-header">
      <h2 id="search-title" class="card-title">
        <i class="bi bi-globe me-2"></i>
        Buscar Endereço IP ou Domínio
      </h2>
    </div>
    <div class="card-body">
      <form id="search-form" method="GET" action="{{ url_for('main.search') }}" novalidate>
        <div class="row g-3">
          <div class="col-md-8">
            <div class="form-group">
              <label for="search-ip" class="form-label required">
                <i class="bi bi-router me-1"></i>
                Endereço IP ou Domínio
              </label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-globe2"></i>
                </span>
                <input id="search-ip"
                       type="text"
                       name="query"
                       class="form-control"
                       placeholder="Ex: 192.168.0.1 ou example.com"
                       required
                       aria-label="Endereço IP ou Domínio"
                       value="{{ request.args.get('query', '') }}">
                <button type="button" class="btn btn-outline-secondary" id="clear-input" title="Limpar campo">
                  <i class="bi bi-x"></i>
                </button>
              </div>
              <div class="invalid-feedback" id="ip-error"></div>
              <small class="text-muted mt-1 d-block">
                <i class="bi bi-info-circle me-1"></i>
                Digite um IP válido (ex: 8.8.8.8) ou domínio (ex: google.com)
              </small>
            </div>
            
            <!-- Recent Searches -->
            <div id="recent-searches" class="recent-searches mt-3 d-none">
              <h6 class="text-muted mb-2">
                <i class="bi bi-clock-history me-1"></i>
                Pesquisas Recentes
              </h6>
              <div class="recent-searches-list" id="recent-searches-list"></div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="form-actions">
              <label class="form-label d-block">&nbsp;</label>
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary" id="search-btn">
                  <i class="bi bi-search me-1"></i>
                  <span class="btn-text">Buscar</span>
                  <span class="btn-loading d-none">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    Buscando...
                  </span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="clear-form">
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  Limpar
                </button>
              </div>
            </div>
            
            <!-- Quick Examples -->
            <div class="quick-examples mt-3">
              <h6 class="text-muted mb-2">
                <i class="bi bi-lightbulb me-1"></i>
                Exemplos Rápidos
              </h6>
              <div class="d-grid gap-1">
                <button type="button" class="btn btn-sm btn-outline-info example-btn" data-query="8.8.8.8">
                  <i class="bi bi-dns me-1"></i>
                  DNS Google
                </button>
                <button type="button" class="btn btn-sm btn-outline-info example-btn" data-query="1.1.1.1">
                  <i class="bi bi-shield-check me-1"></i>
                  Cloudflare DNS
                </button>
                <button type="button" class="btn btn-sm btn-outline-info example-btn" data-query="github.com">
                  <i class="bi bi-github me-1"></i>
                  GitHub
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </section>

  <!-- Results Section -->
  <section id="result-section" class="d-none" aria-labelledby="results-title">
    <!-- Summary Card -->
    <div class="card summary-card mb-4">
      <div class="card-header py-2 bg-primary text-white">
        <h2 id="results-title" class="h6 mb-0 d-flex align-items-center gap-2">
          Resumo do Host
          <span id="demo-badge" class="badge bg-warning text-dark d-none">Demo</span>
        </h2>
      </div>
      <div class="card-body p-3">
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-5 g-3">
          {% for metric in [
            {'id': 'summary-ip', 'title': 'IP', 'icon': 'globe'},
            {'id': 'summary-isp', 'title': 'ISP', 'icon': 'wifi'},
            {'id': 'summary-org', 'title': 'Organização', 'icon': 'building'},
            {'id': 'summary-ports', 'title': 'Portas', 'icon': 'plug'},
            {'id': 'summary-location', 'title': 'Localização', 'icon': 'geo-alt'}
          ] %}
            <div class="card metric-card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="small text-muted text-uppercase">{{ metric.title }}</div>
                  <div class="fs-5 fw-semibold" id="{{ metric.id }}">N/A</div>
                </div>
                <i class="bi bi-{{ metric.icon }} text-primary fs-3" aria-hidden="true"></i>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Google Maps -->
    <div class="card map-card mb-4">
      <div class="card-header py-2">
        <h2 class="h6 mb-0">Localização no Mapa</h2>
      </div>
      <div class="card-body p-3 position-relative">
        <div id="map-loading" class="map-loading d-flex justify-content-center align-items-center d-none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando mapa...</span>
          </div>
        </div>
        <div id="map" class="map-container" role="region" aria-label="Mapa com localização do IP"></div>
      </div>
    </div>

    <!-- Detailed Results Table -->
    <div class="card table-card">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Detalhes da Consulta</h2>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary"
                  id="reset-demo"
                  aria-label="Restaurar dados de demonstração">
            <i class="bi bi-arrow-repeat me-1" aria-hidden="true"></i> Restaurar Demo
          </button>
          <button class="btn btn-sm btn-primary"
                  id="export-results"
                  aria-label="Exportar resultados">
            <i class="bi bi-download me-1" aria-hidden="true"></i> Exportar
          </button>
        </div>
      </div>
      <div class="card-body p-3">
        <div id="table-loading" class="d-none d-flex justify-content-center p-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando tabela...</span>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover" aria-label="Detalhes da consulta de IP ou domínio">
            <thead>
              <tr>
                <th scope="col" class="ps-3 sortable" data-sort="property">
                  Propriedade <i class="bi bi-arrow-down-up" aria-hidden="true"></i>
                </th>
                <th scope="col" class="ps-3 sortable" data-sort="value">
                  Valor <i class="bi bi-arrow-down-up" aria-hidden="true"></i>
                </th>
                <th scope="col" class="ps-3"></th>
              </tr>
            </thead>
            <tbody id="result-table-body"></tbody>
          </table>
        </div>
        {{ pagination(total_pages | default(1), current_page | default(1), page_size | default(10)) }}
      </div>
    </div>
  </section>

  <!-- Loading State -->
  <div id="loading-spinner" class="spinner d-none" role="status" aria-live="polite">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
  </div>

  <!-- Error Message -->
  <div id="error-message" class="alert alert-danger d-none mx-auto max-w-lg mt-3" role="alert">
    <span id="error-text"></span>
    <button class="btn btn-sm btn-outline-secondary ms-2"
            id="retry-btn"
            type="button"
            aria-label="Tentar novamente">
      Tentar Novamente
    </button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {% if config.get('GOOGLE_MAPS_API_KEY') %}
    <script async
            defer
            src="https://maps.googleapis.com/maps/api/js?key={{ config.get('GOOGLE_MAPS_API_KEY') }}&callback=initMap"
            nonce="{{ csp_nonce }}"></script>
  {% endif %}
  <script defer
          src="{{ url_for('static', filename='js/search.js') }}"
          nonce="{{ csp_nonce }}"
          onerror="this.onerror=null;this.src='{{ url_for('static', filename='js/search-fallback.js') }}'"></script>
  <script nonce="{{ csp_nonce }}">
    // IP/Domain validation
    function validateInput(input) {
      const value = input.trim();
      const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
      const domainRegex = /^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)?$/;
      
      return ipRegex.test(value) || domainRegex.test(value);
    }

    // Toast notification function
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container') || createToastContainer();
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      container.style.zIndex = '1055';
      document.body.appendChild(container);
      return container;
    }

    // Form validation and submission
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('search-form');
      const input = document.getElementById('search-ip');
      const errorDiv = document.getElementById('ip-error');
      const searchBtn = document.getElementById('search-btn');
      const clearBtn = document.getElementById('clear-form');
      const clearInputBtn = document.getElementById('clear-input');
      const btnText = searchBtn.querySelector('.btn-text');
      const btnLoading = searchBtn.querySelector('.btn-loading');
      
      // Real-time validation
      input.addEventListener('input', function() {
        const value = this.value.trim();
        
        if (value === '') {
          this.classList.remove('is-invalid', 'is-valid');
          errorDiv.textContent = '';
          clearInputBtn.style.display = 'none';
          return;
        }
        
        clearInputBtn.style.display = 'block';
        
        if (validateInput(value)) {
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
          errorDiv.textContent = '';
        } else {
          this.classList.remove('is-valid');
          this.classList.add('is-invalid');
          errorDiv.textContent = 'Por favor, digite um endereço IP válido (ex: 192.168.1.1) ou domínio (ex: example.com)';
        }
      });
      
      // Clear input button
      clearInputBtn.addEventListener('click', function() {
        input.value = '';
        input.classList.remove('is-invalid', 'is-valid');
        errorDiv.textContent = '';
        this.style.display = 'none';
        input.focus();
        document.getElementById('recent-searches').classList.add('d-none');
      });
      
      // Form submission
      form.addEventListener('submit', function(e) {
        const value = input.value.trim();
        
        if (!value || !validateInput(value)) {
          e.preventDefault();
          input.classList.add('is-invalid');
          errorDiv.textContent = 'Por favor, digite um endereço IP válido ou domínio antes de buscar.';
          input.focus();
          showToast('Por favor, digite um endereço IP ou domínio válido.', 'danger');
          return;
        }
        
        // Show loading state
        searchBtn.disabled = true;
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');
        
        // Save to recent searches
        saveRecentSearch(value);
        showToast(`Buscando informações para: ${value}`, 'info');
      });
      
      // Clear form
      clearBtn.addEventListener('click', function() {
        input.value = '';
        input.classList.remove('is-invalid', 'is-valid');
        errorDiv.textContent = '';
        clearInputBtn.style.display = 'none';
        input.focus();
        document.getElementById('recent-searches').classList.add('d-none');
        showToast('Formulário limpo com sucesso!', 'success');
      });
      
      // Example buttons
      document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const query = this.dataset.query;
          input.value = query;
          input.dispatchEvent(new Event('input'));
          input.focus();
          showToast(`Exemplo carregado: ${query}`, 'success');
        });
      });
      
      // Recent searches functionality
      function saveRecentSearch(query) {
        let recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
        recent = recent.filter(item => item !== query);
        recent.unshift(query);
        recent = recent.slice(0, 5); // Keep only last 5
        localStorage.setItem('recentSearches', JSON.stringify(recent));
      }
      
      function loadRecentSearches() {
        const recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
        const container = document.getElementById('recent-searches');
        const list = document.getElementById('recent-searches-list');
        
        if (recent.length > 0) {
          list.innerHTML = recent.map(query => 
            `<div class="recent-search-item" data-query="${query}">
               <i class="bi bi-clock-history me-2"></i>
               <span>${query}</span>
               <button type="button" class="btn btn-sm btn-outline-danger remove-recent" data-query="${query}" title="Remover">
                 <i class="bi bi-x"></i>
               </button>
             </div>`
          ).join('');
          container.classList.remove('d-none');
          
          // Add click handlers for recent searches
          list.querySelectorAll('.recent-search-item').forEach(item => {
            item.addEventListener('click', function(e) {
              if (!e.target.closest('.remove-recent')) {
                input.value = this.dataset.query;
                input.dispatchEvent(new Event('input'));
                container.classList.add('d-none');
              }
            });
          });
          
          // Add remove handlers
          list.querySelectorAll('.remove-recent').forEach(btn => {
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              const query = this.dataset.query;
              removeRecentSearch(query);
              loadRecentSearches();
            });
          });
        } else {
          container.classList.add('d-none');
        }
      }
      
      function removeRecentSearch(query) {
        let recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
        recent = recent.filter(item => item !== query);
        localStorage.setItem('recentSearches', JSON.stringify(recent));
      }
      
      // Show recent searches on focus
      input.addEventListener('focus', function() {
        if (this.value.trim() === '') {
          loadRecentSearches();
        }
      });
      
      // Hide recent searches on blur (with delay)
      input.addEventListener('blur', function() {
        setTimeout(() => {
          document.getElementById('recent-searches').classList.add('d-none');
        }, 200);
      });
      
      // Initialize
      if (input.value.trim()) {
        clearInputBtn.style.display = 'block';
        input.dispatchEvent(new Event('input'));
      }
      
      // Load recent searches on page load
      loadRecentSearches();
    });
  </script>
{% endblock %}