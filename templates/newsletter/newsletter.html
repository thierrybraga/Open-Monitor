{% extends 'base.html' %}

{# Page Title - Uses context from the context processor if defined #}
{% block title %}{{ page_title if page_title else 'Contact & Notifications' }} - {{ app_name }}{% endblock %}

{# Header Brand - Can be defined in the backend or template #}
{% block header_brand %}
  <span class="navbar-brand-text">{{ app_name }} - Contact & Notifications</span>
{% endblock %}

{# Additional CSS Links - main.css is already imported in base.html #}
{% block extra_css %}
  <style nonce="{{ csp_nonce }}">
    .notification-card {
      background: var(--card-bg, #ffffff);
      border: 1px solid var(--border-color, #e9ecef);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }
    
    .notification-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
    
    .notification-card .card-header {
      background: linear-gradient(135deg, var(--primary-color, #007bff) 0%, var(--primary-dark, #0056b3) 100%);
      color: white;
      border-radius: 12px 12px 0 0;
      padding: 1rem 1.5rem;
      border: none;
    }
    
    .notification-card .card-title {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    .contact-item {
      background: var(--light-bg, #f8f9fa);
      border: 1px solid var(--border-light, #e9ecef);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.2s ease;
    }
    
    .contact-item:hover {
      background: var(--primary-light, #e3f2fd);
      border-color: var(--primary-color, #007bff);
      transform: translateY(-2px);
    }
    
    .contact-link {
      color: var(--primary-color, #007bff);
      text-decoration: none;
      transition: color 0.2s ease;
    }
    
    .contact-link:hover {
      color: var(--primary-dark, #0056b3);
      text-decoration: underline;
    }
    
    .form-switch .form-check-input {
      width: 2.5rem;
      height: 1.25rem;
      border-radius: 1rem;
    }
    
    .form-switch .form-check-input:checked {
      background-color: var(--success-color, #28a745);
      border-color: var(--success-color, #28a745);
    }
    

    
    .quick-actions-card {
      position: sticky;
      top: 2rem;
    }
    
    @media (max-width: 768px) {
      .notification-card .card-body {
        padding: 1.5rem;
      }
      
      .contact-item {
        text-align: center;
        margin-bottom: 1rem;
      }
      
      .quick-actions-card {
        position: static;
        margin-top: 2rem;
      }
    }
    
    /* Notification methods styling */
    .notification-method {
      background: rgba(248, 249, 250, 0.8);
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .notification-method::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #007bff, #0056b3);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .notification-method.enabled::before {
      transform: scaleX(1);
    }
    
    .notification-method.enabled {
      background: rgba(13, 110, 253, 0.05);
      border-color: rgba(13, 110, 253, 0.3);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
    }
    
    .notification-method.disabled {
      opacity: 0.6;
      background: rgba(108, 117, 125, 0.05);
      border-color: rgba(108, 117, 125, 0.2);
    }
    
    .notification-method h6 {
      font-weight: 600;
      color: #495057;
    }
    
    .notification-method .form-check-input:checked {
      background-color: #198754;
      border-color: #198754;
    }
    
    .coming-soon {
      background: linear-gradient(45deg, #ffc107, #fd7e14) !important;
      color: #000 !important;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    
    /* Preferences summary styling */
    .preferences-summary {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .preference-item {
      background: rgba(248, 249, 250, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.3s ease;
    }
    
    .preference-item:hover {
      background: rgba(248, 249, 250, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .preference-item h6 {
      font-weight: 600;
      color: #495057;
    }
    
    .status-enabled {
      background: linear-gradient(45deg, #198754, #20c997) !important;
      color: white !important;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    
    .status-disabled {
      background: linear-gradient(45deg, #6c757d, #adb5bd) !important;
      color: white !important;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
    }
    
    /* Form actions styling */
    .form-actions {
      background: rgba(248, 249, 250, 0.5);
      border-radius: 8px;
      padding: 1.5rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    /* Help section styling */
    .help-section {
      background: rgba(13, 202, 240, 0.05);
      border: 1px solid rgba(13, 202, 240, 0.2);
      border-radius: 8px;
      padding: 1rem;
    }
    
    .help-section h6 {
      font-weight: 600;
    }
    
    /* Toast notifications */
    .toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1050;
      min-width: 300px;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toast-notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .toast-success {
      border-left: 4px solid #198754;
    }
    
    .toast-error {
      border-left: 4px solid #dc3545;
    }
    
    .toast-warning {
      border-left: 4px solid #ffc107;
    }
    
    .toast-info {
      border-left: 4px solid #0dcaf0;
    }
    
    .toast-success .bi {
      color: #198754;
    }
    
    .toast-error .bi {
      color: #dc3545;
    }
    
    .toast-warning .bi {
      color: #ffc107;
    }
    
    .toast-info .bi {
      color: #0dcaf0;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .notification-card {
        background: var(--dark-card-bg, #2d3748);
        border-color: var(--dark-border, #4a5568);
      }
      
      .contact-item {
        background: var(--dark-light-bg, #1a202c);
        border-color: var(--dark-border, #4a5568);
      }
      
      .contact-item:hover {
        background: var(--dark-primary-light, #2c5aa0);
      }
      
      .notification-method {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
      }
      
      .notification-method.enabled {
        background: rgba(13, 110, 253, 0.1);
        border-color: rgba(13, 110, 253, 0.3);
      }
      
      .notification-method h6,
      .preference-item h6 {
        color: #e9ecef;
      }
      
      .preference-item {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
      }
      
      .preference-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      
      .form-actions {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
      }
      
      .help-section {
        background: rgba(13, 202, 240, 0.1);
        border-color: rgba(13, 202, 240, 0.3);
      }
      
      .toast-notification {
        background: #212529;
        border-color: rgba(255, 255, 255, 0.2);
        color: #e9ecef;
      }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .notification-method {
        padding: 1rem;
      }
      
      .toast-notification {
        right: 10px;
        left: 10px;
        min-width: auto;
      }
    }
  </style>
{% endblock %}

{% block content %}
<main class="container-fluid py-4">
  {# Page Header #}
  <header class="page-header mb-4">
    <div class="page-header-content">
      <div class="page-title-section">
        <h1 class="page-title">
          <i class="bi bi-bell me-2"></i>
          {{ page_title if page_title else 'Contact & Notifications' }}
        </h1>
        <p class="page-subtitle">Reach out to us and configure your notification preferences for cybersecurity updates.</p>
      </div>
    </div>
  </header>

  <div class="row g-4">
    {# Main Content Area #}
    <div class="col-lg-9">
      {# "About Open CVE Report" Section #}
      <section class="card shadow-md mb-4 fade-in" aria-labelledby="about-cve-report-heading">
        <div class="card-header p-4">
          <h2 class="h5 fw-semibold mb-0" id="about-cve-report-heading">About Open CVE Report</h2>
        </div>
        <div class="card-body p-4">
          <div class="row g-4">
            <div class="col-md-4">
              <h3 class="h6 fw-semibold d-flex align-items-center"><i class="bi bi-database me-2 text-primary" aria-hidden="true"></i> Data Source</h3>
              <p class="text-muted fs-6">Leverages public CVE data (e.g., NVD) via API, stored locally for reports and insights.</p>
            </div>
            <div class="col-md-4">
              <h3 class="h6 fw-semibold d-flex align-items-center"><i class="bi bi-arrow-repeat me-2 text-primary" aria-hidden="true"></i> Auto Updates</h3>
              <p class="text-muted fs-6">Stays current with the latest CVEs for reliable and accurate data (update frequency configurable).</p>
            </div>
            <div class="col-md-4">
              <h3 class="h6 fw-semibold d-flex align-items-center"><i class="bi bi-file-earmark-text me-2 text-primary" aria-hidden="true"></i> AI Reports</h3>
              <p class="text-muted fs-6">Generates technical reports using AI (e.g., OpenAI) in Markdown, converted to professional PDFs.</p>
            </div>
          </div>
        </div>
      </section>

      {# Contact Information Section #}
      <section class="notification-card mb-4" aria-labelledby="get-in-touch-heading">
        <div class="card-header">
          <h2 class="card-title" id="get-in-touch-heading">
            <i class="bi bi-person-lines-fill me-2"></i>
            Get in Touch
          </h2>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {# Email Item #}
            <div class="col-md-4">
              <div class="contact-item h-100">
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-envelope fs-4 text-primary me-3" aria-hidden="true"></i>
                  <div>
                    <p class="text-muted small mb-0">Email</p>
                    <h6 class="mb-0">Contact Us</h6>
                  </div>
                </div>
                <a href="mailto:contact@opencvereport.com" id="contact-email" class="contact-link fw-medium d-block">contact@opencvereport.com</a>
                <button class="btn btn-sm btn-outline-primary mt-2" type="button" onclick="copyToClipboard('contact-email')" aria-label="Copy email" data-bs-toggle="tooltip" data-bs-title="Copy Email">
                  <i class="bi bi-copy me-1" aria-hidden="true"></i>
                  Copy Email
                </button>
              </div>
            </div>
            {# GitHub Item #}
            <div class="col-md-4">
              <div class="contact-item h-100">
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-github fs-4 text-primary me-3" aria-hidden="true"></i>
                  <div>
                    <p class="text-muted small mb-0">GitHub</p>
                    <h6 class="mb-0">Source Code</h6>
                  </div>
                </div>
                <a href="https://github.com/opencvereport" target="_blank" rel="noopener noreferrer" class="contact-link fw-medium d-block">github.com/opencvereport</a>
                <a href="https://github.com/opencvereport" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary mt-2">
                  <i class="bi bi-box-arrow-up-right me-1" aria-hidden="true"></i>
                  Visit Repository
                </a>
              </div>
            </div>
            {# LinkedIn Item #}
            <div class="col-md-4">
              <div class="contact-item h-100">
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-linkedin fs-4 text-primary me-3" aria-hidden="true"></i>
                  <div>
                    <p class="text-muted small mb-0">LinkedIn</p>
                    <h6 class="mb-0">Professional</h6>
                  </div>
                </div>
                <a href="https://linkedin.com/company/opencvereport" target="_blank" rel="noopener noreferrer" class="contact-link fw-medium d-block">linkedin.com/company/opencvereport</a>
                <a href="https://linkedin.com/company/opencvereport" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary mt-2">
                  <i class="bi bi-box-arrow-up-right me-1" aria-hidden="true"></i>
                  Follow Us
                </a>
              </div>
            </div>
          </div>
        </div>
      </section>

      {# Notification Settings Section #}
      <section class="notification-card" aria-labelledby="notification-settings-heading">
        <div class="card-header">
          <h2 class="card-title" id="notification-settings-heading">
            <i class="bi bi-gear me-2"></i>
            Notification Settings
          </h2>
        </div>
        <div class="card-body">
          <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            <div>
              <strong>Configure your preferences:</strong> Choose how you want to receive cybersecurity updates. Some methods require additional setup.
            </div>
          </div>

          <form id="notification-form" method="POST" action="{{ url_for('main.newsletter') }}" novalidate>
            {{ form.hidden_tag() }}

            <div class="row g-4">
              {# Email Method #}
              <div class="col-md-6">
                <div class="notification-method {% if user_preferences and user_preferences.email_enabled %}enabled{% endif %}">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-envelope-fill fs-4 text-primary me-3"></i>
                      <div>
                        <h6 class="mb-0">Email Notifications</h6>
                        <small class="text-muted">Instant delivery</small>
                      </div>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" role="switch" id="emailToggle" name="emailToggle" {% if user_preferences and user_preferences.email_enabled %}checked{% endif %}>
                      <label class="form-check-label" for="emailToggle"></label>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="email" class="form-label required">
                      <i class="bi bi-at me-1"></i>
                      Email Address
                    </label>
                    {{ form.email(class="form-control", placeholder="your.email@example.com", id="email") }}
                    <div class="invalid-feedback" id="email-feedback">Please provide a valid email address.</div>
                  </div>
                </div>
              </div>

              {# Telegram Method #}
              <div class="col-md-6">
                <div class="notification-method disabled">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-telegram fs-4 text-info me-3"></i>
                      <div>
                        <h6 class="mb-0">Telegram Bot</h6>
                        <small class="text-muted">Real-time messaging</small>
                      </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="badge coming-soon">Coming Soon</span>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="telegramToggle" name="telegramToggle" disabled>
                        <label class="form-check-label" for="telegramToggle"></label>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="telegram" class="form-label">
                      <i class="bi bi-person-badge me-1"></i>
                      Telegram Handle
                    </label>
                    <input type="text" id="telegram" name="telegram" class="form-control" placeholder="@YourTelegram" disabled value="{{ user_preferences.telegram_handle if user_preferences else '' }}">
                    <div class="invalid-feedback" id="telegram-feedback"></div>
                  </div>
                </div>
              </div>

              {# WhatsApp Method #}
              <div class="col-md-6">
                <div class="notification-method disabled">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-whatsapp fs-4 text-success me-3"></i>
                      <div>
                        <h6 class="mb-0">WhatsApp</h6>
                        <small class="text-muted">Mobile messaging</small>
                      </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="badge coming-soon">Coming Soon</span>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="whatsappToggle" name="whatsappToggle" disabled>
                        <label class="form-check-label" for="whatsappToggle"></label>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="whatsapp" class="form-label">
                      <i class="bi bi-phone me-1"></i>
                      WhatsApp Number
                    </label>
                    <input type="tel" id="whatsapp" name="whatsapp" class="form-control" placeholder="+1 (555) 123-4567" disabled value="{{ user_preferences.whatsapp_number if user_preferences else '' }}">
                    <div class="invalid-feedback" id="whatsapp-feedback"></div>
                  </div>
                </div>
              </div>

              {# Phone Method #}
              <div class="col-md-6">
                <div class="notification-method disabled">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-telephone-fill fs-4 text-warning me-3"></i>
                      <div>
                        <h6 class="mb-0">Voice Call</h6>
                        <small class="text-muted">Emergency alerts</small>
                      </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="badge coming-soon">Coming Soon</span>
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="phoneToggle" name="phoneToggle" disabled>
                        <label class="form-check-label" for="phoneToggle"></label>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="phone" class="form-label">
                      <i class="bi bi-telephone me-1"></i>
                      Phone Number
                    </label>
                    <input type="tel" id="phone" name="phone" class="form-control" placeholder="+1 (555) 123-4567" disabled value="{{ user_preferences.phone_number if user_preferences else '' }}">
                    <div class="invalid-feedback" id="phone-feedback"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-actions mt-4">
              <div class="d-flex align-items-center gap-3">
                <button type="submit" class="btn btn-primary" id="submit-btn">
                  <i class="bi bi-envelope-plus me-1"></i>
                  <span class="btn-text">Subscribe to Newsletter</span>
                  <span class="btn-loading d-none">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    Saving...
                  </span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="reset-btn">
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  Reset
                </button>
                <a href="{{ url_for('main.newsletter_unsubscribe') }}" class="btn btn-outline-warning">
                  <i class="bi bi-envelope-x me-1"></i>
                  Unsubscribe
                </a>
                <span id="success-message" class="text-success fw-medium d-none" aria-live="polite">
                  <i class="bi bi-check-circle-fill me-1"></i>
                  Newsletter subscription successful!
                </span>
              </div>
            </div>
          </form>

          {# Saved Preferences Display Section - Visibility controlled by JS based on backend data #}
          {# Current Settings Summary #}
          {% if user_preferences %}
          <div id="saved-preferences" class="notification-card mt-4" aria-labelledby="current-settings-heading">
            <div class="card-header">
              <h3 class="card-title" id="current-settings-heading">
                <i class="bi bi-check-circle me-2"></i>
                Current Settings
              </h3>
            </div>
            <div class="card-body">
              <div class="preferences-summary">
                {% if user_preferences.email %}
                <div class="preference-item">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-envelope-fill text-primary me-3"></i>
                      <div>
                        <h6 class="mb-0">Email</h6>
                        <small class="text-muted">{{ user_preferences.email }}</small>
                      </div>
                    </div>
                    <div class="status-badge">
                      {% if user_preferences.email_enabled %}
                      <span class="badge status-enabled">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Active
                      </span>
                      {% else %}
                      <span class="badge status-disabled">
                        <i class="bi bi-x-circle-fill me-1"></i>
                        Inactive
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}

                {% if user_preferences.telegram_handle %}
                <div class="preference-item">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-telegram text-info me-3"></i>
                      <div>
                        <h6 class="mb-0">Telegram</h6>
                        <small class="text-muted">{{ user_preferences.telegram_handle }}</small>
                      </div>
                    </div>
                    <div class="status-badge">
                      {% if user_preferences.telegram_enabled %}
                      <span class="badge status-enabled">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Active
                      </span>
                      {% else %}
                      <span class="badge status-disabled">
                        <i class="bi bi-x-circle-fill me-1"></i>
                        Inactive
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}

                {% if user_preferences.whatsapp_number %}
                <div class="preference-item">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-whatsapp text-success me-3"></i>
                      <div>
                        <h6 class="mb-0">WhatsApp</h6>
                        <small class="text-muted">{{ user_preferences.whatsapp_number }}</small>
                      </div>
                    </div>
                    <div class="status-badge">
                      {% if user_preferences.whatsapp_enabled %}
                      <span class="badge status-enabled">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Active
                      </span>
                      {% else %}
                      <span class="badge status-disabled">
                        <i class="bi bi-x-circle-fill me-1"></i>
                        Inactive
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}

                {% if user_preferences.phone_number %}
                <div class="preference-item">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-telephone-fill text-warning me-3"></i>
                      <div>
                        <h6 class="mb-0">Phone</h6>
                        <small class="text-muted">{{ user_preferences.phone_number }}</small>
                      </div>
                    </div>
                    <div class="status-badge">
                      {% if user_preferences.phone_enabled %}
                      <span class="badge status-enabled">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Active
                      </span>
                      {% else %}
                      <span class="badge status-disabled">
                        <i class="bi bi-x-circle-fill me-1"></i>
                        Inactive
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </section>
    </div>

    {# Sidebar Actions #}
    <aside class="col-lg-3">
      <section class="notification-card sticky-top" aria-labelledby="quick-actions-heading">
        <div class="card-header">
          <h2 class="card-title" id="quick-actions-heading">
            <i class="bi bi-lightning-fill me-2"></i>
            Quick Actions
          </h2>
        </div>
        <div class="card-body">
          <div class="d-flex flex-column gap-3">
            <a href="{{ url_for('main.support') if 'support' in request.endpoints else '/support' }}" class="btn btn-primary w-100" aria-label="Contact support">
              <i class="bi bi-headset me-2"></i>
              Contact Support
            </a>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary w-100" aria-label="Go to dashboard">
              <i class="bi bi-speedometer2 me-2"></i>
              Back to Dashboard
            </a>
            <hr class="my-3">
            <div class="help-section">
              <h6 class="text-muted mb-2">
                <i class="bi bi-question-circle me-1"></i>
                Need Help?
              </h6>
              <p class="small text-muted mb-3">Configure your notification preferences to stay updated on security threats and system alerts.</p>
              <a href="#" class="btn btn-outline-info btn-sm w-100">
                <i class="bi bi-book me-1"></i>
                View Documentation
              </a>
            </div>
          </div>
        </div>
      </section>
    </aside>
  </div>
</main>
{% endblock %}

{# Additional JavaScript scripts #}
{% block extra_js %}
  {# Third-party scripts (IMask, SweetAlert2) #}
  <script src="https://cdn.jsdelivr.net/npm/imask@7.6.1/dist/imask.min.js" defer nonce="{{ nonce }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js" defer nonce="{{ nonce }}"></script>

  {# Inline scripts (copyToClipboard, tooltips) - Can be moved to a utility JS file #}
  <script nonce="{{ nonce }}">
    // Simple copy to clipboard function
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        navigator.clipboard.writeText(element.innerText || element.textContent)
          .then(() => {
            const btn = element.nextElementSibling;
            const originalTitle = btn.getAttribute('data-bs-title') || 'Copy Email';
            // Check if the tooltip has already been initialized
            let tooltip = bootstrap.Tooltip.getInstance(btn);
            if (!tooltip) { // Initialize if it doesn't exist
                 tooltip = new bootstrap.Tooltip(btn);
            }
            btn.setAttribute('data-bs-title', 'Copied!');
            tooltip.show();
            setTimeout(() => {
              tooltip.hide();
              btn.setAttribute('data-bs-title', originalTitle);
            }, 1500);
          })
          .catch(err => {
            console.error('Failed to copy text: ', err);
            // Optionally show an error message
          });
      }
    }
    // Initialize tooltips - Ensure Bootstrap JS has been loaded
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
          new bootstrap.Tooltip(el);
        });
    });
  </script>

  {# Page-specific newsletter script - SHOULD CONTAIN FORM VALIDATION AND SUBMISSION LOGIC #}
  {# This file will need to be created or updated #}
  <script src="{{ url_for('static', filename='js/newsletter.js') }}" defer nonce="{{ nonce }}"></script>

  {# Newsletter form validation and interaction script #}
  <script nonce="{{ nonce }}">
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('notification-form');
      const submitBtn = document.getElementById('submit-btn');
      const resetBtn = document.getElementById('reset-btn');
      const successMessage = document.getElementById('success-message');
      const emailInput = document.getElementById('email');
      const emailToggle = document.getElementById('emailToggle');

      // Email validation
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // Real-time email validation
      emailInput.addEventListener('input', function() {
        const email = this.value.trim();
        const isValid = email === '' || validateEmail(email);
        
        this.classList.toggle('is-invalid', !isValid && email !== '');
        this.classList.toggle('is-valid', isValid && email !== '');
        
        const feedback = document.getElementById('email-feedback');
        if (!isValid && email !== '') {
          feedback.textContent = 'Please enter a valid email address.';
        }
      });

      // Toggle email input based on switch
      emailToggle.addEventListener('change', function() {
        const method = emailInput.closest('.notification-method');
        method.classList.toggle('enabled', this.checked);
        
        if (this.checked) {
          emailInput.required = true;
          emailInput.focus();
        } else {
          emailInput.required = false;
          emailInput.classList.remove('is-invalid', 'is-valid');
        }
      });

      // Reset form
      resetBtn.addEventListener('click', function() {
        form.reset();
        document.querySelectorAll('.form-control').forEach(input => {
          input.classList.remove('is-valid', 'is-invalid');
        });
        document.querySelectorAll('.notification-method').forEach(method => {
          method.classList.remove('enabled');
        });
        successMessage.classList.add('d-none');
        showToast('Form reset successfully', 'info');
      });

      // Form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        let isValid = true;
        
        if (emailToggle.checked) {
          const email = emailInput.value.trim();
          if (!email || !validateEmail(email)) {
            emailInput.classList.add('is-invalid');
            isValid = false;
          }
        }
        
        if (!isValid) {
          showToast('Please fix the errors before submitting', 'error');
          return;
        }
        
        // Show loading state
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.btn-loading');
        
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');
        submitBtn.disabled = true;
        
        // Simulate form submission (replace with actual AJAX call)
        setTimeout(() => {
          // Reset button state
          btnText.classList.remove('d-none');
          btnLoading.classList.add('d-none');
          submitBtn.disabled = false;
          
          // Show success message
          successMessage.classList.remove('d-none');
          showToast('Notification preferences saved successfully!', 'success');
          
          // Hide success message after 3 seconds
          setTimeout(() => {
            successMessage.classList.add('d-none');
          }, 3000);
        }, 2000);
      });

      // Toast notification function
      function showToast(message, type = 'info') {
        // Remove existing toasts
        document.querySelectorAll('.toast-notification').forEach(toast => {
          toast.remove();
        });
        
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        const icon = {
          success: 'bi-check-circle-fill',
          error: 'bi-x-circle-fill',
          warning: 'bi-exclamation-triangle-fill',
          info: 'bi-info-circle-fill'
        }[type] || 'bi-info-circle-fill';
        
        toast.innerHTML = `
          <div class="d-flex align-items-center">
            <i class="bi ${icon} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" aria-label="Close"></button>
          </div>
        `;
        
        document.body.appendChild(toast);
        
        // Show toast
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Auto hide after 5 seconds
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 5000);
        
        // Close button functionality
        toast.querySelector('.btn-close').addEventListener('click', () => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        });
      }

      // Initialize form state
      if (emailToggle.checked) {
        emailInput.closest('.notification-method').classList.add('enabled');
      }
    });
  </script>
{% endblock %}