{% extends "base.html" %}
{% from 'macros.html' import render_pagination %}

{% block title %}Vulnerabilidades - Open Monitor{% endblock %}

{% block meta_description %}Gerencie e monitore vulnerabilidades de segurança em tempo real. Visualize, filtre e analise vulnerabilidades por severidade, status e impacto no sistema.{% endblock %}

{% block meta_keywords %}vulnerabilidades, segurança, CVE, CVSS, monitoramento, gestão de riscos, segurança cibernética, análise de vulnerabilidades{% endblock %}

{% block og_title %}Vulnerabilidades - Sistema de Monitoramento de Segurança{% endblock %}

{% block og_description %}Plataforma completa para gerenciamento de vulnerabilidades de segurança. Monitore, analise e gerencie riscos de segurança em tempo real.{% endblock %}

{% block og_type %}website{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/vulnerabilities.css') }}">
{% endblock %}

{% block content %}
<div class="vulnerability-container">
    <!-- Header Section -->
    <div class="vulnerability-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="bi bi-shield-exclamation"></i>
                Vulnerabilidades
            </h1>
            <p class="page-subtitle">Gerencie e monitore vulnerabilidades de segurança</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('vulnerability_ui.create_vulnerability_ui') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i>
                Nova Vulnerabilidade
            </a>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-card">
            <form method="GET" class="filters-form">
                <div class="filter-group">
                    <label for="severity" class="filter-label">Severidade:</label>
                    <select name="severity" id="severity" class="form-select">
                        <option value="">Todas</option>
                        <option value="CRITICAL" {{ 'selected' if filters.severity == 'CRITICAL' }}>Crítica</option>
                        <option value="HIGH" {{ 'selected' if filters.severity == 'HIGH' }}>Alta</option>
                        <option value="MEDIUM" {{ 'selected' if filters.severity == 'MEDIUM' }}>Média</option>
                        <option value="LOW" {{ 'selected' if filters.severity == 'LOW' }}>Baixa</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-funnel"></i>
                        Filtrar
                    </button>
                    <a href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i>
                        Limpar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Table Section -->
    <div class="table-section">
        {% if vulnerabilities %}
        <div class="table-card">
            <div class="table-responsive">
                <table class="table" id="vulnerabilities-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="cve_id">
                                <i class="bi bi-shield-exclamation"></i>
                                CVE ID
                                <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="severity">
                                <i class="bi bi-exclamation-triangle"></i>
                                Severidade
                                <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th>
                                <i class="bi bi-file-text"></i>
                                Descrição
                            </th>
                            <th class="sortable" data-sort="cvss_score">
                                <i class="bi bi-speedometer2"></i>
                                CVSS Score
                                <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="published_date">
                                <i class="bi bi-calendar"></i>
                                Data de Publicação
                                <i class="bi bi-chevron-expand sort-icon"></i>
                            </th>
                            <th class="text-center">
                                <i class="bi bi-gear"></i>
                                Ações
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vuln in vulnerabilities %}
                        <tr>
                            <td>
                                <span class="cve-badge">{{ vuln.cve_id }}</span>
                            </td>
                            <td>
                                <span class="severity-badge {{ vuln.base_severity.lower() }}">
                                    <i class="bi bi-{{ 'exclamation-triangle-fill' if vuln.base_severity == 'CRITICAL' else 'exclamation-circle-fill' if vuln.base_severity == 'HIGH' else 'info-circle-fill' if vuln.base_severity == 'MEDIUM' else 'check-circle-fill' }}"></i>
                                    {{ vuln.base_severity }}
                                </span>
                            </td>
                            <td>
                                <div class="description-cell">
                                    <p class="description-text">{{ vuln.description | default('Sem descrição disponível') | truncate(120) }}</p>
                                </div>
                            </td>
                            <td>
                                {% if vuln.cvss_score %}
                                    <span class="cvss-score {{ 'critical' if vuln.cvss_score >= 9.0 else 'high' if vuln.cvss_score >= 7.0 else 'medium' if vuln.cvss_score >= 4.0 else 'low' }}">
                                        {{ "%.1f" | format(vuln.cvss_score) }}
                                    </span>
                                {% else %}
                                    <span class="cvss-score unknown">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="date-text">{{ vuln.published_date.strftime('%d/%m/%Y') if vuln.published_date else 'N/A' }}</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{{ url_for('vulnerability_ui.vulnerability_details', cve_id=vuln.cve_id) }}" 
                                       class="btn btn-sm btn-outline-primary" 
                                       title="Ver Detalhes">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-warning mitigate-btn" 
                                            data-cve-id="{{ vuln.cve_id }}"
                                            title="Mitigar Vulnerabilidade">
                                        <i class="bi bi-shield-check"></i>
                                    </button>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-info ticket-btn" 
                                            data-cve-id="{{ vuln.cve_id }}"
                                            title="Abrir Ticket">
                                        <i class="bi bi-ticket-perforated"></i>
                                    </button>
                                    <a href="{{ url_for('vulnerability_ui.edit_vulnerability_ui', cve_id=vuln.cve_id) }}" 
                                       class="btn btn-sm btn-outline-secondary" 
                                       title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Loading Overlay -->
            <div id="table-loading" class="d-none">
                <div class="spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <div class="pagination-section">
            {{ render_pagination(pagination, 'vulnerability_ui.list_vulnerabilities_ui', **request.args) }}
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <div class="empty-state-content">
                <i class="bi bi-shield-exclamation empty-state-icon"></i>
                <h3 class="empty-state-title">Nenhuma vulnerabilidade encontrada</h3>
                <p class="empty-state-text">Não há vulnerabilidades cadastradas no sistema ou que correspondam aos filtros aplicados.</p>
                <a href="{{ url_for('vulnerability_ui.create_vulnerability_ui') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i>
                    Cadastrar Primeira Vulnerabilidade
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals -->
<!-- Modal de Mitigação -->
<div class="modal fade" id="mitigateModal" tabindex="-1" aria-labelledby="mitigateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mitigateModalLabel">
                    <i class="bi bi-shield-check"></i>
                    Mitigar Vulnerabilidade
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="mitigateForm">
                    <div class="mb-3">
                        <label for="mitigationNotes" class="form-label">Notas de Mitigação:</label>
                        <textarea class="form-control" id="mitigationNotes" rows="4" placeholder="Descreva as ações tomadas para mitigar esta vulnerabilidade..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="mitigationStatus" class="form-label">Status:</label>
                        <select class="form-select" id="mitigationStatus">
                            <option value="mitigated">Mitigada</option>
                            <option value="in_progress">Em Progresso</option>
                            <option value="planned">Planejada</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="confirmMitigate">
                    <i class="bi bi-shield-check"></i>
                    Confirmar Mitigação
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ticket -->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ticketModalLabel">
                    <i class="bi bi-ticket-perforated"></i>
                    Abrir Ticket
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ticketForm">
                    <div class="mb-3">
                        <label for="ticketTitle" class="form-label">Título do Ticket:</label>
                        <input type="text" class="form-control" id="ticketTitle" placeholder="Título do ticket...">
                    </div>
                    <div class="mb-3">
                        <label for="ticketDescription" class="form-label">Descrição:</label>
                        <textarea class="form-control" id="ticketDescription" rows="4" placeholder="Descreva o problema ou solicitação..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="ticketPriority" class="form-label">Prioridade:</label>
                        <select class="form-select" id="ticketPriority">
                            <option value="high">Alta</option>
                            <option value="medium" selected>Média</option>
                            <option value="low">Baixa</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-info" id="confirmTicket">
                    <i class="bi bi-ticket-perforated"></i>
                    Criar Ticket
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/vulnerabilities.js') }}"></script>
{% endblock %}