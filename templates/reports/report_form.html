{% extends 'base.html' %}

{% block title %}Gerar Relatório de Vulnerabilidades{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/reports.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4 fade-in">
  <!-- Page Header -->
  <header class="page-header mb-5">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div>
        <h1 class="h3 fw-semibold mb-2">
          <i class="bi bi-file-earmark-plus me-2 text-primary"></i>
          Gerar Relatório de Vulnerabilidades
        </h1>
        <p class="text-muted fs-6 mb-0">
          Configure os parâmetros para gerar um relatório personalizado
        </p>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('report.list_reports') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>Voltar aos Relatórios
        </a>
      </div>
    </div>
  </header>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="row justify-content-center mb-4">
        <div class="col-lg-8">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
              <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endwith %}

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="form-card">
        <div class="form-card-header">
          <h3 class="form-card-title">
            <i class="bi bi-sliders me-2"></i>
            Configurações do Relatório
          </h3>
          <p class="form-card-subtitle">
            Defina os filtros e parâmetros para gerar seu relatório personalizado
          </p>
        </div>

        <form method="POST" novalidate class="form" id="report-form">
          {{ form.csrf_token }}

          <div class="form-row">
            <div class="form-group">
              <label for="start_date" class="form-label required">
                <i class="bi bi-calendar-event me-1"></i>
                Data Inicial
              </label>
              {{ form.start_date(class="form-control" + (" is-invalid" if form.start_date.errors else ""), id="start_date") }}
              {% if form.start_date.errors %}
                <div class="invalid-feedback">
                  {{ form.start_date.errors[0] }}
                </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="end_date" class="form-label required">
                <i class="bi bi-calendar-check me-1"></i>
                Data Final
              </label>
              {{ form.end_date(class="form-control" + (" is-invalid" if form.end_date.errors else ""), id="end_date") }}
              {% if form.end_date.errors %}
                <div class="invalid-feedback">
                  {{ form.end_date.errors[0] }}
                </div>
              {% endif %}
            </div>
          </div>

          <div class="form-group">
            <label for="severity" class="form-label">
              <i class="bi bi-exclamation-triangle me-1"></i>
              Severidade
            </label>
            {{ form.severity(class="form-control" + (" is-invalid" if form.severity.errors else ""), id="severity") }}
            {% if form.severity.errors %}
              <div class="invalid-feedback">
                {{ form.severity.errors[0] }}
              </div>
            {% endif %}
            <small class="text-muted mt-1 d-block">
              Selecione a severidade mínima das vulnerabilidades a incluir no relatório
            </small>
          </div>

          <div class="form-actions justify-between">
            <a href="{{ url_for('report.list_reports') }}" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle me-1"></i>
              Cancelar
            </a>
            <button type="submit" class="btn btn-primary" id="generate-btn">
              <i class="bi bi-file-earmark-plus me-1"></i>
              <span class="btn-text">Gerar Relatório</span>
              <span class="btn-loading d-none">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Gerando...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="report-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="bi bi-info-circle text-primary me-2"></i>
      <strong class="me-auto">Relatório</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fechar"></button>
    </div>
    <div class="toast-body"></div>
  </div>
</div>

<script>
// Form validation and enhancement
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('report-form');
  const generateBtn = document.getElementById('generate-btn');
  const startDateInput = document.getElementById('start_date');
  const endDateInput = document.getElementById('end_date');
  
  // Set default dates
  if (!startDateInput.value) {
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
  }
  
  if (!endDateInput.value) {
    const today = new Date();
    endDateInput.value = today.toISOString().split('T')[0];
  }
  
  // Date validation
  function validateDates() {
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    
    if (startDate > endDate) {
      showToast('A data inicial não pode ser posterior à data final', 'warning');
      return false;
    }
    
    const diffTime = Math.abs(endDate - startDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays > 365) {
      showToast('O período não pode ser superior a 365 dias', 'warning');
      return false;
    }
    
    return true;
  }
  
  // Form submission
  form.addEventListener('submit', function(e) {
    if (!validateDates()) {
      e.preventDefault();
      return;
    }
    
    // Show loading state
    generateBtn.disabled = true;
    generateBtn.querySelector('.btn-text').classList.add('d-none');
    generateBtn.querySelector('.btn-loading').classList.remove('d-none');
    
    showToast('Iniciando geração do relatório...', 'info');
  });
  
  // Date change listeners
  startDateInput.addEventListener('change', validateDates);
  endDateInput.addEventListener('change', validateDates);
  
  // Toast function
  function showToast(message, type = 'info') {
    const toast = document.getElementById('report-toast');
    const toastBody = toast.querySelector('.toast-body');
    const toastHeader = toast.querySelector('.toast-header');
    const icon = toastHeader.querySelector('i');
    
    // Update icon based on type
    icon.className = `bi bi-${type === 'warning' ? 'exclamation-triangle text-warning' : 
                              type === 'error' ? 'x-circle text-danger' : 
                              'info-circle text-primary'} me-2`;
    
    toastBody.textContent = message;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
  }
});
</script>
{% endblock %}