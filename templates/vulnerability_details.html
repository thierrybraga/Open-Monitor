{% extends "base.html" %}

{% block title %}{{ vulnerability.cve_id or vulnerability.title }} - Detalhes da Vulnerabilidade - {{ super() }}{% endblock %}

{% block meta_description %}Análise detalhada da vulnerabilidade {{ vulnerability.cve_id or vulnerability.title }}{% if vulnerability.severity %} ({{ vulnerability.severity }}){% endif %}. {% if vulnerability.description %}{{ vulnerability.description | truncate(120) }}{% endif %}{% endblock %}

{% block meta_keywords %}{{ vulnerability.cve_id }}, vulnerabilidade, segurança, {{ vulnerability.severity | lower if vulnerability.severity }}, CVE, cybersecurity{% if vulnerability.affected_products %}, {{ vulnerability.affected_products[0].product_name if vulnerability.affected_products[0].product_name }}{% endif %}{% endblock %}

{% block og_title %}{{ vulnerability.cve_id or vulnerability.title }} - Vulnerabilidade de Segurança{% endblock %}

{% block og_description %}{{ vulnerability.description | truncate(200) if vulnerability.description else 'Análise detalhada de vulnerabilidade de segurança com informações técnicas e recomendações.' }}{% endblock %}

{% block og_type %}article{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/vulnerabilities.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<style>
/* Estilos específicos para a página de detalhes da vulnerabilidade */
.vulnerability-details-page {
    padding: var(--space-lg);
    animation: fadeInUp 0.6s ease-out;
}

.vulnerability-header {
    background: var(--surface-0);
    color: var(--content-strongest);
    padding: var(--space-xl);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--color-primary);
    border: 1px solid var(--border-subtle);
    transition: all var(--animation-duration-fast) var(--ease-standard);
    position: relative;
    overflow: hidden;
}

.vulnerability-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.8s ease;
}

.vulnerability-header:hover::before {
    left: 100%;
}

.vulnerability-header:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.vulnerability-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--content-strongest);
}

.vulnerability-meta {
    display: flex;
    gap: var(--space-lg);
    flex-wrap: wrap;
    align-items: center;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--surface-1);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.meta-item i {
    color: var(--color-primary);
}

.analytics-card {
    background: var(--surface-0);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    border: 1px solid var(--border-subtle);
    transition: all var(--animation-duration-fast) var(--ease-standard);
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s ease-out;
}

.analytics-card:nth-child(1) { animation-delay: 0.1s; }
.analytics-card:nth-child(2) { animation-delay: 0.2s; }
.analytics-card:nth-child(3) { animation-delay: 0.3s; }
.analytics-card:nth-child(4) { animation-delay: 0.4s; }

.analytics-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(var(--color-primary-rgb), 0.05), transparent);
    transition: left 0.6s ease;
}

.analytics-card:hover::before {
    left: 100%;
}

.analytics-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: var(--shadow-lg);
    border-color: var(--color-primary-200);
}

.analytics-card .card-header {
    transition: all var(--animation-duration-fast) var(--ease-standard);
}

.analytics-card:hover .card-header {
    transform: translateY(-1px);
}

.analytics-card .display-4 {
    transition: all var(--animation-duration-fast) var(--ease-standard);
}

.analytics-card:hover .display-4 {
    transform: scale(1.05);
    color: var(--color-primary);
}

.action-group {
    background: var(--surface-1);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    border-left: 4px solid var(--color-primary);
    border: 1px solid var(--border-subtle);
}

.btn-lg {
    padding: var(--space-md) var(--space-lg);
    font-weight: var(--font-weight-medium);
    border-radius: var(--radius-md);
    transition: all var(--animation-duration-fast) var(--ease-standard);
}

.btn-lg:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.analytics-card h3 {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--content-strong);
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.risk-score {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: var(--space-sm);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    border: 2px solid;
}

.risk-score.critical {
    background: var(--color-error-50);
    color: var(--color-error);
    border-color: var(--color-error);
}

.risk-score.high {
    background: var(--color-warning-50);
    color: var(--color-warning-700);
    border-color: var(--color-warning);
}

.risk-score.medium {
    background: var(--color-info-50);
    color: var(--color-info-700);
    border-color: var(--color-info);
}

.risk-score.low {
    background: var(--color-success-50);
    color: var(--color-success-700);
    border-color: var(--color-success);
}

.chart-container {
    height: 300px;
    margin: var(--space-md) 0;
}

.references-list {
    list-style: none;
    padding: 0;
}

.references-list li {
    padding: var(--space-sm);
    border-bottom: 1px solid var(--border-subtle);
}

.references-list li:last-child {
    border-bottom: none;
}

.reference-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
}

.reference-link:hover {
    text-decoration: underline;
}

.related-vulnerabilities {
    display: grid;
    gap: var(--space-md);
}

.related-vuln-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    background: var(--surface-1);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
}

.export-actions {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.export-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    transition: background-color var(--animation-duration-fast);
}

.export-btn:hover {
    background: var(--color-primary-600);
    color: white;
}

.timeline {
    position: relative;
    padding-left: var(--space-lg);
}

.timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--border-subtle);
}

.timeline-item {
    position: relative;
    margin-bottom: var(--space-lg);
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-marker {
    position: absolute;
    left: -12px;
    top: 4px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.timeline-content h6 {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--content-strong);
    margin-bottom: var(--space-xs);
}

.metric-card-value {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--content-strongest);
    line-height: 1;
}

/* Animações e Transições */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

.analytics-card {
    animation: fadeInUp 0.6s ease-out;
}

.analytics-card:nth-child(2) {
    animation-delay: 0.1s;
}

.analytics-card:nth-child(3) {
    animation-delay: 0.2s;
}

/* Tooltips personalizados */
.tooltip-trigger {
    position: relative;
    cursor: help;
    border-bottom: 1px dotted #6c757d;
}

.tooltip-trigger:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface-3);
    color: var(--content-strongest);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    white-space: nowrap;
    z-index: 1000;
    box-shadow: var(--shadow-lg);
    max-width: 200px;
    white-space: normal;
    text-align: center;
}

.tooltip-trigger:hover::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(100%);
    border: 5px solid transparent;
    border-top-color: #212529;
    z-index: 1000;
}

/* Indicadores de progresso */
.progress-ring {
    width: 60px;
    height: 60px;
    position: relative;
}

.progress-ring svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.progress-ring circle {
    fill: none;
    stroke-width: 4;
    stroke-linecap: round;
}

.progress-ring .bg {
    stroke: #e9ecef;
}

.progress-ring .progress {
    stroke: #0d6efd;
    stroke-dasharray: 157;
    stroke-dashoffset: 157;
    animation: progress-animation 1s ease-out forwards;
}

@keyframes progress-animation {
    to {
        stroke-dashoffset: calc(157 - (157 * var(--progress)) / 100);
    }
}

/* Responsividade melhorada */
@media (max-width: 1200px) {
    .analytics-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .vulnerability-details-page {
        padding: var(--space-md);
    }
    
    .vulnerability-header {
        padding: var(--space-lg);
    }
    
    .vulnerability-meta {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .vulnerability-title {
        font-size: 2rem;
    }
    
    .risk-score {
        font-size: 2rem;
    }
}

@media (max-width: 576px) {
    .vulnerability-title {
        font-size: 1.75rem;
    }
    
    .risk-score {
        font-size: 1.5rem;
    }
}

/* Animações e efeitos visuais */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.8;
    }
}

@keyframes shimmer {
    0% {
        background-position: -200px 0;
    }
    100% {
        background-position: calc(200px + 100%) 0;
    }
}

/* Melhorias nos botões */
.btn {
    position: relative;
    overflow: hidden;
    transition: all var(--animation-duration-fast) var(--ease-standard);
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn:active {
    transform: translateY(0);
    transition: transform 0.1s ease;
}

/* Efeitos para badges de severidade */
.badge {
    transition: all var(--animation-duration-fast) var(--ease-standard);
    position: relative;
    overflow: hidden;
}

.badge:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Efeitos para cards em geral */
.card {
    transition: all var(--animation-duration-fast) var(--ease-standard);
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* Efeitos para links */
a:not(.btn) {
    transition: all var(--animation-duration-fast) var(--ease-standard);
    position: relative;
}

a:not(.btn):hover {
    transform: translateX(2px);
}

/* Loading states */
.loading {
    animation: pulse 1.5s ease-in-out infinite;
}

.shimmer {
    background: linear-gradient(90deg, var(--surface-1) 0%, var(--surface-2) 50%, var(--surface-1) 100%);
    background-size: 200px 100%;
    animation: shimmer 1.5s infinite;
}

/* Scroll animations */
.fade-in-on-scroll {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.6s ease-out;
}

.fade-in-on-scroll.visible {
    opacity: 1;
    transform: translateY(0);
}

/* Focus states melhorados */
.btn:focus,
input:focus,
select:focus,
textarea:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.2);
    border-color: var(--color-primary);
}

/* Efeitos de hover para ícones */
.fa, .fas, .far, .fab {
    transition: all var(--animation-duration-fast) var(--ease-standard);
}

.card:hover .fa,
.card:hover .fas,
.card:hover .far,
.card:hover .fab {
    transform: scale(1.1) rotate(5deg);
}

/* Melhorias na responsividade com animações */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

.info-section {
    margin-bottom: var(--space-lg);
}

.info-section h5 {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-semibold);
    color: var(--content-strong);
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
}

.info-grid {
    display: grid;
    gap: var(--space-sm);
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    background: var(--surface-1);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-subtle);
}

.info-label {
    font-weight: var(--font-weight-medium);
    color: var(--content-medium);
    font-size: var(--font-size-sm);
}

.info-value {
    font-weight: var(--font-weight-semibold);
    color: var(--content-strong);
    font-size: var(--font-size-sm);
}

.impact-badge {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
}

.impact-badge.high {
    background: var(--color-error-100);
    color: var(--color-error-700);
    border: 1px solid var(--color-error-300);
}

.impact-badge.medium {
    background: var(--color-warning-100);
    color: var(--color-warning-700);
    border: 1px solid var(--color-warning-300);
}

.impact-badge.low {
    background: var(--color-success-100);
    color: var(--color-success-700);
    border: 1px solid var(--color-success-300);
}

.impact-badge.none {
    background: var(--surface-2);
    color: var(--content-medium);
    border: 1px solid var(--border-subtle);
}

.severity-badge.small {
    font-size: var(--font-size-xs);
    padding: var(--space-xs) var(--space-sm);
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    padding: var(--space-lg);
    background: var(--surface-1);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--border-medium);
    border: 1px solid var(--border-subtle);
}

.status-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-lg);
}

.status-icon.status-active {
    background: var(--color-error);
    color: white;
}

.status-icon.status-pending {
    background: var(--color-warning);
    color: var(--content-strongest);
}

.status-icon.status-info {
    background: var(--color-info);
    color: white;
}

.status-content h6 {
    margin: 0;
    font-weight: 600;
    color: #495057;
}

.tech-section {
    background: var(--surface-1);
    border-radius: var(--radius-md);
    padding: var(--space-xl);
    height: 100%;
    border: 1px solid var(--border-subtle);
}

.section-title {
    color: var(--content-strong);
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-weight: var(--font-weight-semibold);
}

.info-item.enhanced {
    padding: var(--space-md);
    background: var(--surface-0);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
    border-left: 3px solid var(--border-subtle);
    transition: all var(--animation-duration-fast) var(--ease-standard);
    border: 1px solid var(--border-subtle);
}

.info-item.enhanced:hover {
    border-left-color: var(--color-primary);
    box-shadow: var(--shadow-sm);
    transform: translateX(2px);
}

.score-value {
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
}

.severity-badge {
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-full);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    border: 1px solid transparent;
}

.severity-badge.critical {
    background: var(--color-error);
    color: white;
    border-color: var(--color-error-600);
}

.severity-badge.high {
    background: var(--color-warning);
    color: var(--content-strongest);
    border-color: var(--color-warning-600);
}

.severity-badge.medium {
    background: var(--color-info);
    color: white;
    border-color: var(--color-info-600);
}

.severity-badge.low {
    background: var(--color-success);
    color: white;
    border-color: var(--color-success-600);
}

.severity-badge.unknown {
    background: var(--surface-2);
    color: var(--content-medium);
    border-color: var(--border-medium);
}
</style>
{% endblock %}

{% block content %}
<script>
// Animações de scroll e interações dinâmicas
document.addEventListener('DOMContentLoaded', function() {
    // Intersection Observer para animações de scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            }
        });
    }, observerOptions);
    
    // Adicionar classe fade-in-on-scroll aos cards
    const cards = document.querySelectorAll('.card, .analytics-card');
    cards.forEach((card, index) => {
        card.classList.add('fade-in-on-scroll');
        card.style.animationDelay = `${index * 0.1}s`;
        observer.observe(card);
    });
    
    // Efeito de typing para o título
    const title = document.querySelector('.vulnerability-title');
    if (title) {
        const text = title.textContent;
        title.textContent = '';
        title.style.borderRight = '2px solid var(--color-primary)';
        
        let i = 0;
        const typeWriter = () => {
            if (i < text.length) {
                title.textContent += text.charAt(i);
                i++;
                setTimeout(typeWriter, 50);
            } else {
                setTimeout(() => {
                    title.style.borderRight = 'none';
                }, 1000);
            }
        };
        
        setTimeout(typeWriter, 500);
    }
    
    // Animação de contadores para métricas
    const counters = document.querySelectorAll('.display-4');
    counters.forEach(counter => {
        const target = parseInt(counter.textContent);
        if (!isNaN(target)) {
            let current = 0;
            const increment = target / 50;
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    counter.textContent = target;
                    clearInterval(timer);
                } else {
                    counter.textContent = Math.floor(current);
                }
            }, 30);
        }
    });
    
    // Efeito de hover melhorado para botões
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px) scale(1.02)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
        
        btn.addEventListener('mousedown', function() {
            this.style.transform = 'translateY(0) scale(0.98)';
        });
        
        btn.addEventListener('mouseup', function() {
            this.style.transform = 'translateY(-2px) scale(1.02)';
        });
    });
    
    // Tooltip dinâmico melhorado
    const tooltipTriggers = document.querySelectorAll('.tooltip-trigger');
    tooltipTriggers.forEach(trigger => {
        trigger.addEventListener('mouseenter', function(e) {
            const tooltip = document.createElement('div');
            tooltip.className = 'dynamic-tooltip';
            tooltip.textContent = this.getAttribute('data-tooltip');
            tooltip.style.cssText = `
                position: absolute;
                background: var(--surface-3);
                color: var(--content-strongest);
                padding: var(--space-sm);
                border-radius: var(--radius-sm);
                font-size: var(--font-size-sm);
                z-index: 1000;
                box-shadow: var(--shadow-lg);
                max-width: 200px;
                opacity: 0;
                transform: translateY(10px);
                transition: all 0.3s ease;
                pointer-events: none;
            `;
            
            document.body.appendChild(tooltip);
            
            const rect = this.getBoundingClientRect();
            tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
            tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';
            
            setTimeout(() => {
                tooltip.style.opacity = '1';
                tooltip.style.transform = 'translateY(0)';
            }, 10);
            
            this._tooltip = tooltip;
        });
        
        trigger.addEventListener('mouseleave', function() {
            if (this._tooltip) {
                this._tooltip.style.opacity = '0';
                this._tooltip.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    if (this._tooltip && this._tooltip.parentNode) {
                        this._tooltip.parentNode.removeChild(this._tooltip);
                    }
                }, 300);
            }
        });
    });
    
    // Smooth scroll para links internos
    const internalLinks = document.querySelectorAll('a[href^="#"]');
    internalLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
    
    // Efeito de parallax sutil no header
    const header = document.querySelector('.vulnerability-header');
    if (header) {
        window.addEventListener('scroll', () => {
            const scrolled = window.pageYOffset;
            const rate = scrolled * -0.5;
            header.style.transform = `translateY(${rate}px)`;
        });
    }
    
    // Loading state para botões de ação
    const actionButtons = document.querySelectorAll('.btn[data-action]');
    actionButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            if (!this.classList.contains('loading')) {
                this.classList.add('loading');
                const originalText = this.textContent;
                this.textContent = 'Processando...';
                
                // Simular carregamento (remover em produção)
                setTimeout(() => {
                    this.classList.remove('loading');
                    this.textContent = originalText;
                }, 2000);
            }
        });
    });
});
</script>
<div class="vulnerability-details-page">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}">Vulnerabilidades</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ vulnerability.cve_id }}</li>
        </ol>
    </nav>

    <!-- Header da Vulnerabilidade -->
    <div class="vulnerability-header">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="flex-grow-1">
                <h1 class="vulnerability-title">{{ vulnerability.cve_id }}</h1>
                <div class="vulnerability-meta">
                    <div class="meta-item">
                        <i class="bi bi-calendar"></i>
                        <span>Publicado: {{ vulnerability.published_date.strftime('%d/%m/%Y') if vulnerability.published_date else 'N/A' }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-clock"></i>
                        <span>Modificado: {{ vulnerability.last_modified_date.strftime('%d/%m/%Y') if vulnerability.last_modified_date else 'N/A' }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="severity-badge {{ vulnerability.base_severity | lower if vulnerability.base_severity else 'unknown' }}">
                            <i class="bi bi-{{ 'exclamation-triangle-fill' if vulnerability.base_severity == 'CRITICAL' else 'exclamation-circle-fill' if vulnerability.base_severity == 'HIGH' else 'info-circle-fill' }}"></i>
                            {{ vulnerability.base_severity or 'N/A' }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="export-actions">
                <a href="{{ url_for('vulnerability_ui.generate_risk_report', cve_id=vulnerability.cve_id) }}" class="btn btn-outline-primary">
                    <i class="bi bi-file-earmark-text"></i>
                    Relatório de Risco
                </a>
                <button type="button" class="btn btn-outline-primary" onclick="exportToPDF()">
                    <i class="bi bi-file-pdf"></i>
                    Exportar PDF
                </button>
            </div>
        </div>
        
        {% if vulnerability.description %}
        <div class="vulnerability-description">
            <h3 class="h5 mb-3">Descrição</h3>
            <p class="mb-0">{{ vulnerability.description }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Grid de Analytics -->
    <div class="row g-4 mb-5">
        <!-- Score de Risco -->
        <div class="col-lg-3 col-md-6">
            <div class="analytics-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-speedometer2 text-primary me-2"></i>
                        Score de Risco
                    </h5>
                    <div class="tooltip-trigger" data-tooltip="Score baseado na severidade CVSS e número de ativos afetados">
                        <i class="bi bi-info-circle text-muted"></i>
                    </div>
                </div>
                <div class="text-center">
                    <div class="risk-score {{ 'critical' if analytics.calculated_risk_score >= 9.0 else 'high' if analytics.calculated_risk_score >= 7.0 else 'medium' if analytics.calculated_risk_score >= 4.0 else 'low' }}">
                        {{ analytics.calculated_risk_score }}/10.0
                    </div>
                    <p class="text-muted small mt-2 mb-0">
                        Baseado no CVSS Score ({{ analytics.cvss_score or 'N/A' }}) e {{ analytics.affected_assets_count }} ativo(s) afetado(s)
                    </p>
                </div>
            </div>
        </div>

        <!-- CVSS Score -->
        <div class="col-lg-3 col-md-6">
            <div class="analytics-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-check text-success me-2"></i>
                        CVSS Score
                    </h5>
                    <div class="tooltip-trigger" data-tooltip="Common Vulnerability Scoring System">
                        <i class="bi bi-info-circle text-muted"></i>
                    </div>
                </div>
                {% if vulnerability.cvss_score %}
                    <div class="chart-container d-flex justify-content-center">
                        <canvas id="cvssChart" width="120" height="120"></canvas>
                    </div>
                    <div class="text-center mt-2">
                        <strong class="h5">{{ "%.1f" | format(vulnerability.cvss_score) }}/10.0</strong>
                        {% if vulnerability.metrics and vulnerability.metrics|length > 0 %}
                            {% set primary_metric = vulnerability.metrics|selectattr('is_primary', 'equalto', true)|first %}
                            {% if primary_metric %}
                                <div class="small text-muted mt-1">
                                    CVSS v{{ primary_metric.cvss_version }}
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                {% else %}
                    <div class="text-center">
                        <div class="text-muted mb-0">Score CVSS não disponível</div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Ativos Afetados -->
        <div class="col-lg-3 col-md-6">
            <div class="analytics-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-hdd-stack text-warning me-2"></i>
                        Ativos Afetados
                    </h5>
                    <div class="tooltip-trigger" data-tooltip="Número de sistemas identificados com esta vulnerabilidade">
                        <i class="bi bi-info-circle text-muted"></i>
                    </div>
                </div>
                <div class="text-center">
                    <div class="display-4 fw-bold text-primary mb-2">{{ analytics.affected_assets_count }}</div>
                    <p class="text-muted small mb-3">Ativos impactados por esta vulnerabilidade</p>
                    {% if analytics.affected_assets_count > 0 %}
                        <a href="{{ url_for('asset.list_assets') }}?vulnerability={{ vulnerability.cve_id }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-list"></i>
                            Ver ativos afetados
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Vulnerabilidades Similares -->
        <div class="col-lg-3 col-md-6">
            <div class="analytics-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-collection text-info me-2"></i>
                        Similares
                    </h5>
                    <div class="tooltip-trigger" data-tooltip="Vulnerabilidades com características similares">
                        <i class="bi bi-info-circle text-muted"></i>
                    </div>
                </div>
                <div class="text-center">
                    <div class="display-4 fw-bold text-info mb-2">{{ analytics.similar_vulnerabilities_count }}</div>
                    <p class="text-muted small mb-0">Com severidade {{ vulnerability.base_severity }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Seções Detalhadas -->
    <div class="row">
        <!-- Status da Vulnerabilidade -->
        <div class="col-lg-12">
            <div class="card mb-5 border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h4 class="mb-0">
                        <i class="bi bi-activity text-primary me-2"></i>
                        Status da Vulnerabilidade
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-lg-4 col-md-6">
                            <div class="status-item h-100">
                                <div class="status-indicator d-flex align-items-center p-3 rounded bg-light border">
                                    <div class="status-icon me-3">
                                        <i class="bi bi-exclamation-triangle-fill fs-3 text-danger"></i>
                                    </div>
                                    <div class="status-content">
                                        <h5 class="mb-1">Status Atual</h5>
                                        <span class="badge bg-danger">Ativo</span>
                                        <p class="text-muted mb-0 small mt-1">Esta vulnerabilidade está ativa e requer atenção</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="status-item h-100">
                                <div class="status-indicator d-flex align-items-center p-3 rounded bg-light border">
                                    <div class="status-icon me-3">
                                        <i class="bi bi-clock fs-3 text-warning"></i>
                                    </div>
                                    <div class="status-content">
                                        <h5 class="mb-1">Tempo de Exposição</h5>
                                        {% if vulnerability.published_date %}
                                            {% set days_diff = (moment() - vulnerability.published_date).days %}
                                            <span class="text-muted">{{ days_diff }} dias</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                        <p class="text-muted mb-0 small mt-1">Desde a publicação</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="status-item h-100">
                                <div class="status-indicator d-flex align-items-center p-3 rounded bg-light border">
                                    <div class="status-icon me-3">
                                        <i class="bi bi-shield-check fs-3 text-info"></i>
                                    </div>
                                    <div class="status-content">
                                        <h5 class="mb-1">Mitigação</h5>
                                        <span class="badge bg-warning">Pendente</span>
                                        <p class="text-muted mb-0 small mt-1">Aguardando implementação de correções</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Informações Técnicas -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h4 class="mb-0">
                        <i class="bi bi-gear text-primary me-2"></i>
                        Informações Técnicas Detalhadas
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Métricas CVSS -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="bi bi-graph-up me-2"></i>
                            Métricas CVSS
                        </h5>
                        <!-- Métricas CVSS Detalhadas -->
                        {% if vulnerability.metrics and vulnerability.metrics|length > 0 %}
                            {% for metric in vulnerability.metrics %}
                                <div class="cvss-metric-section mb-4 p-4 border rounded bg-light">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0 text-primary">
                                            <i class="bi bi-shield-check me-2"></i>
                                            CVSS v{{ metric.cvss_version }}
                                            {% if metric.is_primary %}
                                                <span class="badge bg-primary ms-2">Principal</span>
                                            {% endif %}
                                        </h6>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-primary fs-6">{{ "%.1f" | format(metric.base_score) }}/10.0</span>
                                            <span class="severity-badge {{ metric.base_severity | lower }}">{{ metric.base_severity }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-3">
                                        <!-- Score Base -->
                                        <div class="col-lg-4 col-md-6">
                                            <div class="info-item p-3 bg-white rounded border">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="info-label fw-medium tooltip-trigger" data-tooltip="Pontuação base do CVSS">Score Base:</span>
                                                    <span class="badge bg-primary">{{ "%.1f" | format(metric.base_score) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Scores Adicionais -->
                                        {% if metric.exploitability_score %}
                                        <div class="col-lg-4 col-md-6">
                                            <div class="info-item p-3 bg-white rounded border">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="info-label fw-medium tooltip-trigger" data-tooltip="Score de exploitabilidade">Exploitabilidade:</span>
                                                    <span class="badge bg-info">{{ "%.1f" | format(metric.exploitability_score) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if metric.impact_score %}
                                        <div class="col-lg-4 col-md-6">
                                            <div class="info-item p-3 bg-white rounded border">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="info-label fw-medium tooltip-trigger" data-tooltip="Score de impacto">Impacto:</span>
                                                    <span class="badge bg-warning">{{ "%.1f" | format(metric.impact_score) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Componentes CVSS v3.x -->
                                        {% if metric.cvss_version in ['3.0', '3.1'] %}
                                            {% if metric.attack_vector %}
                                            <div class="col-lg-4 col-md-6">
                                                <div class="info-item p-3 bg-white rounded border">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="info-label fw-medium tooltip-trigger" data-tooltip="Vetor de ataque">Vetor de Ataque:</span>
                                                        <span class="badge bg-secondary">{{ metric.attack_vector }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if metric.attack_complexity %}
                                            <div class="col-lg-4 col-md-6">
                                                <div class="info-item p-3 bg-white rounded border">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="info-label fw-medium tooltip-trigger" data-tooltip="Complexidade do ataque">Complexidade:</span>
                                                        <span class="badge bg-secondary">{{ metric.attack_complexity }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if metric.privileges_required %}
                                            <div class="col-lg-4 col-md-6">
                                                <div class="info-item p-3 bg-white rounded border">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="info-label fw-medium tooltip-trigger" data-tooltip="Privilégios necessários">Privilégios:</span>
                                                        <span class="badge bg-secondary">{{ metric.privileges_required }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if metric.user_interaction %}
                                            <div class="col-lg-4 col-md-6">
                                                <div class="info-item p-3 bg-white rounded border">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="info-label fw-medium tooltip-trigger" data-tooltip="Interação do usuário necessária">Interação:</span>
                                                        <span class="badge bg-secondary">{{ metric.user_interaction }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if metric.scope %}
                                            <div class="col-lg-4 col-md-6">
                                                <div class="info-item p-3 bg-white rounded border">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="info-label fw-medium tooltip-trigger" data-tooltip="Escopo da vulnerabilidade">Escopo:</span>
                                                        <span class="badge bg-secondary">{{ metric.scope }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                        
                                        <!-- Componentes CVSS v2.x -->
                                        {% if metric.cvss_version == '2.0' %}
                                            {% if metric.access_vector %}
                                            <div class="col-lg-4 col-md-6">
                                                <div class="info-item p-3 bg-white rounded border">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="info-label fw-medium tooltip-trigger" data-tooltip="Vetor de acesso CVSS v2">Vetor de Acesso:</span>
                                                        <span class="badge bg-secondary">{{ metric.access_vector }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if metric.access_complexity %}
                                            <div class="col-lg-4 col-md-6">
                                                <div class="info-item p-3 bg-white rounded border">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="info-label fw-medium tooltip-trigger" data-tooltip="Complexidade de acesso CVSS v2">Complexidade de Acesso:</span>
                                                        <span class="badge bg-secondary">{{ metric.access_complexity }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if metric.authentication %}
                                            <div class="col-lg-4 col-md-6">
                                                <div class="info-item p-3 bg-white rounded border">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="info-label fw-medium tooltip-trigger" data-tooltip="Autenticação necessária CVSS v2">Autenticação:</span>
                                                        <span class="badge bg-secondary">{{ metric.authentication }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                        
                                        <!-- Impactos -->
                                        {% if metric.confidentiality_impact %}
                                        <div class="col-lg-4 col-md-6">
                                            <div class="info-item p-3 bg-white rounded border">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="info-label fw-medium tooltip-trigger" data-tooltip="Impacto na confidencialidade">Confidencialidade:</span>
                                                    <span class="badge bg-danger">{{ metric.confidentiality_impact }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if metric.integrity_impact %}
                                        <div class="col-lg-4 col-md-6">
                                            <div class="info-item p-3 bg-white rounded border">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="info-label fw-medium tooltip-trigger" data-tooltip="Impacto na integridade">Integridade:</span>
                                                    <span class="badge bg-warning">{{ metric.integrity_impact }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if metric.availability_impact %}
                                        <div class="col-lg-4 col-md-6">
                                            <div class="info-item p-3 bg-white rounded border">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="info-label fw-medium tooltip-trigger" data-tooltip="Impacto na disponibilidade">Disponibilidade:</span>
                                                    <span class="badge bg-info">{{ metric.availability_impact }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Vector String -->
                                        {% if metric.base_vector %}
                                        <div class="col-12">
                                            <div class="info-item p-3 bg-white rounded border">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="info-label fw-medium tooltip-trigger" data-tooltip="String do vetor CVSS">Vector String:</span>
                                                    <code class="small bg-light p-1 rounded">{{ metric.base_vector }}</code>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <!-- Fallback para vulnerabilidades sem métricas detalhadas -->
                            <div class="row g-3">
                                <div class="col-lg-6">
                                    <div class="info-item p-3 bg-light rounded border">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="info-label fw-medium tooltip-trigger" data-tooltip="Pontuação base do CVSS que representa a severidade intrínseca da vulnerabilidade">Score Base:</span>
                                            <span class="badge bg-primary fs-6">{{ "%.1f" | format(vulnerability.cvss_score) if vulnerability.cvss_score else 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="info-item p-3 bg-light rounded border">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="info-label fw-medium">Severidade:</span>
                                            <span class="severity-badge {{ vulnerability.base_severity | lower if vulnerability.base_severity else 'unknown' }}">{{ vulnerability.base_severity or 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Análise de Impacto -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">
                            <i class="bi bi-shield-exclamation me-2"></i>
                            Análise de Impacto
                        </h5>
                        <div class="row g-3">
                            <div class="col-lg-4">
                                <div class="info-item p-3 bg-light rounded border">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="info-label fw-medium">Confidencialidade:</span>
                                        <span class="impact-badge {{ vulnerability.confidentiality_impact | lower if vulnerability.confidentiality_impact else 'none' }}">{{ vulnerability.confidentiality_impact or 'N/A' }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="info-item p-3 bg-light rounded border">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="info-label fw-medium">Integridade:</span>
                                        <span class="impact-badge {{ vulnerability.integrity_impact | lower if vulnerability.integrity_impact else 'none' }}">{{ vulnerability.integrity_impact or 'N/A' }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="info-item p-3 bg-light rounded border">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="info-label fw-medium">Disponibilidade:</span>
                                        <span class="impact-badge {{ vulnerability.availability_impact | lower if vulnerability.availability_impact else 'none' }}">{{ vulnerability.availability_impact or 'N/A' }}</span>
                                    </div>
                                </div>
                            </div>
                            {% if vulnerability.scope %}
                            <div class="col-lg-4">
                                <div class="info-item p-3 bg-light rounded border">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="info-label fw-medium">Escopo:</span>
                                        <span class="badge bg-info">{{ vulnerability.scope }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if vulnerability.exploitability_score %}
                            <div class="col-lg-4">
                                <div class="info-item p-3 bg-light rounded border">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="info-label fw-medium tooltip-trigger" data-tooltip="Facilidade técnica de exploração da vulnerabilidade">Exploitabilidade:</span>
                                        <span class="badge bg-warning">{{ "%.1f" | format(vulnerability.exploitability_score) }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if vulnerability.impact_score %}
                            <div class="col-lg-4">
                                <div class="info-item p-3 bg-light rounded border">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="info-label fw-medium">Score de Impacto:</span>
                                        <span class="badge bg-danger">{{ "%.1f" | format(vulnerability.impact_score) }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if vulnerability.references %}
                    <div class="mt-4">
                        <h5 class="text-primary mb-3">
                            <i class="bi bi-link-45deg me-2"></i>
                            Referências
                        </h5>
                        <div class="list-group list-group-flush">
                            {% for ref in vulnerability.references[:5] %}
                            <div class="list-group-item border-0 px-0">
                                <a href="{{ ref.url }}" target="_blank" class="text-decoration-none">
                                    <i class="bi bi-link-45deg text-primary me-2"></i>
                                    {{ ref.url }}
                                    <i class="bi bi-box-arrow-up-right ms-1 text-muted"></i>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar com Informações Adicionais -->
        <div class="col-lg-4">
            <!-- Vulnerabilidades Relacionadas -->
            {% if related_vulnerabilities %}
            <div class="analytics-card">
                <h3>
                    <i class="bi bi-link-45deg"></i>
                    Vulnerabilidades Relacionadas
                </h3>
                <div class="related-vulnerabilities">
                    {% for related in related_vulnerabilities %}
                    <div class="related-vuln-item">
                        <div>
                            <a href="{{ url_for('main.vulnerability_details', cve_id=related.cve_id) }}" class="fw-bold text-decoration-none">
                                {{ related.cve_id }}
                            </a>
                            <div class="small text-muted">
                                Score: {{ "%.1f" | format(related.cvss_score) if related.cvss_score else 'N/A' }}
                            </div>
                        </div>
                        <span class="severity-badge {{ related.base_severity | lower }} small">
                            {{ related.base_severity }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Timeline -->
            <div class="analytics-card">
                <h3>
                    <i class="bi bi-clock-history"></i>
                    Timeline
                </h3>
                <div class="timeline">
                    {% if vulnerability.published_date %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6>Publicação</h6>
                            <p class="small text-muted mb-0">{{ vulnerability.published_date.strftime('%d/%m/%Y às %H:%M') }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if vulnerability.last_modified_date and vulnerability.last_modified_date != vulnerability.published_date %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <h6>Última Modificação</h6>
                            <p class="small text-muted mb-0">{{ vulnerability.last_modified_date.strftime('%d/%m/%Y às %H:%M') }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Ações Principais -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h4 class="mb-0">
                        <i class="bi bi-tools text-primary me-2"></i>
                        Ações de Gerenciamento
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <button type="button" class="btn btn-danger w-100 py-3" onclick="openTicket('{{ vulnerability.cve_id }}')">
                                <i class="bi bi-exclamation-triangle-fill fs-5 d-block mb-2"></i>
                                <span class="fw-medium">Ticket de Emergência</span>
                                <small class="d-block text-white-50 mt-1">Abrir ticket urgente</small>
                            </button>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <button type="button" class="btn btn-warning w-100 py-3" onclick="startMitigation('{{ vulnerability.cve_id }}')">
                                <i class="bi bi-shield-check fs-5 d-block mb-2"></i>
                                <span class="fw-medium">Iniciar Mitigação</span>
                                <small class="d-block text-dark-50 mt-1">Começar processo de correção</small>
                            </button>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <button type="button" class="btn btn-info w-100 py-3" onclick="exportToPDF()">
                                <i class="bi bi-file-pdf fs-5 d-block mb-2"></i>
                                <span class="fw-medium">Exportar PDF</span>
                                <small class="d-block text-white-50 mt-1">Gerar relatório completo</small>
                            </button>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <a href="{{ url_for('vulnerability_ui.generate_risk_report', cve_id=vulnerability.cve_id) }}" class="btn btn-outline-primary w-100 py-3">
                            <i class="bi bi-file-earmark-text fs-5 d-block mb-2"></i>
                            <span class="fw-medium">Gerar Relatório de Risco</span>
                            <small class="d-block text-muted mt-1">Análise detalhada com IA</small>
                        </a>
                        </div>
                    </div>
                    
                    <!-- Ações de Navegação -->
                    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                        <a href="{{ url_for('vulnerability_ui.list_vulnerabilities_ui') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i>
                            Voltar à Lista
                        </a>
                        
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('vulnerability_ui.edit_vulnerability_ui', cve_id=vulnerability.cve_id) }}" class="btn btn-primary">
                                <i class="bi bi-pencil"></i>
                                Editar Vulnerabilidade
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// CVSS Chart
{% if vulnerability.cvss_score %}
const cvssCtx = document.getElementById('cvssChart').getContext('2d');
const cvssScore = {{ vulnerability.cvss_score }};
const maxScore = 10;

new Chart(cvssCtx, {
    type: 'doughnut',
    data: {
        datasets: [{
            data: [cvssScore, maxScore - cvssScore],
            backgroundColor: [
                cvssScore >= 9.0 ? '#dc3545' : cvssScore >= 7.0 ? '#fd7e14' : cvssScore >= 4.0 ? '#0dcaf0' : '#198754',
                '#e9ecef'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}

// Export to PDF function
function exportToPDF() {
    window.print();
}

// Open Ticket function
function openTicket(cveId) {
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Criando Ticket...';
    btn.disabled = true;
    
    // API call to create ticket
    fetch('/api/v1/tickets', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
        },
        body: JSON.stringify({
            title: `Vulnerabilidade ${cveId} - Resposta de Emergência`,
            description: `Ticket criado automaticamente para resposta à vulnerabilidade ${cveId}`,
            cve_id: cveId,
            priority: 'high',
            type: 'vulnerability_response'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showToast('Ticket criado com sucesso! ID: ' + data.ticket.id, 'success');
            // Update UI to show ticket was created
            updateTicketStatus('created', data.ticket.id);
        } else {
            showToast('Erro ao criar ticket: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating ticket:', error);
        showToast('Erro ao criar ticket. Tente novamente.', 'error');
    })
    .finally(() => {
        // Restore button state
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Start Mitigation function
function startMitigation(cveId) {
    // Show confirmation dialog
    if (!confirm('Deseja iniciar o processo de mitigação para esta vulnerabilidade?')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Iniciando...';
    btn.disabled = true;
    
    // API call to start mitigation
    fetch('/api/v1/vulnerabilities/' + cveId + '/mitigate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
        },
        body: JSON.stringify({
            action: 'start_mitigation',
            timestamp: new Date().toISOString(),
            user_id: getCurrentUserId()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Processo de mitigação iniciado com sucesso!', 'success');
            // Update UI to show mitigation status
            updateMitigationStatus('in_progress');
        } else {
            showToast('Erro ao iniciar mitigação: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error starting mitigation:', error);
        showToast('Erro ao iniciar mitigação. Tente novamente.', 'error');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Update mitigation status in UI
function updateMitigationStatus(status) {
    const statusElement = document.querySelector('.status-indicator:nth-child(3) .status-content span');
    if (statusElement) {
        statusElement.className = 'badge';
        switch(status) {
            case 'in_progress':
                statusElement.classList.add('bg-warning');
                statusElement.textContent = 'Em Progresso';
                break;
            case 'completed':
                statusElement.classList.add('bg-success');
                statusElement.textContent = 'Concluída';
                break;
            case 'failed':
                statusElement.classList.add('bg-danger');
                statusElement.textContent = 'Falhou';
                break;
            default:
                statusElement.classList.add('bg-secondary');
                statusElement.textContent = 'Pendente';
        }
    }
    console.log('Mitigation status updated to:', status);
}

// Update ticket status in UI
function updateTicketStatus(status, ticketId) {
    // Add visual indicator that ticket was created
    const ticketBtn = document.querySelector('button[onclick*="openTicket"]');
    if (ticketBtn && status === 'created') {
        ticketBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Ticket Criado';
        ticketBtn.classList.remove('btn-danger');
        ticketBtn.classList.add('btn-success');
        ticketBtn.disabled = true;
        
        // Add ticket ID info
        const ticketInfo = document.createElement('small');
        ticketInfo.className = 'text-muted d-block mt-1';
        ticketInfo.textContent = `ID: ${ticketId}`;
        ticketBtn.parentNode.appendChild(ticketInfo);
    }
}

// Get current user ID (you may need to implement this based on your auth system)
function getCurrentUserId() {
    // This should return the current user's ID
    // You can get this from a meta tag, global variable, or API call
    const userMeta = document.querySelector('meta[name=current-user-id]');
    return userMeta ? userMeta.getAttribute('content') : null;
}
</script>
{% endblock %}

{# Incluir schema markup específico para vulnerabilidades #}
{% include 'seo/vulnerability_schema.html' %}