from marshmallow import Schema, fields, validate


class VulnerabilitySchema(Schema):
    """
    Schema para serialização e validação de dados de Vulnerability (CVE).
    """
    id = fields.Int(dump_only=True)
    cve_id = fields.Str(
        required=True,
        validate=validate.Regexp(r"^CVE-\d{4}-\d+$", error="Formato de CVE inválido. Ex: CVE-2025-1234")
    )
    description = fields.Str(required=True)
    published_date = fields.DateTime(required=True)
    last_modified = fields.DateTime(required=True)
    base_severity = fields.Str(required=True)
    cvss_score = fields.Float(required=True, validate=validate.Range(min=0.0, max=10.0))
    patch_available = fields.Bool(required=True)
    assigner = fields.Str(allow_none=True)

    # Relacionamentos (dump only)
    metrics = fields.List(fields.Dict(), dump_only=True)
    vendors = fields.List(fields.Dict(), dump_only=True)
    products = fields.List(fields.Dict(), dump_only=True)
    version_references = fields.List(fields.Dict(), dump_only=True)
    weaknesses = fields.List(fields.Dict(), dump_only=True)
    references = fields.List(fields.Dict(), dump_only=True)
